# Mise Task Runner Configuration for Babylon
# https://mise.jdx.dev/
#
# Task Namespace Convention (ADR035):
#   check         - Fast CI gate (lint + format + typecheck + unit tests)
#   test:*        - Test runners by scope
#   sim:*         - Simulation execution and analysis
#   tune:*        - Parameter optimization
#   qa:*          - Quality assurance and verification
#   demo:*        - Integration demos and persona testing
#   data:*        - Data pipeline operations
#   docs:*        - Documentation building
#   mutate:*      - Mutation testing
#   midi:*        - Music generation

[tools]
python = "3.12"

[env]
PYTHONPATH = "src"
BABYLON_ENV = "development"
# Soundfont for MIDI conversion
SOUNDFONT = "/usr/share/sounds/sf2/FluidR3_GM.sf2"
MUSIC_DIR = "assets/music"
AUDIO_OUTPUT_DIR = "assets/audio"

# =============================================================================
# INSTALLATION
# =============================================================================

[tasks.install]
description = "Install all dependencies"
run = "poetry install --with dev"

# =============================================================================
# CODE QUALITY
# =============================================================================

[tasks.lint]
description = "Run ruff linter with auto-fix"
run = "poetry run ruff check src tests --fix"

[tasks.format]
description = "Run ruff formatter"
run = "poetry run ruff format src tests"

[tasks.typecheck]
description = "Run mypy type checker"
run = "poetry run mypy src"

[tasks."lint:yaml"]
description = "Lint YAML files"
run = "poetry run yamllint -c .yamllint.yaml ."

[tasks."lint:md"]
description = "Lint Markdown files"
run = "npx markdownlint --config .markdownlint.yaml '**/*.md' --ignore 'CHANGELOG.md' --ignore 'brainstorm/**' --ignore '.venv/**'"

[tasks."lint:complexity"]
description = "Show code complexity report (radon)"
run = "poetry run radon cc src/ -a -s --show-complexity"

[tasks."lint:complexity-check"]
description = "Run complexity gate (xenon) - fails if CC > 15"
run = "poetry run xenon --max-absolute C src/"

[tasks.check]
description = "Fast CI gate: lint + format + typecheck + unit tests"
depends = ["lint", "format", "typecheck", "test:unit"]

# =============================================================================
# TESTING (Namespaced)
# =============================================================================

[tasks."test:unit"]
description = "Run unit tests only (fast)"
run = "poetry run pytest tests/unit -v --tb=short"

[tasks."test:int"]
description = "Run integration tests (mechanics & systems)"
run = "poetry run pytest tests/integration -v --tb=short"

[tasks."test:scenario"]
description = "Run scenario tests (slow, full arcs)"
run = "poetry run pytest tests/scenarios -v --tb=short"

[tasks."test:all"]
description = "Run all non-AI tests"
run = "poetry run pytest -m 'not ai' --tb=short"

[tasks."test:ai"]
description = "Run AI/narrative evaluation tests (slow)"
run = "poetry run pytest -m 'ai' --tb=short"

[tasks."test:cov"]
description = "Run tests with coverage report"
run = "poetry run pytest -m 'not ai' --cov=src/babylon --cov-report=term-missing"

[tasks."test:doctest"]
description = "Run doctest examples in formulas module"
run = "poetry run pytest --doctest-modules src/babylon/systems/formulas.py -v"

# =============================================================================
# SIMULATION (Namespaced)
# =============================================================================

[tasks."sim:run"]
description = "Run main simulation entry point"
run = "poetry run python -m babylon"

[tasks."sim:trace"]
description = "Run simulation trace with CSV + JSON output"
usage = 'arg "[ticks]" help="Number of ticks to simulate" default="200"'
run = """
mkdir -p results
poetry run python tools/parameter_analysis.py trace \
  --csv results/trace.csv \
  --json results/trace.json \
  --ticks ${usage_ticks}
"""

[tasks."sim:sweep"]
description = "Run parameter sweep analysis"
run = """
mkdir -p results
poetry run python tools/parameter_analysis.py sweep \
  --param economy.extraction_efficiency \
  --start 0.05 --end 0.50 --step 0.05 \
  --csv results/sweep.csv
"""

[tasks."sim:profile"]
description = "Profile simulation with cProfile"
usage = 'arg "[ticks]" help="Number of ticks to profile" default="100"'
run = "poetry run python tools/profiler.py --ticks ${usage_ticks}"

[tasks."sim:monte-carlo"]
description = "Monte Carlo uncertainty quantification"
usage = '''
arg "[samples]" help="Number of samples" default="100"
arg "[seed]" help="Random seed (optional)"
'''
run = """
mkdir -p results
poetry run python tools/monte_carlo.py \
  --samples ${usage_samples} \
  ${usage_seed:+--seed ${usage_seed}} \
  --csv results/monte_carlo.csv
"""

# =============================================================================
# TUNING (Namespaced)
# =============================================================================

[tasks."tune:optuna"]
description = "Run Carceral Equilibrium optimization (Optuna TPE, 100 years)"
usage = '''
arg "[trials]" help="Number of optimization trials" default="100"
arg "[name]" help="Study name (for resumption)" default="babylon_carceral"
'''
run = """
poetry run python tools/tune_agent.py \
  --trials ${usage_trials} \
  --study-name ${usage_name} \
  --storage sqlite:///optuna.db
"""

[tasks."tune:landscape"]
description = "2D parameter grid search (100-year simulations)"
usage = '''
arg "[param1]" help="First parameter path" default="economy.extraction_efficiency"
arg "[range1]" help="Range as start:end:step" default="0.1:0.9:0.1"
arg "[param2]" help="Second parameter path" default="economy.comprador_cut"
arg "[range2]" help="Range as start:end:step" default="0.5:1.0:0.1"
arg "[ticks]" help="Max ticks per simulation" default="5200"
'''
run = """
mkdir -p results
poetry run python tools/landscape_analysis.py \
  --param1 ${usage_param1} \
  --range1 ${usage_range1} \
  --param2 ${usage_param2} \
  --range2 ${usage_range2} \
  --max-ticks ${usage_ticks} \
  --output results/landscape.csv
"""

[tasks."tune:params"]
description = "1D parameter sensitivity sweep"
run = "poetry run python tools/tune_parameters.py"

[tasks."tune:params-custom"]
description = "Run parameter sweep with custom range"
run = "poetry run python tools/tune_parameters.py --start ${1:-0.05} --end ${2:-0.50} --step ${3:-0.05}"

[tasks."tune:dashboard"]
description = "Launch Optuna Dashboard for visualization"
run = "optuna-dashboard sqlite:///optuna.db"

[tasks."tune:sensitivity"]
description = "Global sensitivity analysis (Morris + Sobol)"
run = """
mkdir -p results
echo "Running Morris screening..."
poetry run python tools/sensitivity_analysis.py morris --trajectories 10
echo ""
echo "Running Sobol analysis..."
poetry run python tools/sensitivity_analysis.py sobol --samples 256
"""

[tasks."tune:morris"]
description = "Morris elementary effects screening (fast)"
usage = 'arg "[trajectories]" help="Number of trajectories" default="10"'
run = """
mkdir -p results
poetry run python tools/sensitivity_analysis.py morris \
  --trajectories ${usage_trajectories} \
  --output results/morris.json
"""

[tasks."tune:sobol"]
description = "Sobol variance decomposition (slow)"
usage = 'arg "[samples]" help="Base sample size" default="256"'
run = """
mkdir -p results
poetry run python tools/sensitivity_analysis.py sobol \
  --samples ${usage_samples} \
  --output results/sobol.json
"""

# =============================================================================
# QA (Namespaced)
# =============================================================================

[tasks."qa:audit"]
description = "Simulation health check (100-year trajectory)"
usage = 'arg "[ticks]" help="Max simulation ticks" default="5200"'
run = """
mkdir -p reports
poetry run python tools/audit_simulation.py \
  --max-ticks ${usage_ticks} \
  --output reports/audit_latest.md
cat reports/audit_latest.md
"""

[tasks."qa:verify"]
description = "Verify formula correctness"
run = "poetry run python tools/verify_math_divergence.py"

[tasks."qa:schemas"]
description = "Validate JSON schemas"
run = "poetry run python tools/validate_schemas.py"

[tasks."qa:security"]
description = "Run security audit on dependencies"
run = "poetry run pip-audit"

[tasks."qa:regression"]
description = "Regression test against stored baselines"
run = "poetry run python tools/regression_test.py compare"

[tasks."qa:regression-generate"]
description = "Generate regression baselines (after intentional changes)"
run = "poetry run python tools/regression_test.py generate --force"

# =============================================================================
# DEMO (Namespaced)
# =============================================================================

[tasks."demo:slice"]
description = "Full pipeline demo (Engine -> RAG -> LLM)"
run = "poetry run python tools/vertical_slice.py"

[tasks."demo:persona"]
description = "Test Persephone persona voice"
run = "poetry run python tools/interview_persona.py"

[tasks."demo:narrative"]
description = "Narrative U-curve sweep"
run = "poetry run python tools/narrative_sweep.py"

[tasks."demo:narrative-mock"]
description = "Narrative U-curve sweep with MockLLM"
run = "poetry run python tools/narrative_sweep.py --mock"

# =============================================================================
# DATA (Namespaced)
# =============================================================================

[tasks."data:ingest"]
description = "Ingest Marxist corpus into ChromaDB"
run = "poetry run python tools/ingest_corpus.py"

[tasks."data:ingest-reset"]
description = "Reset and re-ingest corpus"
run = "poetry run python tools/ingest_corpus.py --reset"

[tasks."data:db-init"]
description = "Initialize SQLite database"
run = "poetry run python tools/init_db.py"

[tasks."data:census-load"]
description = "Load Census ACS data into SQLite research database"
run = "poetry run python tools/load_census.py"

[tasks."data:census-reset"]
description = "Reset and reload Census data (drops existing tables)"
run = "poetry run python tools/load_census.py --reset"

[tasks."data:census-api"]
description = "Load Census ACS data from Census Bureau API (county-level)"
run = "poetry run python tools/load_census.py --from-api"

[tasks."data:census-api-reset"]
description = "Reset and load Census data from API (drops existing census tables)"
run = "poetry run python tools/load_census.py --from-api --reset"

[tasks."data:census-query"]
description = "Open SQLite CLI for research database (census + trade)"
run = "sqlite3 data/sqlite/research.sqlite"

[tasks."data:trade-load"]
description = "Load UN trade data into SQLite research database"
run = "poetry run python tools/load_trade.py"

[tasks."data:trade-reset"]
description = "Reset and reload trade data (preserves census tables)"
run = "poetry run python tools/load_trade.py --reset"

[tasks."data:research-query"]
description = "Open SQLite CLI for research database (census + trade + qcew)"
run = "sqlite3 data/sqlite/research.sqlite"

[tasks."data:qcew-load"]
description = "Load BLS QCEW employment/wage data into SQLite research database"
run = "poetry run python tools/load_qcew.py"

[tasks."data:qcew-reset"]
description = "Reset and reload QCEW data (preserves census/trade tables)"
run = "poetry run python tools/load_qcew.py --reset"

[tasks."data:qcew-raw"]
description = "Load raw QCEW 2022 single-file CSV (3.6M rows) for class composition"
run = "poetry run python tools/ingest_qcew_full.py"

[tasks."data:qcew-raw-reset"]
description = "Reset and reload raw QCEW 2022 data"
run = "poetry run python tools/ingest_qcew_full.py --reset"

[tasks."data:qcew-raw-full"]
description = "Load raw QCEW 2022 CSV + Excel labor hours files"
run = "poetry run python tools/ingest_qcew_full.py --xlsx"

[tasks."data:qcew-class-composition"]
description = "Print class composition from existing QCEW 2022 data"
run = "poetry run python tools/ingest_qcew_full.py --validate-only"

[tasks."data:productivity-load"]
description = "Load BLS productivity data into SQLite research database (2022)"
run = "poetry run python tools/load_productivity.py"

[tasks."data:productivity-reset"]
description = "Reset and reload productivity data (drops existing tables)"
run = "poetry run python tools/load_productivity.py --reset"

[tasks."data:productivity-all"]
description = "Load all years of productivity data (1987-2024)"
run = "poetry run python tools/load_productivity.py --all-years --reset"

[tasks."data:fred-load"]
description = "Load FRED macroeconomic data into SQLite (national + state + industry, 2022)"
run = "poetry run python tools/load_fred.py"

[tasks."data:fred-reset"]
description = "Reset and reload all FRED data"
run = "poetry run python tools/load_fred.py --reset"

[tasks."data:fred-national"]
description = "Load FRED national series only (CPI, wages, unemployment, etc.)"
run = "poetry run python tools/load_fred.py --national-only"

[tasks."data:fred-national-reset"]
description = "Reset and reload FRED national series only"
run = "poetry run python tools/load_fred.py --national-only --reset"

# =============================================================================
# DOCUMENTATION (Namespaced)
# =============================================================================

[tasks."docs:build"]
description = "Build Sphinx documentation"
run = "cd docs && poetry run sphinx-build -b html . _build/html"

[tasks."docs:strict"]
description = "Build docs with warnings as errors (CI mode)"
run = "cd docs && poetry run sphinx-build -W -b html . _build/html"

[tasks."docs:live"]
description = "Live-reload documentation server"
run = "cd docs && poetry run sphinx-autobuild . _build/html --open-browser"

[tasks."docs:clean"]
description = "Clean documentation build artifacts"
run = "rm -rf docs/_build docs/api/_autosummary"

[tasks."docs:rebuild"]
description = "Clean and rebuild documentation"
depends = ["docs:clean", "docs:build"]

[tasks."docs:pdf"]
description = "Build PDF documentation"
run = """
cd docs && \
poetry run sphinx-build -b latex . _build/latex && \
cd _build/latex && \
make all-pdf
"""

# =============================================================================
# MUTATION TESTING (Namespaced)
# =============================================================================

[tasks."mutate:full"]
description = "Run full mutation testing (overnight run)"
run = "poetry run python tools/run_mutmut.py"

[tasks."mutate:critical"]
description = "Run mutation testing on critical formulas only (~30 min)"
run = "poetry run python tools/run_mutmut.py --critical"

[tasks."mutate:formulas"]
description = "Run mutation testing on formulas only (~5-10 min)"
run = """
echo "Running mutation testing on formulas..."
poetry run mutmut run \
  --paths-to-mutate=src/babylon/systems/formulas.py \
  --runner="poetry run pytest tests/unit/formulas -x -q --tb=no"
poetry run mutmut results
"""

[tasks."mutate:systems"]
description = "Run mutation testing on simulation systems (~15-30 min)"
run = """
echo "Running mutation testing on simulation systems..."
poetry run mutmut run \
  --paths-to-mutate=src/babylon/engine/systems/economic.py,src/babylon/engine/systems/survival.py,src/babylon/systems/formulas.py \
  --runner="poetry run pytest tests/unit/engine tests/unit/formulas -x -q --tb=no"
poetry run mutmut results
"""

[tasks."mutate:file"]
description = "Run mutation testing on a specific file"
run = """
if [ -z "$1" ]; then
  echo "Usage: mise run mutate:file <path/to/file.py>"
  exit 1
fi
echo "Running mutation testing on $1..."
poetry run mutmut run --paths-to-mutate="$1"
poetry run mutmut results
"""

[tasks."mutate:results"]
description = "Show mutation testing results summary"
run = "poetry run mutmut results"

[tasks."mutate:show"]
description = "Show specific mutant details (usage: mise run mutate:show 42)"
run = "poetry run mutmut show ${1:-1}"

[tasks."mutate:html"]
description = "Generate HTML report of mutation testing results"
run = "poetry run mutmut html && echo 'Report: html/index.html'"

# =============================================================================
# CI / HOOKS
# =============================================================================

[tasks.ci]
description = "Full CI check (same as check)"
depends = ["check"]

[tasks.hooks]
description = "Install pre-commit hooks"
run = "poetry run pre-commit install --hook-type commit-msg --hook-type pre-commit"

[tasks."hooks:run"]
description = "Run all pre-commit hooks on all files"
run = "poetry run pre-commit run --all-files"

# =============================================================================
# VERSIONING
# =============================================================================

[tasks.bump]
description = "Bump version with commitizen"
run = "poetry run cz bump --changelog"

[tasks."bump:dry"]
description = "Preview version bump without changes"
run = "poetry run cz bump --dry-run"

# =============================================================================
# UTILITIES
# =============================================================================

[tasks.clean]
description = "Clean build artifacts and caches"
run = """
rm -rf .pytest_cache .mypy_cache .ruff_cache
rm -rf dist build *.egg-info
rm -rf .coverage htmlcov
find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
echo "Cleaned!"
"""

# =============================================================================
# MUSIC GENERATION (Namespaced)
# =============================================================================

[tasks."midi:to-wav"]
description = "Convert a MIDI file to WAV using FluidSynth"
run = "tools/scripts/midi-to-wav.sh"

[tasks."midi:to-mp3"]
description = "Convert a MIDI file to MP3 (requires ffmpeg)"
run = "tools/scripts/midi-to-mp3.sh"

[tasks."midi:to-ogg"]
description = "Convert a MIDI file to OGG Vorbis (good for games)"
run = "tools/scripts/midi-to-ogg.sh"

[tasks."midi:convert-all"]
description = "Convert all MIDI files to specified format (wav|mp3|ogg)"
run = "tools/scripts/midi-convert-all.sh"

[tasks."midi:play"]
description = "Play a MIDI file through speakers using FluidSynth"
run = "tools/scripts/midi-play.sh"

[tasks."midi:list"]
description = "List all MIDI files in the music directory"
run = "find $MUSIC_DIR -name '*.mid' -printf '  %P\\n' | sort && echo '' && echo \"Total: $(find $MUSIC_DIR -name '*.mid' | wc -l) files\""

[tasks."midi:generate-fascist"]
description = "Generate all fascist faction MIDI tracks"
run = "cd tools/fascist_soundtrack && for f in generate_*.py; do echo \"Generating: $f\"; poetry run python \"$f\"; done"

[tasks."midi:soundfont-list"]
description = "List available soundfonts on the system"
run = "find /usr/share/sounds -name '*.sf2' -o -name '*.sf3' 2>/dev/null"

[tasks."midi:soundfont-info"]
description = "Show info about the current soundfont"
run = "echo \"Current: $SOUNDFONT\" && ls -lh \"$SOUNDFONT\""

# =============================================================================
# UI / DASHBOARD
# =============================================================================

[tasks.ui]
description = "Launch the Synopticon dashboard (Dear PyGui)"
run = "poetry run python -m babylon.ui.dpg_runner"

# =============================================================================
# VISUALIZATION (Namespaced)
# =============================================================================

[tasks."viz:necropolis"]
description = "Watch the 100-year trajectory into stable necropolis (The Red Pill)"
usage = '''
arg "[years]" help="Simulation length in years" default="100"
arg "[interval]" help="Report interval in years" default="10"
'''
run = """
poetry run python tools/necropolis_viewer.py \
  --years ${usage_years} \
  --interval ${usage_interval}
"""
