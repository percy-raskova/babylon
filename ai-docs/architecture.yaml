# Babylon System Architecture
# How the pieces fit together

meta:
  version: "2.0.0"
  updated: "2025-12-07"
  status: "Phase 2 complete (330 tests)"

# =============================================================================
# THE EMBEDDED TRINITY
# =============================================================================

core_architecture:
  name: "The Embedded Trinity"
  principle: "Three-layer local system, no external servers"

  layers:
    ledger:
      purpose: "Rigid, material state"
      technology: "SQLite + Pydantic"
      location: "src/babylon/data/"
      contains:
        - "JSON data files (17 entity collections)"
        - "database.py (SQLAlchemy session)"
        - "Pydantic models for validation"
      data_flow: "Read at startup, modified by game events, persisted on save"

    topology:
      purpose: "Fluid, relational state"
      technology: "NetworkX (in-memory graph)"
      locations:
        primary: "src/babylon/models/world_state.py (to_graph/from_graph)"
        formulas: "src/babylon/systems/formulas.py"
        engine: "src/babylon/engine/simulation_engine.py"
      contains:
        - "WorldState.to_graph() - DiGraph of entities and relationships"
        - "Relationship edges (EXPLOITATION, SOLIDARITY, REPRESSION)"
        - "Node attributes (wealth, ideology, organization, p_*)"
        - "Edge attributes (value_flow, tension)"
      data_flow: "WorldState converted to graph for step(), then back"
      key_insight: "Graph + Math = History (ADR011)"

    archive:
      purpose: "Semantic history and theory"
      technology: "ChromaDB + embeddings"
      location: "src/babylon/rag/"
      contains:
        - "Historical events"
        - "Theoretical texts (MLM-TW corpus)"
        - "Past game states for narrative"
      data_flow: "AI queries for context, generates narrative from state changes"
      key_insight: "AI observes and narrates, never controls mechanics"

# =============================================================================
# DIRECTORY STRUCTURE
# =============================================================================

directory_map:
  src/babylon/:
    config/: "BaseConfig, environment variables, logging setup"
    core/:
      purpose: "Legacy topology layer (partially deprecated)"
      status: "economy.py and politics.py DELETED per ADR011"
      key_files:
        - "contradiction.py: Legacy ContradictionAnalysis"
        - "entity.py: Base Entity class"
      note: "See engine/ and systems/ for Phase 2+ implementation"

    engine/:
      purpose: "Simulation engine - the Phase 2 game loop"
      key_files:
        - "simulation_engine.py: step(state, config) → new_state"
        - "scenarios.py: Factory functions for test scenarios"
      status: "IMPLEMENTED (26 tests)"

    models/:
      purpose: "Pydantic models for the simulation"
      key_files:
        - "world_state.py: Immutable state snapshot"
        - "config.py: SimulationConfig (frozen)"
        - "types.py: Constrained types (Probability, Currency, etc.)"
        - "enums.py: StrEnum definitions"
        - "entities/: SocialClass, Relationship, etc."
      status: "IMPLEMENTED (150+ tests)"
    data/:
      purpose: "Ledger layer - persistent state"
      key_files:
        - "*.json: 17 entity collection files"
        - "database.py: SQLAlchemy setup"
        - "entity_registry.py: Entity lookup"
      subdirs:
        - "models/: Pydantic model definitions"
        - "xml/: Legacy XML (reference only)"
    schemas/:
      purpose: "JSON Schema validation"
      structure:
        - "core/common.schema.json: Shared $defs"
        - "core/base.schema.json: Metadata envelope"
        - "entities/*.schema.json: 17 entity schemas"
        - "collections/*.schema.json: 17 collection schemas"
    rag/:
      purpose: "Archive layer - semantic memory"
      key_files:
        - "Chunking and embedding logic"
        - "ChromaDB integration"
    systems/:
      purpose: "Game systems implementation"
      key_files:
        - "formulas.py: Mathematical core"
        - "contradiction_analysis.py: Dialectical engine"
    metrics/: "Performance and gameplay metrics"
    utils/: "Shared utilities, exceptions"

  tools/:
    purpose: "CLI utilities"
    key_files:
      - "migrate_xml_to_json.py: Legacy migration"
      - "validate_schemas.py: Schema validation"

  tests/:
    structure:
      - "unit/: Fast, deterministic tests"
      - "fixtures/: Test data"
      - "mocks/: Test doubles"
    markers:
      - "math: Pure formula tests"
      - "ledger: State tests"
      - "topology: Graph tests"
      - "integration: I/O tests"
      - "ai: Slow AI evals"

  brainstorm/: "Ideas not yet ready for implementation"
  ai-docs/: "Machine-readable docs for AI assistants"

# =============================================================================
# DATA FLOW
# =============================================================================

data_flows:

  startup:
    steps:
      - "Load JSON data files from src/babylon/data/"
      - "Validate against schemas"
      - "Build Pydantic models"
      - "Construct NetworkX graph (Topology)"
      - "Initialize ChromaDB connection (Archive)"

  game_turn:
    implementation: "step(WorldState, SimulationConfig) → WorldState"
    location: "src/babylon/engine/simulation_engine.py"
    steps:
      - "1. Convert WorldState to NetworkX DiGraph"
      - "2. Update economic base (imperial rent calculation)"
      - "3. Update survival probabilities (P(S|A), P(S|R))"
      - "4. Update consciousness drift (dΨ/dt)"
      - "5. Update contradiction tension"
      - "6. Convert graph back to new WorldState"
      - "7. Increment tick"
    phase_3_additions:
      - "AI generates narrative from changes (Archive)"
      - "Event bus emits signals for crossovers/ruptures"

  ai_narrative:
    principle: "AI is observer, not controller"
    steps:
      - "Receive state delta (what changed)"
      - "Query Archive for relevant history/theory"
      - "Generate narrative text"
      - "Never modify game mechanics"

# =============================================================================
# KEY INTERFACES
# =============================================================================

interfaces:

  entity_to_ledger:
    pattern: "Pydantic models validated against JSON Schema"
    example: "Faction model → factions.json → factions.schema.json"

  ledger_to_topology:
    pattern: "JSON data → NetworkX nodes/edges"
    example: "faction.dialectical_relationships → graph edges"

  topology_to_archive:
    pattern: "State changes → ChromaDB queries → narrative"
    example: "Contradiction intensified → find similar historical events → generate description"

# =============================================================================
# EXTENSION POINTS
# =============================================================================

extension_points:

  new_entity_type:
    steps:
      - "Add schema to schemas/entities/"
      - "Add collection schema to schemas/collections/"
      - "Add JSON data file to data/"
      - "Add Pydantic model to data/models/"
      - "Register in entity_registry.py"

  new_game_mechanic:
    steps:
      - "Add formula to systems/formulas.py"
      - "Add tests with @pytest.mark.math"
      - "Integrate with ContradictionAnalysis if dialectical"
      - "Document in ai-docs/ontology.yaml if new concept"

  new_ai_capability:
    steps:
      - "Add to rag/ layer only"
      - "Query existing state, never modify directly"
      - "Add @pytest.mark.ai tests (separate from logic tests)"
