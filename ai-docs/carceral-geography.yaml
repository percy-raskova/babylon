# Carceral Geography: The Necropolitical Triad
# =============================================
#
# Sprint 3.7 Implementation
#
# Transforms the TerritorySystem from a heat map into a
# Settler-Colonial Displacement Engine.
#
# Theoretical basis: Mbembe's Necropolitics + Prison Abolition literature

meta:
  version: "1.1.0"
  status: implemented
  sprint: "3.7.1"
  commits:
    - hash: "321a765"
      message: "feat(engine): add Carceral Geography to TerritorySystem"
    - hash: "36f8647"
      message: "fix(__main__): update unpacking for create_two_node_scenario"
    - hash: "2d66ff5"
      message: "docs: add Carceral Geography documentation (Sprint 3.7)"
    - hash: "a92fca7"
      message: "feat(engine): add dynamic displacement priority modes (Sprint 3.7.1)"

# =============================================================================
# TERRITORY TYPE ENUM
# =============================================================================

territory_type:
  location: "src/babylon/models/enums.py"
  class: "TerritoryType"
  base: "StrEnum"

  values:
    CORE:
      value: "core"
      description: "High value, low heat. Labor aristocracy destination."
      is_sink: false
      imperial_rent_flow: recipient

    PERIPHERY:
      value: "periphery"
      description: "Low value, high heat. Source of cheap labor."
      is_sink: false
      imperial_rent_flow: source

    RESERVATION:
      value: "reservation"
      description: "Containment. High subsistence cost, no labor value."
      is_sink: true
      necropolitical_function: containment
      population_effect: none
      organization_effect: none

    PENAL_COLONY:
      value: "penal_colony"
      description: "Extraction. Forced labor zone, suppresses Organization."
      is_sink: true
      necropolitical_function: extraction
      population_effect: none
      organization_effect: "set to 0.0 for connected SocialClass nodes"

    CONCENTRATION_CAMP:
      value: "concentration_camp"
      description: "Elimination. High population decay, generates Terror."
      is_sink: true
      necropolitical_function: elimination
      population_effect: "decay by concentration_camp_decay_rate per tick"
      organization_effect: none

# =============================================================================
# DISPLACEMENT PRIORITY MODE ENUM (Sprint 3.7.1)
# =============================================================================

displacement_priority_mode:
  location: "src/babylon/models/enums.py"
  class: "DisplacementPriorityMode"
  base: "StrEnum"
  description: |
    Mode for displacement routing priority. Determines sink node selection
    order during eviction based on material conditions.

  values:
    EXTRACTION:
      value: "extraction"
      description: "Labor is valuable. Prison-industrial complex logic."
      priority_order: [PENAL_COLONY, RESERVATION, CONCENTRATION_CAMP]
      quote: "We need their labor."

    CONTAINMENT:
      value: "containment"
      description: "Crisis or transition period. Warehousing logic."
      priority_order: [RESERVATION, PENAL_COLONY, CONCENTRATION_CAMP]
      quote: "We need them out of the way but not dead yet."

    ELIMINATION:
      value: "elimination"
      description: "Late fascism. Necropolitical logic."
      priority_order: [CONCENTRATION_CAMP, PENAL_COLONY, RESERVATION]
      quote: "We don't need them at all."

    AUTO:
      value: "auto"
      description: "Compute mode dynamically from economic/political conditions."
      note: "Reserved for future implementation"

# =============================================================================
# TERRITORY MODEL UPDATES
# =============================================================================

territory_model:
  location: "src/babylon/models/entities/territory.py"

  new_field:
    name: "territory_type"
    type: "TerritoryType"
    default: "TerritoryType.CORE"
    description: "Classification in settler-colonial hierarchy"

  new_property:
    name: "is_sink_node"
    returns: bool
    description: |
      Whether territory is a sink node in the displacement pipeline.
      Returns True for RESERVATION, PENAL_COLONY, CONCENTRATION_CAMP.
    implementation: |
      return self.territory_type in {
          TerritoryType.RESERVATION,
          TerritoryType.PENAL_COLONY,
          TerritoryType.CONCENTRATION_CAMP,
      }

# =============================================================================
# TERRITORY SYSTEM UPDATES
# =============================================================================

territory_system:
  location: "src/babylon/engine/systems/territory.py"

  class_variables:
    _PRIORITY_BY_MODE:
      type: "ClassVar[dict[DisplacementPriorityMode, list[TerritoryType]]]"
      description: "Maps displacement mode to sink node priority order"
      value:
        EXTRACTION: [PENAL_COLONY, RESERVATION, CONCENTRATION_CAMP]
        CONTAINMENT: [RESERVATION, PENAL_COLONY, CONCENTRATION_CAMP]
        ELIMINATION: [CONCENTRATION_CAMP, PENAL_COLONY, RESERVATION]
      note: "Sprint 3.7.1 replaced static _SINK_PRIORITY dict"

  new_methods:
    _find_sink_node:
      signature: "(self, source_node_id: str, graph: nx.DiGraph[str], mode: DisplacementPriorityMode) -> str | None"
      description: |
        Find a sink node adjacent to source for displaced population routing.
        Uses ADJACENCY edges. Returns highest priority sink based on mode.
      mode_parameter: "Sprint 3.7.1 added mode parameter for dynamic priority"
      fallback: "Defaults to EXTRACTION priority if mode not found"

    _process_necropolitics:
      signature: "(self, graph: nx.DiGraph[str], services: ServiceContainer) -> None"
      description: |
        Process necropolitical effects on sink territories.
        Called after eviction pipeline, before spillover.
      effects:
        CONCENTRATION_CAMP:
          action: "population *= (1.0 - concentration_camp_decay_rate)"
          meaning: "Elimination - accelerated death"
        PENAL_COLONY:
          action: "Find TENANCY edges, set source organization = 0.0"
          meaning: "Atomization - breaking the strike"
        RESERVATION:
          action: "none"
          meaning: "Containment - population warehoused"

    _suppress_organization:
      signature: "(self, territory_id: str, graph: nx.DiGraph[str]) -> None"
      description: |
        Suppress organization for all SocialClass nodes connected to a
        penal colony via TENANCY edges.

  modified_methods:
    step:
      change: "Added call to _process_necropolitics after eviction"
      new_order:
        - _process_heat_dynamics
        - _process_eviction_pipeline
        - _process_necropolitics  # NEW
        - _process_spillover

    _process_eviction_pipeline:
      change: "Population transfer instead of deletion"
      old_behavior: "population = int(population * (1 - displacement_rate))"
      new_behavior: |
        1. Calculate displaced_pop = current_pop * displacement_rate
        2. Find target via _find_sink_node()
        3. If target: transfer population (decrement source, increment target)
        4. If no target: keep deletion as fallback (exile/death)

# =============================================================================
# CONFIGURATION
# =============================================================================

config:
  location: "src/babylon/models/config.py"

  parameters:
    concentration_camp_decay_rate:
      type: "Coefficient"  # [0.0, 1.0]
      default: 0.2
      sprint: "3.7"
      description: |
        Population decay rate in CONCENTRATION_CAMP territories.
        Default 0.2 = 20% population loss per tick (elimination).

    displacement_priority_mode:
      type: "DisplacementPriorityMode"
      default: "EXTRACTION"
      sprint: "3.7.1"
      description: |
        Mode for sink node routing priority during eviction.
        EXTRACTION (default), CONTAINMENT, ELIMINATION, or AUTO.

    elimination_rent_threshold:
      type: "Coefficient"
      default: 0.1
      sprint: "3.7.1"
      description: "Rent ratio below which elimination MAY activate (requires tension too)"

    elimination_tension_threshold:
      type: "Coefficient"
      default: 0.8
      sprint: "3.7.1"
      description: "Average tension above which elimination MAY activate (requires rent too)"

    containment_rent_threshold:
      type: "Coefficient"
      default: 0.3
      sprint: "3.7.1"
      description: "Rent ratio below which containment activates"

    containment_tension_threshold:
      type: "Coefficient"
      default: 0.5
      sprint: "3.7.1"
      description: "Average tension above which containment activates"

# =============================================================================
# DISPLACEMENT PIPELINE
# =============================================================================

displacement_pipeline:
  description: |
    The flow of population through the carceral geography.
    Eviction triggers displacement; sinks absorb displaced populations.

  trigger:
    condition: "heat >= eviction_heat_threshold AND under_eviction"
    default_threshold: 0.8

  routing:
    step_1: "Calculate displaced_pop = population * displacement_rate"
    step_2: "Get current displacement mode from config"
    step_3: "Find adjacent sink via ADJACENCY edges using mode priority"
    step_4: "Transfer population (source - displaced, target + displaced)"
    fallback: "If no sink, population disappears (original behavior)"

  priority_logic:
    description: "Priority order depends on displacement_priority_mode (Sprint 3.7.1)"
    modes:
      EXTRACTION: "PENAL_COLONY > RESERVATION > CONCENTRATION_CAMP"
      CONTAINMENT: "RESERVATION > PENAL_COLONY > CONCENTRATION_CAMP"
      ELIMINATION: "CONCENTRATION_CAMP > PENAL_COLONY > RESERVATION"
    default: "EXTRACTION (labor has value)"
    note: "Sprint 3.7 used static ELIMINATION priority"

# =============================================================================
# NECROPOLITICS PHASE
# =============================================================================

necropolitics_phase:
  description: |
    New phase added to TerritorySystem.step().
    Processes effects specific to sink territories.

  timing: "After eviction pipeline, before spillover"

  effects:
    concentration_camp:
      mechanic: "population *= (1.0 - decay_rate)"
      default_decay: 0.2
      meaning: |
        Elimination. The state actively kills populations.
        Not through single events but through sustained attrition.
        Historical parallels: death camps, medical neglect, exposure.

    penal_colony:
      mechanic: "Connected SocialClass.organization = 0.0"
      edge_type: "TENANCY"
      meaning: |
        Atomization. The prison breaks solidarity.
        Historical parallels: prison gangs, solitary confinement,
        COINTELPRO-style disruption of organizing.

    reservation:
      mechanic: "none (containment only)"
      meaning: |
        Warehousing. Population neither grows nor organizes.
        Historical parallels: reservations, public housing, refugee camps.

# =============================================================================
# TEST COVERAGE
# =============================================================================

tests:
  model_tests:
    location: "tests/unit/models/test_territory.py"
    sprint: "3.7"
    tests:
      - test_territory_type_defaults_to_core
      - test_is_sink_node_true_for_reservation
      - test_is_sink_node_true_for_penal_colony
      - test_is_sink_node_true_for_concentration_camp
      - test_is_sink_node_false_for_core
      - test_is_sink_node_false_for_periphery
    count: 6

  system_tests_sprint_3_7:
    location: "tests/unit/engine/systems/test_territory_system.py"
    sprint: "3.7"
    class: "TestCarceralGeography"
    tests:
      - test_find_sink_node_returns_concentration_camp_priority
      - test_find_sink_node_returns_penal_colony_when_no_camp
      - test_find_sink_node_returns_reservation_when_no_higher_priority
      - test_find_sink_node_returns_none_when_no_sinks
      - test_eviction_transfers_population_to_sink
      - test_eviction_deletes_population_when_no_sink
      - test_concentration_camp_eliminates_population
      - test_penal_colony_suppresses_connected_class_organization
    count: 8

  system_tests_sprint_3_7_1:
    location: "tests/unit/engine/systems/test_territory_system.py"
    sprint: "3.7.1"
    class: "TestDisplacementPriorityModes"
    tests:
      - test_extraction_mode_prioritizes_penal_colony
      - test_containment_mode_prioritizes_reservation
      - test_elimination_mode_prioritizes_concentration_camp
      - test_find_sink_node_with_extraction_mode
      - test_find_sink_node_with_containment_mode
      - test_find_sink_node_with_elimination_mode
      - test_find_sink_node_defaults_to_extraction_priority
      - test_invalid_mode_falls_back_to_extraction
    count: 8

  summary:
    sprint_3_7_tests: 14
    sprint_3_7_1_tests: 8
    total_carceral_tests: 22
    total_project_tests: 440
    status: "all passing"

# =============================================================================
# INTEGRATION POINTS
# =============================================================================

integration:
  eviction_pipeline:
    relation: "extended"
    description: "Displacement now routes to sinks instead of deletion"

  solidarity_system:
    relation: "attacked by"
    description: "PENAL_COLONY suppresses organization, breaking solidarity"

  consciousness_system:
    relation: "future integration"
    description: "Sink populations may have altered consciousness dynamics"

  future_work:
    - "AUTO mode computation in SimulationEngine (threshold-based mode switching)"
    - "Liberation mechanics (converting sinks to liberated zones)"
    - "Extraction operations (rescuing populations)"
    - "Counter-infrastructure (solidarity edges INTO sinks)"
    - "Terror generation (camps generate repression bonus)"
    - "Hysteresis (require sustained condition for mode change)"
    - "Per-territory mode overrides"
    - "Mode transition events for narrative layer"

# =============================================================================
# THEORETICAL FRAMEWORK
# =============================================================================

theory:
  necropolitics:
    source: "Achille Mbembe, 'Necropolitics' (2003)"
    key_concept: |
      Sovereignty as the power to dictate who may live and who must die.
      Not just the right to kill but the differential allocation of death.

  prison_industrial_complex:
    sources:
      - "Angela Davis, 'Are Prisons Obsolete?'"
      - "Ruth Wilson Gilmore, 'Golden Gulag'"
    key_concept: |
      Mass incarceration as population management, not crime control.
      Warehousing surplus labor, extracting value, breaking solidarity.

  settler_colonialism:
    sources:
      - "Patrick Wolfe, 'Settler Colonialism and the Elimination of the Native'"
      - "J. Sakai, 'Settlers: The Mythology of the White Proletariat'"
    key_concept: |
      Elimination is the organizing principle of settler-colonial society.
      The logic of elimination structures land, labor, and state violence.
