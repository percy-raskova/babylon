# Class Wealth Dynamics ODE System
# Empirically derived from FRED Distributional Financial Accounts (2015-2025)
# Machine-readable spec for LLM-assisted development

meta:
  version: "1.0.0"
  created: "2026-01-02"
  purpose: "Document the empirically-derived class wealth dynamics ODE system"
  principle: "Graph + Math = History"
  status: "IMPLEMENTED"
  location:
    formulas: "src/babylon/systems/formulas/class_dynamics.py"
    analysis: "tools/analyze_wealth_distribution.py"
    tests: "tests/unit/formulas/test_class_dynamics.py"
  test_count: "39 unit tests + 8 doctests (ALL PASSING)"
  data_source: "FRED Distributional Financial Accounts (DFA) 2015-2025"

# =============================================================================
# ORIGINAL RESEARCH QUESTION (User's Exact Words)
# =============================================================================

original_question: |
  I have a theory I want to validate against empirical evidence. The theory goes
  as follows: Within the imperial core today, there are 4 broad 'classes'
  identifiable by wealth.

  - The top 1%
  - The next 9% (90-99 percentile)
  - The next 50% (50-90 percentile)
  - The bottom 40-50%

  The theory states:
  - Top 1% owns approximately 1/3 of total wealth
  - Next 9% (90-99%) owns approximately 1/3 of total wealth
  - Next 50% (50-90%) owns approximately 1/3 of total wealth
  - Bottom 40-50% owns essentially nothing (~0%)

  I want to:
  1. Validate this against FRED Distributional Financial Accounts data
  2. Create a visualization with wealth brackets as FIXED (33%/33%/33%/0%) and
     population as the DEPENDENT variable
  3. Show a stacked area chart of population concentration in each wealth third
  4. Derive flow-based Marxian differential equations for class wealth dynamics
  5. These ODEs should be compatible with Babylon's formula system

# =============================================================================
# EMPIRICAL FINDINGS (2025 Q2 FRED Data)
# =============================================================================

empirical_validation:
  data_range: "2015 Q1 - 2025 Q2 (42 quarters)"

  actual_distribution:
    top_1_percent:
      population_share: "1%"
      wealth_share: "30.7%"
      theory_prediction: "~33%"
      verdict: "VALIDATED (close to 1/3)"
      babylon_class: "core_bourgeoisie"

    next_9_percent:
      population_share: "9%"
      wealth_share: "36.4%"
      theory_prediction: "~33%"
      verdict: "VALIDATED (slightly above 1/3)"
      babylon_class: "petty_bourgeoisie"

    next_40_percent:
      population_share: "40%"
      wealth_share: "30.3%"
      theory_prediction: "~33%"
      verdict: "VALIDATED (close to 1/3)"
      babylon_class: "labor_aristocracy"

    bottom_50_percent:
      population_share: "50%"
      wealth_share: "2.5%"
      theory_prediction: "~0%"
      verdict: "VALIDATED (essentially nothing)"
      babylon_class: "internal_proletariat"

  key_insight: |
    The theory is approximately correct. Wealth distribution follows a
    31/36/30/2.5 pattern rather than exact 33/33/33/0, but the structural
    insight holds: wealth divides into roughly equal thirds among the top
    three tiers, with the bottom half owning essentially nothing.

  inverted_distribution:
    description: |
      Population distribution by fixed wealth thirds (2025 Q2):
      - Bottom third of wealth (0-33%): Owned by 90.1% of population
      - Middle third of wealth (33-67%): Owned by 8.3% of population
      - Top third of wealth (67-100%): Owned by 1.6% of population

# =============================================================================
# TEMPORAL STABILITY ANALYSIS
# =============================================================================

stability_analysis:
  finding: |
    Wealth distribution is remarkably stable over the 11-year period.
    The Top 1%'s share oscillates between 29.1% (2020 Q1 COVID crash)
    and 31.0% (2025 Q2), with homeostatic return to ~30.5%.

  trends:
    top_1_percent:
      trend: "STABLE"
      rate: "~0%/year"
      mechanism: "Self-reinforcing homeostasis around 30%"

    next_9_percent:
      trend: "DECLINING"
      rate: "-0.3%/year"
      mechanism: "Wealth flowing to both bourgeoisie and lower classes"

    next_40_percent:
      trend: "RISING"
      rate: "+0.14%/year"
      mechanism: "Redistribution + imperial rent injection"

    bottom_50_percent:
      trend: "RISING"
      rate: "+0.14%/year"
      mechanism: "Redistribution from taxation/inheritance"

  covid_impact:
    observation: |
      COVID-19 caused significant but temporary redistribution:
      - Top 1% dropped from 30.5% to 29.1% (Q4 2019 → Q1 2020)
      - Bottom 50% rose from 1.9% to 2.7% (stimulus checks)
      - System restored homeostasis by Q4 2020

# =============================================================================
# ODE SYSTEM SPECIFICATION
# =============================================================================

ode_system:
  description: |
    First-order coupled differential equations modeling wealth flows between
    four Marxian classes. Fitted from FRED data 2015-2025.

  state_variables:
    W1: "Core Bourgeoisie wealth share (Top 1%)"
    W2: "Petty Bourgeoisie wealth share (90-99%)"
    W3: "Labor Aristocracy wealth share (50-90%)"
    W4: "Internal Proletariat wealth share (Bottom 50%)"
    constraint: "W1 + W2 + W3 + W4 = 1.0 (conservation)"

  first_order_system:
    equations:
      dW1_dt: "dW₁/dt = α₄₁W₄ + α₃₁W₃ + α₂₁W₂ - δ₁W₁"
      dW2_dt: "dW₂/dt = α₃₂W₃ + α₄₂W₄ - α₂₁W₂ - δ₂W₂"
      dW3_dt: "dW₃/dt = α₄₃W₄ + γ₃ - α₃₁W₃ - α₃₂W₃ - δ₃W₃"
      dW4_dt: "dW₄/dt = -(dW₁/dt + dW₂/dt + dW₃/dt)"

    parameters:
      extraction_rates:
        alpha_41:
          value: 0.0
          description: "Proletariat → Bourgeoisie (negligible direct extraction)"
        alpha_31:
          value: 0.0
          description: "Labor Aristocracy → Bourgeoisie"
        alpha_21:
          value: 0.0006
          description: "Petty Bourgeoisie → Bourgeoisie (quarterly)"
        alpha_32:
          value: 0.0
          description: "Labor Aristocracy → Petty Bourgeoisie"
        alpha_42:
          value: 0.0
          description: "Proletariat → Petty Bourgeoisie"
        alpha_43:
          value: 0.0
          description: "Proletariat → Labor Aristocracy"

      redistribution_rates:
        delta_1:
          value: 0.0010
          description: "Redistribution from Bourgeoisie (taxation, inheritance)"
        delta_2:
          value: 0.0020
          description: "Redistribution from Petty Bourgeoisie"
        delta_3:
          value: 0.0010
          description: "Redistribution from Labor Aristocracy"

      imperial_rent:
        gamma_3:
          value: 0.0057
          description: "Imperial rent formation rate (superwages to core workers)"
          theoretical_basis: |
            This parameter represents the injection of value extracted from the
            Global South into the Labor Aristocracy via super-wages. It's the
            material basis of first-world worker complicity in imperialism.

  second_order_system:
    description: |
      Second-order dynamics model momentum effects and oscillation around
      equilibrium values. These capture market psychology and institutional
      inertia.

    equation: "d²Wᵢ/dt² = βᵢ(dWᵢ/dt) - ωᵢ²(Wᵢ - Wᵢ*)"

    parameters:
      damping_coefficients:
        beta_1: -0.10
        beta_2: -0.15
        beta_3: -0.10
        beta_4: -0.05
        note: "Negative values ensure mean-reversion (damped oscillation)"

      natural_frequencies:
        omega_1: 0.05
        omega_2: 0.08
        omega_3: 0.05
        omega_4: 0.03
        note: "Higher ω means faster oscillation around equilibrium"

      equilibrium_attractors:
        W1_star: 0.305
        W2_star: 0.382
        W3_star: 0.294
        W4_star: 0.020
        note: "FRED-fitted equilibrium values (sum = 1.001 due to rounding)"

# =============================================================================
# FORMULA IMPLEMENTATIONS
# =============================================================================

formulas:
  calculate_wealth_flow:
    signature: "calculate_wealth_flow(source_share, extraction_rate, resistance=0.0)"
    equation: "Flow = α × W_source × (1 - r)"
    description: "Per-tick wealth flow from source class with resistance"

  calculate_class_dynamics_derivative:
    signature: "calculate_class_dynamics_derivative(wealth_shares, params, resistances)"
    returns: "(dW₁/dt, dW₂/dt, dW₃/dt, dW₄/dt)"
    description: "First-order derivatives for all four classes"
    constraint: "Sum of derivatives = 0 (wealth conservation)"

  calculate_wealth_acceleration:
    signature: "calculate_wealth_acceleration(wealth_share, velocity, equilibrium, damping, frequency)"
    equation: "d²W/dt² = β × (dW/dt) - ω² × (W - W*)"
    description: "Second-order derivative for momentum dynamics"

  calculate_full_dynamics:
    signature: "calculate_full_dynamics(wealth_shares, velocities, params, second_order, resistances)"
    returns: "((dW₁, dW₂, dW₃, dW₄), (d²W₁, d²W₂, d²W₃, d²W₄))"
    description: "Combined first and second order dynamics"

  calculate_equilibrium_deviation:
    signature: "calculate_equilibrium_deviation(wealth_shares, equilibrium=None)"
    returns: "Sum of squared deviations from equilibrium"
    description: "Metric for detecting system stability"

  invert_wealth_to_population:
    signature: "invert_wealth_to_population(wealth_shares, target_wealth_pct)"
    returns: "Population percentile owning up to target wealth"
    description: "Inverts distribution for fixed-wealth-bracket analysis"

# =============================================================================
# THEORETICAL IMPLICATIONS
# =============================================================================

theoretical_implications:
  mlm_tw_validation:
    observation: |
      The data validates core MLM-TW predictions:
      1. Wealth concentration is structurally stable (not accidental)
      2. Bottom 50% owns essentially nothing (proletariat dispossession)
      3. Labor aristocracy (50-90%) receives imperial rent injection (γ₃ > 0)
      4. Petty bourgeoisie slowly loses ground (buffer class erosion)

  game_integration:
    purpose: |
      These ODEs can be integrated into Babylon's simulation engine to model
      realistic wealth dynamics. The parameters can be tuned via:
      - GameDefines for baseline values
      - Scenario-specific overrides for alternate histories
      - Real-time adjustment based on game events (crisis, war, revolution)

  class_consciousness_extension:
    proposal: |
      The `resistances` parameter models class consciousness effects on
      extraction rates. Higher consciousness reduces wealth extraction:

      Flow = α × W_source × (1 - resistance)

      This allows the simulation to model:
      - Unionization effects (r ↑ reduces extraction)
      - Revolutionary organizing (r → 1 blocks all extraction)
      - False consciousness (r = 0, full extraction)

# =============================================================================
# FILES CREATED
# =============================================================================

artifacts:
  source_code:
    - path: "src/babylon/systems/formulas/class_dynamics.py"
      purpose: "ODE formulas for simulation engine"
      exports:
        - "ClassDynamicsParams"
        - "SecondOrderParams"
        - "calculate_class_dynamics_derivative"
        - "calculate_equilibrium_deviation"
        - "calculate_full_dynamics"
        - "calculate_wealth_acceleration"
        - "calculate_wealth_flow"
        - "invert_wealth_to_population"

    - path: "tools/analyze_wealth_distribution.py"
      purpose: "Analysis script for FRED data"
      usage: "poetry run python tools/analyze_wealth_distribution.py"

  tests:
    - path: "tests/unit/formulas/test_class_dynamics.py"
      purpose: "Comprehensive unit tests (39 tests)"
      markers: "@pytest.mark.math"

  data:
    - path: "results/wealth_shares_fred.csv"
      purpose: "Raw FRED wealth shares by class (2015-2025)"

    - path: "results/wealth_inversion.csv"
      purpose: "Inverted population shares by wealth third"

    - path: "results/wealth_stacked.png"
      purpose: "Matplotlib stacked area visualization"
