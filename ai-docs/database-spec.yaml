# Babylon Database Specification
# Logical Data Dictionary for the Ledger Component

meta:
  version: "1.1.0"
  created: "2025-12-09"
  updated: "2025-12-09"
  purpose: "Source of truth for the Ledger layer domain model storage"
  contents:
    - "Logical Data Dictionary - conceptual entity definitions"
    - "Physical Schema - SQLite DDL specifications"
    - "Type Mappings - Python to SQLite translations"
    - "Query Patterns - common SQL queries"
  related_docs:
    - "ai-docs/architecture.yaml - Embedded Trinity overview"
    - "ai-docs/entities.yaml - Entity reference"
    - "src/babylon/models/entities/ - Pydantic implementations"

# =============================================================================
# LOGICAL DATA DICTIONARY
# =============================================================================

logical_dictionary:
  description: |
    Maps Pydantic game entities to logical database concepts.
    The Ledger stores rigid, material state. The Topology (NetworkX)
    handles fluid relational state at runtime.

  # ---------------------------------------------------------------------------
  # SOCIAL CLASSES (Entity Nodes)
  # ---------------------------------------------------------------------------
  social_classes:
    description: |
      The fundamental node type in the simulation. Social classes are defined
      by their relationship to production and position in the imperial hierarchy.
      Sprint 3.4.3 introduced the multi-dimensional IdeologicalProfile
      (George Jackson Refactor).

    source_model: "babylon.models.entities.SocialClass"
    id_pattern: "^C[0-9]{3}$"

    columns:
      id:
        type: "VARCHAR(4)"
        constraints: "PRIMARY KEY"
        description: "Unique identifier (e.g., C001, C042)"
        example: "C001"

      name:
        type: "VARCHAR(255)"
        constraints: "NOT NULL"
        description: "Human-readable name for the class"
        example: "American Proletariat"

      role:
        type: "VARCHAR(50)"
        constraints: "NOT NULL, ENUM"
        description: "Position in the world system (SocialRole)"
        enum_values:
          - "core_bourgeoisie"
          - "periphery_proletariat"
          - "labor_aristocracy"
          - "petty_bourgeoisie"
          - "lumpenproletariat"
        example: "labor_aristocracy"

      description:
        type: "TEXT"
        constraints: "DEFAULT ''"
        description: "Detailed description of the class"
        example: "Workers in the imperial core benefiting from super-wages"

      # Material Base (Economic Component)
      wealth:
        type: "DECIMAL(18,4)"
        constraints: "DEFAULT 10.0, CHECK >= 0"
        description: "Economic resources (Material Base)"
        domain_type: "Currency"
        formula_usage: "Input to P(S|A) calculation"
        example: 15.5

      subsistence_threshold:
        type: "DECIMAL(18,4)"
        constraints: "DEFAULT 5.0, CHECK >= 0"
        description: "Minimum wealth for survival (survival line)"
        domain_type: "Currency"
        formula_usage: "W - T in acquiescence formula"
        example: 5.0

      # IdeologicalProfile (George Jackson Refactor - Sprint 3.4.3)
      class_consciousness:
        type: "DECIMAL(5,4)"
        constraints: "DEFAULT 0.0, CHECK >= 0.0 AND <= 1.0"
        description: |
          Vertical Axis: Relationship to Capital.
          0.0 = False Consciousness (does not understand class position)
          1.0 = Revolutionary Consciousness (full understanding)
        domain_type: "Float [0, 1]"
        formula_usage: "Ideological routing target for agitation + solidarity"
        mlm_concept: "Bifurcation parameter in consciousness manifold"
        example: 0.35

      national_identity:
        type: "DECIMAL(5,4)"
        constraints: "DEFAULT 0.5, CHECK >= 0.0 AND <= 1.0"
        description: |
          Horizontal Axis: Relationship to State/Tribe.
          0.0 = Internationalist (class solidarity over national identity)
          1.0 = Nativist/Fascist (national/racial identity over class)
        domain_type: "Float [0, 1]"
        formula_usage: "Ideological routing target for agitation - solidarity"
        mlm_concept: "Fascism is the defensive form of capitalism"
        example: 0.5

      agitation:
        type: "DECIMAL(18,4)"
        constraints: "DEFAULT 0.0, CHECK >= 0.0"
        description: |
          Raw political energy magnitude from crisis conditions.
          Generated by falling wages, accumulates over time.
          Routes to either consciousness axis based on solidarity_pressure.
        domain_type: "Float [0, inf)"
        formula_usage: "calculate_ideological_routing() input"
        example: 2.75

      # Survival Calculus Outputs
      p_acquiescence:
        type: "DECIMAL(5,4)"
        constraints: "DEFAULT 0.0, CHECK >= 0.0 AND <= 1.0"
        description: |
          P(S|A) - Survival probability through acquiescence.
          Computed: Sigmoid(Wealth - Subsistence)
        domain_type: "Probability"
        formula: "calculate_acquiescence_probability(wealth, subsistence_threshold)"
        example: 0.73

      p_revolution:
        type: "DECIMAL(5,4)"
        constraints: "DEFAULT 0.0, CHECK >= 0.0 AND <= 1.0"
        description: |
          P(S|R) - Survival probability through revolution.
          Computed: Organization / Repression
        domain_type: "Probability"
        formula: "calculate_revolution_probability(organization, repression)"
        example: 0.15

      # Material Conditions (Inputs to Survival Calculus)
      organization:
        type: "DECIMAL(5,4)"
        constraints: "DEFAULT 0.1, CHECK >= 0.0 AND <= 1.0"
        description: |
          Collective cohesion / class consciousness level.
          0.1 = 10% organized, 1.0 = fully organized vanguard.
        domain_type: "Probability"
        formula_usage: "Numerator in P(S|R)"
        example: 0.1

      repression_faced:
        type: "DECIMAL(5,4)"
        constraints: "DEFAULT 0.5, CHECK >= 0.0 AND <= 1.0"
        description: |
          State violence directed at this class.
          0.0 = no repression, 1.0 = total state violence.
        domain_type: "Probability"
        formula_usage: "Denominator in P(S|R)"
        example: 0.5

    indexes:
      - "CREATE INDEX idx_social_classes_role ON social_classes(role)"
      - "CREATE INDEX idx_social_classes_wealth ON social_classes(wealth)"

    relationships:
      - "1:N → Relationship (as source_id)"
      - "1:N → Relationship (as target_id)"
      - "1:N → Territory (as host_id)"
      - "1:N → Territory (as occupant_id)"

  # ---------------------------------------------------------------------------
  # TERRITORIES (Layer 0 - Spatial Substrate)
  # ---------------------------------------------------------------------------
  territories:
    description: |
      Sprint 3.5.2: Layer 0 - The Territorial Substrate.
      Territories are spatial nodes representing strategic sectors.
      Unlike SocialClass nodes (abstract class positions), Territory nodes
      are physical locations that can be occupied, contested, and liberated.

    source_model: "babylon.models.entities.Territory"
    id_pattern: "^T[0-9]{3}$"

    columns:
      id:
        type: "VARCHAR(4)"
        constraints: "PRIMARY KEY"
        description: "Sector ID (e.g., T001, T005)"
        example: "T005"

      name:
        type: "VARCHAR(255)"
        constraints: "NOT NULL"
        description: "Human-readable sector name"
        example: "Oakland Industrial Zone"

      sector_type:
        type: "VARCHAR(50)"
        constraints: "NOT NULL, ENUM"
        description: "Economic/social character of the territory"
        enum_values:
          - "industrial"
          - "residential"
          - "commercial"
          - "university"
          - "docks"
          - "government"
        example: "industrial"

      # Ownership Stack (Host/Parasite)
      host_id:
        type: "VARCHAR(4)"
        constraints: "NULLABLE, FOREIGN KEY → social_classes(id)"
        description: |
          ID of Legal Sovereign (collects rent/taxes).
          NULL = no recognized owner (contested/liberated).
        example: "C001"

      occupant_id:
        type: "VARCHAR(4)"
        constraints: "NULLABLE, FOREIGN KEY → social_classes(id)"
        description: |
          ID of De Facto Occupant (actually uses the space).
          May differ from host (revolutionary occupation).
        example: "C003"

      # Operational Profile (Visibility Stance)
      profile:
        type: "VARCHAR(20)"
        constraints: "DEFAULT 'low_profile', ENUM"
        description: |
          Visibility stance trading safety for recruitment.
          LOW_PROFILE: "We are just a reading group." (safe, low recruitment)
          HIGH_PROFILE: "We are a Revolutionary Cell." (high recruitment, high heat)
        enum_values:
          - "low_profile"
          - "high_profile"
        mlm_concept: "Legibility over Stealth - The State knows where you are"
        example: "low_profile"

      # State Dynamics
      heat:
        type: "DECIMAL(5,4)"
        constraints: "DEFAULT 0.0, CHECK >= 0.0 AND <= 1.0"
        description: |
          State attention level [0, 1].
          HIGH_PROFILE territories gain heat each tick.
          LOW_PROFILE territories decay heat each tick.
          Heat >= 0.8 triggers eviction pipeline.
        domain_type: "Intensity"
        formula_usage: "Threshold check in TerritorySystem"
        example: 0.35

      # Economic Dynamics
      rent_level:
        type: "DECIMAL(18,4)"
        constraints: "DEFAULT 1.0, CHECK >= 0.0"
        description: |
          Economic pressure on occupants (baseline = 1.0).
          Higher rent extracts more value from occupants.
        domain_type: "Currency"
        example: 1.5

      # Population Dynamics
      population:
        type: "INTEGER"
        constraints: "DEFAULT 0, CHECK >= 0"
        description: |
          Human shield count (sympathizers).
          Higher population provides protection from eviction.
        example: 150

      # Eviction State
      under_eviction:
        type: "BOOLEAN"
        constraints: "DEFAULT FALSE"
        description: "Whether eviction pipeline is active"
        example: false

    indexes:
      - "CREATE INDEX idx_territories_sector ON territories(sector_type)"
      - "CREATE INDEX idx_territories_heat ON territories(heat)"
      - "CREATE INDEX idx_territories_host ON territories(host_id)"
      - "CREATE INDEX idx_territories_occupant ON territories(occupant_id)"

    computed_properties:
      clarity_bonus:
        formula: "0.3 if profile == 'high_profile' else 0.0"
        description: "Recruitment bonus from HIGH_PROFILE visibility"

      is_liberated:
        formula: "occupant_id IS NOT NULL AND host_id IS NULL"
        description: "Territory is a Liberated Zone (no legal sovereign)"

    relationships:
      - "N:1 → SocialClass (via host_id - Legal Sovereign)"
      - "N:1 → SocialClass (via occupant_id - De Facto Occupant)"
      - "1:N → Relationship (TENANCY edges)"
      - "1:N → Relationship (ADJACENCY edges)"

  # ---------------------------------------------------------------------------
  # RELATIONSHIPS (The Wiring - Edges)
  # ---------------------------------------------------------------------------
  relationships:
    description: |
      Directed edges between entities encoding value flows, social dynamics,
      and dialectical tension. This is the fundamental edge type enabling
      the "Graph + Math = History" principle.

    source_model: "babylon.models.entities.Relationship"

    columns:
      source_id:
        type: "VARCHAR(4)"
        constraints: "NOT NULL"
        description: |
          Origin node ID. Value/action flows FROM here.
          References social_classes(id) or territories(id).
        example: "C002"

      target_id:
        type: "VARCHAR(4)"
        constraints: "NOT NULL"
        description: |
          Destination node ID. Value/action flows TO here.
          References social_classes(id) or territories(id).
        example: "C001"

      edge_type:
        type: "VARCHAR(50)"
        constraints: "NOT NULL, ENUM"
        description: "Nature of the relationship (edge classification)"
        enum_values:
          - "exploitation"
          - "solidarity"
          - "repression"
          - "competition"
          - "tribute"
          - "wages"
          - "client_state"
          - "tenancy"
          - "adjacency"
        edge_semantics:
          exploitation: "Value extraction (imperial rent Φ flows along these edges)"
          solidarity: "Mutual support, consciousness transmission infrastructure"
          repression: "State violence directed at a class"
          competition: "Market rivalry between entities"
          tribute: "Periphery comprador → Core (comprador keeps cut)"
          wages: "Core bourgeoisie → Core workers (super-wages from Φ)"
          client_state: "Imperial subsidy to maintain stability"
          tenancy: "Occupant → Territory (Sprint 3.5.1)"
          adjacency: "Territory → Territory spatial connectivity (Sprint 3.5.1)"
        example: "exploitation"

      # Value Flow
      value_flow:
        type: "DECIMAL(18,4)"
        constraints: "DEFAULT 0.0, CHECK >= 0.0"
        description: |
          Imperial rent or value transfer amount (Φ).
          For EXPLOITATION edges: extracted surplus value.
          For WAGES edges: super-wages paid from imperial rent pool.
        domain_type: "Currency"
        formula_usage: "calculate_imperial_rent() output"
        example: 5.0

      # Relational State
      tension:
        type: "DECIMAL(5,4)"
        constraints: "DEFAULT 0.0, CHECK >= 0.0 AND <= 1.0"
        description: |
          Dialectical tension / contradiction intensity.
          Accumulates over time, triggers rupture at critical levels.
        domain_type: "Intensity"
        formula_usage: "ContradictionSystem accumulation"
        example: 0.65

      # Metadata
      description:
        type: "TEXT"
        constraints: "DEFAULT ''"
        description: "Human-readable description of this relationship"
        example: "Core extraction of surplus from periphery workers"

      # Imperial Circuit Parameters (Sprint 3.4.1)
      subsidy_cap:
        type: "DECIMAL(18,4)"
        constraints: "DEFAULT 0.0, CHECK >= 0.0"
        description: |
          Maximum subsidy amount for CLIENT_STATE edges.
          Limits how much imperial rent can be converted to suppression.
        domain_type: "Currency"
        edge_type_scope: "CLIENT_STATE only"
        example: 10.0

      # Solidarity Transmission (Sprint 3.4.2 - The Fascist Switch)
      solidarity_strength:
        type: "DECIMAL(5,4)"
        constraints: "DEFAULT 0.0, CHECK >= 0.0 AND <= 1.0"
        description: |
          Built solidarity infrastructure strength for SOLIDARITY edges.
          The Fascist Switch: presence/absence of solidarity determines
          whether agitation routes to class_consciousness or national_identity.
          0.0 = no infrastructure, 1.0 = full vanguard organization.
        domain_type: "Coefficient"
        edge_type_scope: "SOLIDARITY only"
        formula_usage: "calculate_ideological_routing() branching condition"
        mlm_concept: "Without solidarity, crisis energy routes to fascism"
        example: 0.75

    indexes:
      - "CREATE INDEX idx_relationships_source ON relationships(source_id)"
      - "CREATE INDEX idx_relationships_target ON relationships(target_id)"
      - "CREATE INDEX idx_relationships_type ON relationships(edge_type)"
      - "CREATE UNIQUE INDEX idx_relationships_edge ON relationships(source_id, target_id, edge_type)"

    constraints:
      no_self_loops: "source_id != target_id"
      valid_source: "source_id EXISTS IN (social_classes.id UNION territories.id)"
      valid_target: "target_id EXISTS IN (social_classes.id UNION territories.id)"

    composite_key: "(source_id, target_id, edge_type)"

# =============================================================================
# PHYSICAL SCHEMA (SQLite DDL)
# =============================================================================

physical_schema:
  description: |
    SQLite CREATE TABLE specifications implementing the Logical Dictionary.
    Python float -> SQLite REAL mapping for all numeric types.
    All constraints enforced at database level for data integrity.

  database:
    name: "babylon.db"
    engine: "SQLite 3.x"
    encoding: "UTF-8"
    journal_mode: "WAL"
    foreign_keys: "ON"

  # ---------------------------------------------------------------------------
  # Table: social_classes
  # ---------------------------------------------------------------------------
  social_classes:
    ddl: |
      CREATE TABLE IF NOT EXISTS social_classes (
          -- Primary Key
          id TEXT PRIMARY KEY
              CHECK (id GLOB 'C[0-9][0-9][0-9]'),

          -- Metadata
          name TEXT NOT NULL
              CHECK (length(name) >= 1),
          role TEXT NOT NULL
              CHECK (role IN (
                  'core_bourgeoisie',
                  'periphery_proletariat',
                  'labor_aristocracy',
                  'petty_bourgeoisie',
                  'lumpenproletariat'
              )),
          description TEXT DEFAULT '',

          -- Material Base (Economic Component)
          wealth REAL DEFAULT 10.0
              CHECK (wealth >= 0.0),
          subsistence_threshold REAL DEFAULT 5.0
              CHECK (subsistence_threshold >= 0.0),

          -- IdeologicalProfile (George Jackson Refactor - Sprint 3.4.3)
          class_consciousness REAL DEFAULT 0.0
              CHECK (class_consciousness >= 0.0 AND class_consciousness <= 1.0),
          national_identity REAL DEFAULT 0.5
              CHECK (national_identity >= 0.0 AND national_identity <= 1.0),
          agitation REAL DEFAULT 0.0
              CHECK (agitation >= 0.0),

          -- Survival Calculus Outputs
          p_acquiescence REAL DEFAULT 0.0
              CHECK (p_acquiescence >= 0.0 AND p_acquiescence <= 1.0),
          p_revolution REAL DEFAULT 0.0
              CHECK (p_revolution >= 0.0 AND p_revolution <= 1.0),

          -- Material Conditions (Inputs to Survival Calculus)
          organization REAL DEFAULT 0.1
              CHECK (organization >= 0.0 AND organization <= 1.0),
          repression_faced REAL DEFAULT 0.5
              CHECK (repression_faced >= 0.0 AND repression_faced <= 1.0),

          -- Timestamps
          created_at TEXT DEFAULT (datetime('now')),
          updated_at TEXT DEFAULT (datetime('now'))
      );

    indexes: |
      -- Performance indexes
      CREATE INDEX IF NOT EXISTS idx_social_classes_role
          ON social_classes(role);
      CREATE INDEX IF NOT EXISTS idx_social_classes_wealth
          ON social_classes(wealth);
      CREATE INDEX IF NOT EXISTS idx_social_classes_consciousness
          ON social_classes(class_consciousness);

    triggers: |
      -- Auto-update timestamp on modification
      CREATE TRIGGER IF NOT EXISTS trg_social_classes_updated
          AFTER UPDATE ON social_classes
          FOR EACH ROW
          BEGIN
              UPDATE social_classes
              SET updated_at = datetime('now')
              WHERE id = NEW.id;
          END;

  # ---------------------------------------------------------------------------
  # Table: territories
  # ---------------------------------------------------------------------------
  territories:
    ddl: |
      CREATE TABLE IF NOT EXISTS territories (
          -- Primary Key
          id TEXT PRIMARY KEY
              CHECK (id GLOB 'T[0-9][0-9][0-9]'),

          -- Metadata
          name TEXT NOT NULL
              CHECK (length(name) >= 1),
          sector_type TEXT NOT NULL
              CHECK (sector_type IN (
                  'industrial',
                  'residential',
                  'commercial',
                  'university',
                  'docks',
                  'government'
              )),

          -- Ownership Stack (Host/Parasite)
          host_id TEXT
              REFERENCES social_classes(id)
              ON DELETE SET NULL
              ON UPDATE CASCADE,
          occupant_id TEXT
              REFERENCES social_classes(id)
              ON DELETE SET NULL
              ON UPDATE CASCADE,

          -- Operational Profile (Visibility Stance)
          profile TEXT DEFAULT 'low_profile'
              CHECK (profile IN ('low_profile', 'high_profile')),

          -- State Dynamics
          heat REAL DEFAULT 0.0
              CHECK (heat >= 0.0 AND heat <= 1.0),

          -- Economic Dynamics
          rent_level REAL DEFAULT 1.0
              CHECK (rent_level >= 0.0),

          -- Population Dynamics
          population INTEGER DEFAULT 0
              CHECK (population >= 0),

          -- Eviction State
          under_eviction INTEGER DEFAULT 0
              CHECK (under_eviction IN (0, 1)),

          -- Timestamps
          created_at TEXT DEFAULT (datetime('now')),
          updated_at TEXT DEFAULT (datetime('now'))
      );

    indexes: |
      -- Performance indexes
      CREATE INDEX IF NOT EXISTS idx_territories_sector
          ON territories(sector_type);
      CREATE INDEX IF NOT EXISTS idx_territories_heat
          ON territories(heat);
      CREATE INDEX IF NOT EXISTS idx_territories_host
          ON territories(host_id);
      CREATE INDEX IF NOT EXISTS idx_territories_occupant
          ON territories(occupant_id);
      CREATE INDEX IF NOT EXISTS idx_territories_profile
          ON territories(profile);

    triggers: |
      -- Auto-update timestamp on modification
      CREATE TRIGGER IF NOT EXISTS trg_territories_updated
          AFTER UPDATE ON territories
          FOR EACH ROW
          BEGIN
              UPDATE territories
              SET updated_at = datetime('now')
              WHERE id = NEW.id;
          END;

  # ---------------------------------------------------------------------------
  # Table: relationships
  # ---------------------------------------------------------------------------
  relationships:
    ddl: |
      CREATE TABLE IF NOT EXISTS relationships (
          -- Surrogate Primary Key
          id INTEGER PRIMARY KEY AUTOINCREMENT,

          -- Edge Endpoints (Composite Natural Key)
          source_id TEXT NOT NULL,
          target_id TEXT NOT NULL,
          edge_type TEXT NOT NULL
              CHECK (edge_type IN (
                  'exploitation',
                  'solidarity',
                  'repression',
                  'competition',
                  'tribute',
                  'wages',
                  'client_state',
                  'tenancy',
                  'adjacency'
              )),

          -- Value Flow
          value_flow REAL DEFAULT 0.0
              CHECK (value_flow >= 0.0),

          -- Relational State
          tension REAL DEFAULT 0.0
              CHECK (tension >= 0.0 AND tension <= 1.0),

          -- Metadata
          description TEXT DEFAULT '',

          -- Imperial Circuit Parameters (Sprint 3.4.1)
          subsidy_cap REAL DEFAULT 0.0
              CHECK (subsidy_cap >= 0.0),

          -- Solidarity Transmission (Sprint 3.4.2 - The Fascist Switch)
          solidarity_strength REAL DEFAULT 0.0
              CHECK (solidarity_strength >= 0.0 AND solidarity_strength <= 1.0),

          -- Timestamps
          created_at TEXT DEFAULT (datetime('now')),
          updated_at TEXT DEFAULT (datetime('now')),

          -- Constraints
          CHECK (source_id != target_id),  -- No self-loops

          -- Unique edge constraint (one edge per type between nodes)
          UNIQUE (source_id, target_id, edge_type)
      );

    indexes: |
      -- Performance indexes
      CREATE INDEX IF NOT EXISTS idx_relationships_source
          ON relationships(source_id);
      CREATE INDEX IF NOT EXISTS idx_relationships_target
          ON relationships(target_id);
      CREATE INDEX IF NOT EXISTS idx_relationships_type
          ON relationships(edge_type);
      CREATE INDEX IF NOT EXISTS idx_relationships_solidarity
          ON relationships(solidarity_strength)
          WHERE edge_type = 'solidarity';
      CREATE INDEX IF NOT EXISTS idx_relationships_value_flow
          ON relationships(value_flow)
          WHERE edge_type IN ('exploitation', 'wages', 'tribute');

    triggers: |
      -- Auto-update timestamp on modification
      CREATE TRIGGER IF NOT EXISTS trg_relationships_updated
          AFTER UPDATE ON relationships
          FOR EACH ROW
          BEGIN
              UPDATE relationships
              SET updated_at = datetime('now')
              WHERE id = NEW.id;
          END;

    notes:
      foreign_keys: |
        Foreign key constraints are intentionally omitted for source_id/target_id
        because they can reference either social_classes OR territories.
        Referential integrity is enforced at the application layer via Pydantic
        validation before database writes.
      composite_key: |
        The natural key is (source_id, target_id, edge_type).
        The surrogate key (id) is for ORM convenience and cascading deletes.

  # ---------------------------------------------------------------------------
  # Initialization Script
  # ---------------------------------------------------------------------------
  initialization_script: |
    -- Enable foreign key enforcement
    PRAGMA foreign_keys = ON;

    -- Enable WAL mode for concurrent reads
    PRAGMA journal_mode = WAL;

    -- Optimize for simulation workload
    PRAGMA synchronous = NORMAL;
    PRAGMA cache_size = -64000;  -- 64MB cache
    PRAGMA temp_store = MEMORY;

    -- Create tables
    -- (Include DDL from social_classes, territories, relationships above)

    -- Create indexes
    -- (Include indexes from each table above)

    -- Create triggers
    -- (Include triggers from each table above)

  # ---------------------------------------------------------------------------
  # Type Mapping Reference
  # ---------------------------------------------------------------------------
  python_to_sqlite_mapping:
    description: "How Python/Pydantic types map to SQLite storage"
    mappings:
      float: "REAL"
      int: "INTEGER"
      str: "TEXT"
      bool: "INTEGER (0/1)"
      datetime: "TEXT (ISO 8601)"
      Currency: "REAL CHECK >= 0.0"
      Probability: "REAL CHECK >= 0.0 AND <= 1.0"
      Intensity: "REAL CHECK >= 0.0 AND <= 1.0"
      Coefficient: "REAL CHECK >= 0.0 AND <= 1.0"
      Ideology: "REAL CHECK >= -1.0 AND <= 1.0"

# =============================================================================
# TYPE MAPPINGS
# =============================================================================

type_mappings:
  description: "Maps Pydantic constrained types to SQLite storage"

  domain_types:
    Currency:
      python: "Annotated[float, Field(ge=0.0)]"
      sqlite: "DECIMAL(18,4)"
      constraint: "CHECK >= 0"
      description: "Non-negative monetary value"

    Probability:
      python: "Annotated[float, Field(ge=0.0, le=1.0)]"
      sqlite: "DECIMAL(5,4)"
      constraint: "CHECK >= 0.0 AND <= 1.0"
      description: "Value in range [0, 1]"

    Intensity:
      python: "Annotated[float, Field(ge=0.0, le=1.0)]"
      sqlite: "DECIMAL(5,4)"
      constraint: "CHECK >= 0.0 AND <= 1.0"
      description: "Tension/heat level in range [0, 1]"

    Coefficient:
      python: "Annotated[float, Field(ge=0.0, le=1.0)]"
      sqlite: "DECIMAL(5,4)"
      constraint: "CHECK >= 0.0 AND <= 1.0"
      description: "Multiplier/factor in range [0, 1]"

    Ideology:
      python: "Annotated[float, Field(ge=-1.0, le=1.0)]"
      sqlite: "DECIMAL(5,4)"
      constraint: "CHECK >= -1.0 AND <= 1.0"
      description: "Legacy scalar ideology (deprecated by IdeologicalProfile)"

# =============================================================================
# MIGRATION NOTES
# =============================================================================

migration_notes:
  from_json_to_sqlite:
    description: |
      Current state: Data stored in JSON files (src/babylon/data/game/).
      Target state: SQLite database with this schema.
      Strategy: Incremental migration maintaining JSON as source of truth
      until SQLite layer is fully validated.

    phases:
      - name: "Schema Definition"
        status: "IN PROGRESS"
        tasks:
          - "Define logical data dictionary (this file)"
          - "Create SQLAlchemy models"
          - "Generate Alembic migrations"

      - name: "Dual Write"
        status: "PLANNED"
        tasks:
          - "Write to both JSON and SQLite"
          - "Validate consistency"
          - "Performance benchmarking"

      - name: "SQLite Primary"
        status: "PLANNED"
        tasks:
          - "Switch reads to SQLite"
          - "JSON becomes backup"
          - "Archive old JSON files"

  george_jackson_refactor:
    sprint: "3.4.3"
    change: |
      Replaced scalar ideology: float [-1, 1] with IdeologicalProfile:
      - class_consciousness: float [0, 1]
      - national_identity: float [0, 1]
      - agitation: float [0, inf)
    backward_compatibility: |
      IdeologicalProfile.from_legacy_ideology(float) converts old data.
      IdeologicalProfile.to_legacy_ideology() provides reverse mapping.

# =============================================================================
# QUERY PATTERNS
# =============================================================================

query_patterns:
  description: "Common query patterns for the Ledger layer"

  survival_calculus:
    description: "Find classes approaching rupture conditions"
    sql: |
      SELECT id, name, p_acquiescence, p_revolution
      FROM social_classes
      WHERE p_revolution > p_acquiescence
      ORDER BY (p_revolution - p_acquiescence) DESC

  imperial_rent_flow:
    description: "Sum total imperial rent extraction"
    sql: |
      SELECT SUM(value_flow) as total_rent
      FROM relationships
      WHERE edge_type = 'exploitation'

  hot_territories:
    description: "Find territories approaching eviction threshold"
    sql: |
      SELECT id, name, heat, profile
      FROM territories
      WHERE heat >= 0.7
      ORDER BY heat DESC

  solidarity_network:
    description: "Map solidarity infrastructure"
    sql: |
      SELECT source_id, target_id, solidarity_strength
      FROM relationships
      WHERE edge_type = 'solidarity'
        AND solidarity_strength > 0.0
      ORDER BY solidarity_strength DESC

  liberated_zones:
    description: "Find all liberated territories"
    sql: |
      SELECT id, name, occupant_id
      FROM territories
      WHERE occupant_id IS NOT NULL
        AND host_id IS NULL
