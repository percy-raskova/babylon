# Babylon Entity Reference
# All game entities and their relationships

meta:
  version: "2.0.0"
  updated: "2025-12-26"
  total_entity_types: 17
  schema_location: "src/babylon/schemas/entities/"
  data_location: "src/babylon/data/game/"
  epoch_compatibility: "1 → 2 Bridge"
  status: "APPROVED_ARCHITECTURE"

# =============================================================================
# EPOCH 2 BRIDGE: TRIPLE-LAYER TRAIT SYSTEM
# =============================================================================
# Structured extensibility for Epoch 2 properties without schema migrations
# SECOND REVISION: Replaces simple "tags" approach with typed layers

extensibility_system:
  name: "Triple-Layer Trait System"
  status: "APPROVED_ARCHITECTURE"
  epoch_compatibility: "1 → 2 Bridge"
  created: "2025-12-26"
  revision: 2

  rationale: |
    The simple "tags: Dict[str, Any]" approach was REJECTED because:
    1. No type safety - can't validate that formula inputs are floats
    2. No semantic distinction - mixing binary flags with numeric values
    3. Hard to query - no structured access patterns for SQL
    4. No namespace protection - easy to collide with engine internals

    The Triple-Layer solution provides:
    - Type safety per layer (Set[str], Dict[str, float], Dict[str, Any])
    - Clear semantic boundaries (identity, formulas, metadata)
    - Efficient SQL queries via JSON/JSONB
    - Reserved namespaces for engine and fog-of-war

  triple_layer_schema:
    principle: "Separate concerns by data type and usage pattern"

    layer_1_flags:
      name: "Flags"
      type: "Set[str]"
      default: "set()"
      purpose: "Binary states and categorical identity markers"
      validation:
        format: "UPPERCASE_WITH_UNDERSCORES"
        pattern: "^[A-Z][A-Z0-9_]*$"
      access_pattern: |
        if "HAS_CADRE" in entity.flags:
            apply_cadre_bonus()
      examples:
        categorical:
          - "URBAN"           # Territory type
          - "RURAL"           # Territory type
          - "INDUSTRIAL"      # Territory type
        state:
          - "HAS_CADRE"       # Cadre present in territory
          - "LOCKOUT_ACTIVE"  # C_pb has locked out workers
          - "STRIKE_READY"    # Workers prepared to strike
        identity:
          - "LABOR_ARISTOCRACY"  # Class is C_la
          - "LUMPEN"             # Class is L_u
          - "FASCIST_DRIFT"      # Moving toward fascism
        fog_of_war:
          - "MASKED"          # Data is falsified in shadow state
          - "APPROXIMATE"     # Data has noise in shadow state
          - "STALE"           # Intel is outdated
          - "HOSTILE"         # Territory hostile to player
          - "BASE_AREA"       # Revolutionary base territory

    layer_2_modifiers:
      name: "Modifiers"
      type: "Dict[str, float]"
      default: "{}"
      purpose: "Scalar values used directly in formulas"
      validation:
        key_format: "lowercase_with_underscores"
        value_type: "float"
        value_range: "Usually 0.0-1.0, but can be unbounded"
      access_pattern: |
        chauvinism = entity.modifiers.get("chauvinism", 0.0)
        defection_risk = sigmoid(chauvinism - discipline)
      examples:
        reactionary_subject:
          chauvinism: "Accumulated chauvinism debuff (0.0-1.0)"
          entitlement: "Investment in status quo (0.0-1.0)"
          fascist_alignment: "Progress toward fascist faction (0.0-1.0)"
          volatility: "Lumpen instability (0.0-1.0)"
        epistemic_horizon:
          mass_receptivity: "Willingness to share intel (0.0-1.0)"
          intel_confidence: "Accuracy of player's knowledge (0.0-1.0)"
          intel_decay_rate: "Decay rate per tick (float)"
        panopticon:
          security_rating: "State attention level (0.0-1.0)"
          surveillance_threads: "Allocated attention threads (int as float)"
          terror_index: "Accumulated terror from actions (unbounded)"
        kinetic_warfare:
          combat_readiness: "Unit combat effectiveness (0.0-1.0)"
          operational_security: "Resistance to detection (0.0-1.0)"
          blowback_accumulated: "Collateral damage consequences (unbounded)"
        metabolism:
          entropy: "Ecological rift accumulation (0.0-1.0)"
          biocapacity_modifier: "Adjustment to territory biocapacity"
        vanguard:
          cadre_discipline: "Quality of cadre leadership (0.0-1.0)"
          coherence_factor: "Organization transmission efficiency"
          reputation_local: "Local reputation modifier (-1.0 to 1.0)"

    layer_3_properties:
      name: "Properties"
      type: "Dict[str, Any]"
      default: "{}"
      purpose: "Unstructured metadata, references, display data"
      validation:
        key_format: "lowercase_with_underscores"
        value_type: "Any JSON-serializable value"
      access_pattern: |
        custom_name = entity.properties.get("custom_name", entity.name)
        doctrine = entity.properties.get("doctrine_alignment")
      examples:
        metadata:
          custom_name: "User-assigned name for display"
          description: "Extended description text"
          icon_override: "Custom icon path"
        references:
          doctrine_alignment: "Reference to doctrine tree node"
          faction_affiliation: "Reference to faction entity"
          territory_of_origin: "For displaced populations"
        history:
          last_action_tick: "Tick when last action was taken"
          creation_context: "How this entity was created"
        debug:
          test_scenario: "Which test scenario created this"
          notes: "Developer notes"

  reserved_namespaces:
    description: |
      Certain key prefixes are RESERVED and have special behavior.
      Do not use these prefixes for custom modifiers/properties.

    sys_prefix:
      prefix: "sys_"
      reserved_for: "Engine internals"
      behavior: "May be overwritten by engine, not for user modification"
      examples:
        - "sys_last_tick_updated"
        - "sys_creation_tick"
        - "sys_computed_hash"
        - "sys_validation_status"

    secret_prefix:
      prefix: "secret_"
      reserved_for: "Fog of War sensitive data"
      behavior: |
        AUTOMATICALLY FILTERED by FogOfWarSystem when generating PlayerShadowState.
        Only included if Intel_Confidence > threshold (typically 0.8).
        This is how we hide true values in Desert territory.
      examples:
        - "secret_true_agitation"      # Real agitation (masked shows false)
        - "secret_informant_count"     # Hidden informants in territory
        - "secret_militia_strength"    # True enemy strength
        - "secret_fascist_cell_size"   # Hidden reactionary organization
      fog_of_war_integration: |
        When PlayerShadowState is generated:
        1. Copy all flags, modifiers, properties
        2. For Desert (Intel_Confidence < 0.2):
           - REMOVE all secret_* entries
           - REPLACE with masked values
        3. For Mud (0.2 <= Intel_Confidence < 0.8):
           - REMOVE most secret_* entries
           - Some may leak through with noise
        4. For Water (Intel_Confidence >= 0.8):
           - INCLUDE secret_* entries (masses tell you everything)

  entity_mappings:
    description: "How specific entity types use the trait system"

    social_class:
      location: "src/babylon/models/entities/social_class.py"
      inherits_from: "BaseEntity"
      future_modifiers:
        chauvinism: |
          Tracks Fascist drift for Labor Aristocracy (C_la).
          Accumulated via super-wages and imperial benefit.
          Triggers defection when chauvinism > discipline during CRISIS.
          Source: ai-docs/reactionary-subject.yaml (Slice 2.3)
        entitlement: |
          Investment in status quo (C_pb and C_la).
          High entitlement + high agitation = fascist recruitment.
          Source: ai-docs/reactionary-subject.yaml (Slice 2.3)
        volatility: |
          Lumpenproletariat (L_u) instability.
          High volatility + low discipline = SPONTANEOUS_RIOT risk.
          Source: ai-docs/reactionary-subject.yaml (Slice 2.3)
        cadre_discipline: |
          Quality of cadre leadership in this class.
          Affects combat effectiveness and intel gathering.
          Source: ai-docs/vanguard-economy.yaml (Slice 2.6)
      future_flags:
        - "LABOR_ARISTOCRACY"
        - "LUMPEN"
        - "DEFECTION_RISK"
        - "FASCIST_DRIFT"
        - "GUERILLA_CAPABLE"

    territory:
      location: "src/babylon/models/entities/territory.py"
      inherits_from: "BaseEntity"
      future_modifiers:
        entropy: |
          Ecological rift accumulation.
          Increases when S_bio consumption exceeds regeneration.
          Triggers ECOLOGICAL_COLLAPSE at threshold.
          Source: ai-docs/metabolic-slice.yaml (Slice 1.4)
        mass_receptivity: |
          Willingness of local population to share intel.
          Calculated from P(S|A), ideological alignment, class factor.
          Determines vision state (Water/Mud/Desert).
          Source: ai-docs/fog-of-war.yaml (Slice 2.10)
        intel_confidence: |
          Accuracy of player's knowledge about this territory.
          Derived from base_observation + (cadre × mass_receptivity).
          Source: ai-docs/fog-of-war.yaml (Slice 2.10)
        security_rating: |
          State attention level on this territory.
          High security = high risk of SECURITY_BREACH.
          Source: ai-docs/state-attention-economy.yaml (Slice 2.9)
        fascist_alignment: |
          Progress of territory toward fascist control.
          When >= 1.0, territory joins Fascist faction.
          Source: ai-docs/reactionary-subject.yaml (Slice 2.3)
      future_flags:
        - "URBAN"
        - "RURAL"
        - "INDUSTRIAL"
        - "HAS_CADRE"
        - "CONTACT_NETWORK"
        - "BASE_AREA"
        - "HOSTILE"
        - "MASKED"
        - "UNDER_SURVEILLANCE"
        - "LOCKOUT_ACTIVE"

  debug_ui_integration:
    name: "Generic Trait Inspector"
    location: "Entity detail sidebar in Debug Dashboard"
    purpose: |
      The Debug UI (God View) displays all three layers with appropriate
      visualizations. This allows developers to inspect Epoch 2 properties
      during development and testing.

    render_patterns:
      flags:
        component: "Badges/Chips"
        style: "Colored pills, uppercase text"
        interaction: "Click to toggle, filter by flag"
        example: "[URBAN] [HAS_CADRE] [STRIKE_READY]"

      modifiers:
        component: "Progress Bars or Value Tags"
        style: "Horizontal bar with numeric value"
        interaction: "Editable for testing, color-coded by range"
        example: |
          chauvinism:      ████████░░ 0.78
          reactionary_lat: ██░░░░░░░░ 0.23
          volatility:      ████░░░░░░ 0.45

      properties:
        component: "Key-Value Text (collapsible)"
        style: "Monospace, JSON-like display"
        interaction: "Expandable, editable for testing"
        example: |
          custom_name: "Oakland Proletariat"
          doctrine_alignment: "insurrectionist"

    layout_diagram: |
      ┌─────────────────────────────────────────────────┐
      │ Entity: Oakland Proletariat (C_001)             │
      ├─────────────────────────────────────────────────┤
      │ FLAGS:                                          │
      │   [URBAN] [HAS_CADRE] [STRIKE_READY]           │
      ├─────────────────────────────────────────────────┤
      │ MODIFIERS:                                      │
      │   chauvinism:        ████████░░ 0.78           │
      │   entitlement:       ██████░░░░ 0.62           │
      │   volatility:        ████░░░░░░ 0.45           │
      │   cadre_discipline:  ███████░░░ 0.71           │
      ├─────────────────────────────────────────────────┤
      │ PROPERTIES:                                     │
      │   custom_name: "Oakland Proletariat"            │
      │   doctrine_alignment: "insurrectionist"         │
      │   last_action_tick: 42                          │
      └─────────────────────────────────────────────────┘

  implementation:
    location: "src/babylon/models/entities/base.py"
    changes:
      - "Add flags: Set[str] = Field(default_factory=set)"
      - "Add modifiers: Dict[str, float] = Field(default_factory=dict)"
      - "Add properties: Dict[str, Any] = Field(default_factory=dict)"
    helper_methods:
      has_flag: "def has_flag(self, flag: str) -> bool"
      add_flag: "def add_flag(self, flag: str) -> None"
      remove_flag: "def remove_flag(self, flag: str) -> None"
      get_modifier: "def get_modifier(self, key: str, default: float = 0.0) -> float"
      set_modifier: "def set_modifier(self, key: str, value: float) -> None"
      get_property: "def get_property(self, key: str, default: Any = None) -> Any"
      set_property: "def set_property(self, key: str, value: Any) -> None"
    validation:
      flags: "Must match ^[A-Z][A-Z0-9_]*$ pattern"
      modifiers: "Values must be float (or coercible to float)"
      properties: "Values must be JSON-serializable"
    migration: "None - additive only, existing entities get empty collections"
    backward_compatible: true

# =============================================================================
# ENTITY OVERVIEW
# =============================================================================

entities:

  character:
    id_pattern: "snake_case (e.g., persephone_raskova)"
    schema: "src/babylon/schemas/entities/character.schema.json"
    data: "src/babylon/data/game/characters.json"
    description: "Individual actors in the simulation"
    key_fields:
      - "faction: Faction membership"
      - "class_position: Their class"
      - "skills: Capabilities"
      - "beliefs: Ideological positions"
      - "relationships: Connections to other characters"
    relationships:
      - "belongs_to → Faction"
      - "located_in → Location"
      - "knows → Character"

  faction:
    id_pattern: "F001, F002, ..."
    schema: "src/babylon/schemas/entities/faction.schema.json"
    data: "src/babylon/data/game/factions.json"
    description: "Organized political forces"
    key_fields:
      - "class_composition: Which classes make up the faction"
      - "military_capacity: Armed capability"
      - "dialectical_relationships: Relations with other factions"
      - "ideology: Guiding ideology"
    relationships:
      - "controls → Location"
      - "allied_with/opposed_to → Faction"
      - "follows → Ideology"
      - "contains → Character"

  contradiction:
    id_pattern: "CON001, CON002, ..."
    schema: "src/babylon/schemas/entities/contradiction.schema.json"
    data: "src/babylon/data/game/contradictions.json"
    description: "Dialectical tensions driving change"
    key_fields:
      - "entities: The opposing forces"
      - "antagonism_type: antagonistic/non_antagonistic"
      - "intensity: Current sharpness"
      - "effects: What happens as intensity changes"
    relationships:
      - "involves → Entity (any type)"
      - "manifests_as → Crisis"
      - "intensified_by → Event"

  location:
    id_pattern: "L001, L001A, ..."
    schema: "src/babylon/schemas/entities/location.schema.json"
    data: "src/babylon/data/game/locations.json"
    description: "Geographic/political spaces"
    key_fields:
      - "coordinates: Lat/long"
      - "parent_location: Hierarchy"
      - "sub_locations: Children"
      - "controlling_faction: Who rules"
      - "resources: What's produced here"
    relationships:
      - "contains → Location (sub-locations)"
      - "produces → Resource"
      - "controlled_by → Faction"

  resource:
    id_pattern: "R001, R002, ..."
    schema: "src/babylon/schemas/entities/resource.schema.json"
    data: "src/babylon/data/game/resources.json"
    description: "Economic inputs and outputs"
    key_fields:
      - "category: Type of resource"
      - "scarcity: Abundance level"
      - "production: How it's made"
      - "consumption: Who uses it"
    relationships:
      - "produced_at → Location"
      - "consumed_by → Faction"
      - "required_for → Technology"

  technology:
    id_pattern: "T001, T002, ..."
    schema: "src/babylon/schemas/entities/technology.schema.json"
    data: "src/babylon/data/game/technologies.json"
    description: "Researchable capabilities"
    key_fields:
      - "category: Economic/Control/Liberation/Repression"
      - "prerequisites: Required prior tech"
      - "effects: What it enables"
      - "available_to_classes: Class restrictions"
      - "dialectical_contradictions: Internal tensions"
    relationships:
      - "requires → Technology (prerequisites)"
      - "unlocks → Technology"
      - "available_to → Class"
    note: "T006-T011 are LLM-related technologies"

  movement:
    id_pattern: "M001, M002, ..."
    schema: "src/babylon/schemas/entities/movement.schema.json"
    data: "src/babylon/data/game/movements.json"
    description: "Broad political currents (less organized than factions)"
    key_fields:
      - "goals: What they want"
      - "tactics: How they operate"
      - "challenges: What they face"
    relationships:
      - "supported_by → Class"
      - "opposed_by → Faction"
      - "may_crystallize_into → Faction"

  class:
    id_pattern: "C001 or snake_case (bourgeoisie, proletariat)"
    schema: "src/babylon/schemas/entities/class.schema.json"
    data: "src/babylon/data/game/classes.json"
    description: "Relation to means of production"
    key_fields:
      - "relation_to_production: Owner/seller/etc."
      - "interests: Material interests"
      - "ideology: IdeologicalProfile (multi-dimensional consciousness)"
    relationships:
      - "exploits → Class"
      - "exploited_by → Class"
      - "comprises → Faction (class composition)"

  ideological_profile:
    id_pattern: "Embedded in SocialClass.ideology"
    location: "src/babylon/models/entities/social_class.py"
    description: "Multi-dimensional consciousness model (Sprint 3.4.3 George Jackson Refactor)"
    key_fields:
      - "class_consciousness: Float [0, 1] - Vertical Axis (Capital vs Labor)"
      - "national_identity: Float [0, 1] - Horizontal Axis (Internationalist vs Nativist)"
      - "agitation: Float [0, ∞) - Energy magnitude from crisis"
    dynamics:
      crisis_routing: |
        When wages fall, agitation energy is generated.
        Agitation + Solidarity → class_consciousness increases (Revolution path)
        Agitation + No Solidarity → national_identity increases (Fascism path)
    formula: "calculate_ideological_routing(wage_change, solidarity_pressure, current_profile)"
    key_insight: "Fascism is the defensive form of capitalism."
    note: "Replaced scalar ideology: float [-1, 1] in Sprint 3.4.3"

  crisis:
    id_pattern: "CRISIS_001, CRISIS_002, ..."
    schema: "src/babylon/schemas/entities/crisis.schema.json"
    data: "src/babylon/data/game/crises.json"
    description: "Acute manifestations of contradictions"
    key_fields:
      - "type: Economic/political/legitimacy/ecological"
      - "severity: Intensity"
      - "triggers: What caused it"
      - "effects: Consequences"
    relationships:
      - "manifests → Contradiction"
      - "affects → Location"
      - "may_trigger → Revolt"

  policy:
    id_pattern: "Policy ID"
    schema: "src/babylon/schemas/entities/policy.schema.json"
    data: "src/babylon/data/game/policies.json"
    description: "Government/faction actions"
    key_fields:
      - "type: Economic/social/political"
      - "effects: What it does"
      - "support/opposition: Class reactions"

  institution:
    id_pattern: "Inst001, Inst002, ..."
    schema: "src/babylon/schemas/entities/institution.schema.json"
    data: "src/babylon/data/game/institutions.json"
    description: "Organized structures (state apparatus, civil society)"
    key_fields:
      - "type: State/civil/economic"
      - "function: What it does"
      - "controlled_by: Which class/faction"
    note: "Distinction between repressive and ideological apparatus"

  ideology:
    id_pattern: "IDE001, IDE002, ..."
    schema: "src/babylon/schemas/entities/ideology.schema.json"
    data: "src/babylon/data/game/ideologies.json"
    description: "Systems of belief and worldview"
    key_fields:
      - "core_beliefs: Central tenets"
      - "class_basis: Which class it serves"
    relationships:
      - "adopted_by → Faction"
      - "opposed_to → Ideology"

  culture:
    id_pattern: "CUL001, CUL002, ..."
    schema: "src/babylon/schemas/entities/culture.schema.json"
    data: "src/babylon/data/game/cultures.json"
    description: "Cultural groups and practices"
    key_fields:
      - "traditions: Cultural practices"
      - "values: Core values"

  law:
    id_pattern: "LAW001, LAW002, ..."
    schema: "src/babylon/schemas/entities/law.schema.json"
    data: "src/babylon/data/game/laws.json"
    description: "Legal framework elements"
    key_fields:
      - "type: Constitutional/criminal/economic"
      - "effects: What it enforces"
      - "class_bias: Who benefits"

  revolt:
    id_pattern: "Revolt ID"
    schema: "src/babylon/schemas/entities/revolt.schema.json"
    data: "src/babylon/data/game/revolts.json"
    description: "Uprising events"
    key_fields:
      - "participants: Who's involved"
      - "demands: What they want"
      - "outcome: Success/failure/ongoing"
    relationships:
      - "triggered_by → Crisis"
      - "led_by → Faction/Movement"
      - "occurs_in → Location"

  relationship:
    id_pattern: "Relationship ID"
    schema: "src/babylon/schemas/entities/relationship.schema.json"
    data: "src/babylon/data/game/relationships.json"
    description: "Connections between entities"
    key_fields:
      - "source/target: Linked entities"
      - "type: Nature of relationship"
      - "strength: Intensity"
    note: "Meta-entity describing other entity connections"

  sentiment:
    id_pattern: "Sentiment ID"
    schema: "src/babylon/schemas/entities/sentiment.schema.json"
    data: "src/babylon/data/game/sentiments.json"
    description: "Public opinion patterns"
    key_fields:
      - "type: Pro/anti various positions"
      - "magnitude: Strength"
      - "region: Where"
    note: "Currently unpopulated - planned feature"

# =============================================================================
# ENTITY RELATIONSHIPS GRAPH
# =============================================================================

relationship_overview:
  note: "Simplified view of how entities connect"
  graph: |
    Character ─belongs_to→ Faction ─controls→ Location
        │                     │                   │
        └──located_in────────┘                   │
                              │                   │
                              ├─follows→ Ideology │
                              │                   │
                              ├─opposes→ Faction  │
                              │                   │
    Class ─comprises────────→─┤                   │
                              │                   │
    Movement ─may_become────→─┘                   │
                                                  │
    Resource ←──produces──────────────────────────┘
        │
        └─required_for→ Technology

    Contradiction ─involves→ [any entity]
        │
        └─manifests_as→ Crisis ─triggers→ Revolt

# =============================================================================
# COMMON QUERIES
# =============================================================================

common_queries:

  find_faction_by_id:
    pattern: "factions.json → filter by id"

  get_location_resources:
    pattern: "locations.json → location.resources[]"

  find_contradictions_involving:
    pattern: "contradictions.json → filter entities[] contains target"

  tech_tree_traversal:
    pattern: "technologies.json → follow prerequisites chains"

  class_composition_of_faction:
    pattern: "factions.json → faction.class_composition[]"
