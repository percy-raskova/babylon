# Epoch 2: Data Infrastructure Specification

meta:
  epoch: 2
  slice: "2.1-2.4"
  status: COMPLETE
  purpose: "3NF database schema and API loaders for real-world data"

schema:
  location: "src/babylon/data/normalize/schema.py"

  dimensions:
    - DimState: "50 US states + territories"
    - DimCounty: "3,200+ counties via 5-digit FIPS"
    - DimMetroArea: "MSA/CSA codes"
    - DimIndustry: "NAICS codes"
    - DimCommodity: "HS codes for trade"
    - DimCoerciveType: "Prison, police, military categories"
    - DimDataSource: "Provenance tracking"

  facts:
    - FactEmployment: "QCEW employment by county/industry"
    - FactGDP: "FRED GDP time series"
    - FactEnergy: "EIA energy production/consumption"
    - FactTrade: "Census trade flows"
    - FactCoerciveInfrastructure: "Prison beds, police stations"
    - FactBroadbandCoverage: "FCC broadband metrics"
    - FactElectricGrid: "Substations, transmission lines"

loader_infrastructure:
  api_loader_base:
    location: "src/babylon/data/api_loader_base.py"
    used_by:
      - "census/loader_3nf.py"
      - "cfs/loader.py"
      - "fred/loader_3nf.py"
      - "energy/loader_3nf.py"
      - "qcew/loader_3nf.py"
    notes:
      - "Shared API client lifecycle helpers"
  load_stats:
    location: "src/babylon/data/loader_base.py"
    fields:
      api_errors: "Structured API error records (status_code, url, context)"
      ingest_breakdown: "Detailed ingest counters keyed by loader/table/year"
    notes:
      - "Used for troubleshooting and ingest auditing"

database_paths:
  normalized_default: "data/sqlite/marxist-data-3NF.sqlite"
  normalized_override_env: "BABYLON_NORMALIZED_DB_PATH"
  notes:
    - "Relative paths resolve from repo root"
    - "Use for parallel build databases"

loaders:
  complete:
    - census_qcew: "Quarterly Census of Employment & Wages"
    - census_cbp: "County Business Patterns"
    - census_acs: "American Community Survey (income, demographics, race)"
    - fred: "Federal Reserve Economic Data"
    - energy: "EIA energy statistics"
    - trade: "Census foreign trade"
    - materials: "USGS materials flow"
    - hifld_prisons: "DHS prison boundaries"
    - hifld_police: "DHS law enforcement locations"
    - hifld_electric: "DHS electric grid"
    - mirta: "DoD military installations"
    - fcc: "FCC broadband coverage"

  deferred:
    - census_cfs: "Commodity Flow Survey - needs geographic hierarchy"

api_keys:
  required:
    - name: CENSUS_API_KEY
      registration: "https://api.census.gov/data/key_signup.html"
      used_by: [census_qcew, census_cbp, census_acs]
    - name: FRED_API_KEY
      registration: "https://fred.stlouisfed.org/docs/api/api_key.html"
      used_by: [fred]
    - name: ENERGY_API_KEY
      registration: "https://www.eia.gov/opendata/register.php"
      used_by: [energy]
  optional:
    - name: FCC credentials
      notes: "Username/password for apps2.fcc.gov bulk download"

see_also:
  - "census-data-loader.yaml: ACS loader with DimRace, DimMetroArea"
  - "fred-api.yaml: FRED API patterns and rate limits"
  - "data-quality.yaml: Error handling and validation patterns"

cli_commands:
  - "mise run data:load --loaders=census,fred,energy"
  - "mise run data:hifld-prisons"
  - "mise run data:fcc-download && mise run data:fcc"
