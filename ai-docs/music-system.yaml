# Babylon Music System
# Procedural MIDI soundtrack generation

metadata:
  updated: 2025-12-09
  status: experimental
  phase: 3

# =============================================================================
# OVERVIEW
# =============================================================================
#
# Babylon uses procedural MIDI generation to create thematic music that
# reflects the game's MLM-TW theoretical framework. Each piece encodes
# dialectical concepts through musical structure.
#
# Philosophy: Music is ideology made audible. The soundtrack should make
# players FEEL the theory before they understand it intellectually.

# =============================================================================
# TECHNOLOGY STACK
# =============================================================================

dependencies:
  midiutil: "1.2.1"  # Core MIDI file generation
  description: |
    MIDIFile class provides low-level MIDI file creation.
    No external synthesizers required - outputs standard .mid files.
    Players use system MIDI playback or DAW software.

playback_options:
  - fluidsynth: "Command-line synthesizer, requires SoundFont"
  - vlc: "Plays MIDI directly (quality varies)"
  - daw: "Import into any DAW for high-quality rendering"
  - browser: "Web MIDI API for in-game playback"

# =============================================================================
# GENERATION PATTERN
# =============================================================================

file_structure:
  location: "tools/generate_*.py"
  output: "assets/music/*.mid"

code_pattern: |
  # 1. Define constants
  TEMPO = 76          # BPM - narrative meaning in tempo choice
  TOTAL_BARS = 32     # Structure length

  # 2. Define MIDI channels (one per instrument voice)
  CH_PIANO = 0
  CH_BASS = 1
  # ... etc

  # 3. Define GM program numbers
  PROG_PIANO = 0      # General MIDI instrument codes
  PROG_CELLO = 42

  # 4. Define scale/mode as named note constants
  D2, E2, F2, G2 = 38, 40, 41, 43   # MIDI note numbers

  # 5. Create MIDIFile with track count
  midi = MIDIFile(4, deinterleave=False)

  # 6. Configure tracks
  midi.addTrackName(CH_PIANO, 0, "Piano - Observer")
  midi.addTempo(CH_PIANO, 0, TEMPO)
  midi.addProgramChange(CH_PIANO, CH_PIANO, 0, PROG_PIANO)

  # 7. Add notes with: addNote(track, channel, pitch, time, duration, velocity)
  midi.addNote(CH_PIANO, CH_PIANO, D4, time=0, duration=1, velocity=80)

  # 8. Write file
  with open(output_path, "wb") as f:
      midi.writeFile(f)

# =============================================================================
# THEORETICAL FRAMEWORK
# =============================================================================

musical_dialectics:
  description: |
    Each musical element maps to a theoretical concept.
    The music should embody contradictions, not just accompany gameplay.

  mappings:
    instruments:
      piano: "The Observer - documenting, commenting, witnessing"
      cello_bass: "The Material Base - extraction, economic foundation"
      strings: "The Masses - class consciousness, collective movement"
      brass: "The State Apparatus - repression, coercion, violence"
      organ: "False Grandeur - ideological mystification"
      harpsichord: "The Machine - cold bureaucracy, surveillance"
      timpani: "The Clock - time, inevitability, the march of history"

    modes_and_keys:
      d_minor: "Melancholy, determination - the worker's struggle"
      d_dorian: "Hope within darkness - the raised 6th suggests possibility"
      e_phrygian: "Dread, otherness - the flat 2nd is pure anxiety"
      tritone: "The devil's interval - unresolved contradiction"

    tempo:
      slow_70s: "Inevitability, the grinding pace of exploitation"
      medium_100s: "Anxiety, barely-controlled panic"
      fast_120s: "Crisis, rupture, revolutionary moment"

    dynamics:
      crescendo: "Consciousness rising, organization building"
      decrescendo: "Co-optation, defeat, exhaustion"
      sforzando: "State violence, sudden repression"
      pianissimo: "The periphery, distant hope, survival"

# =============================================================================
# EXISTING THEMES
# =============================================================================

themes:
  phi_imperial_rent:
    file: "babylon_theme_phi.mid"
    generator: "tools/generate_theme.py"
    concept: "Φ > 0 - Imperial Rent flows from periphery to core"
    duration: "~1:41"
    tempo: 76
    key: "D minor / Dorian"
    tracks:
      - name: "Piano - Observer"
        program: 0
        role: "Documents history, sparse commentary"
      - name: "Cello - Material Base"
        program: 42
        role: "Relentless ostinato - extraction never stops"
      - name: "Strings - The Masses"
        program: 48
        role: "Melody emerges, reaches upward, is pushed down"
      - name: "Brass - State Apparatus"
        program: 61
        role: "Distant threat, then overwhelming repression"

    structure:
      - section: "A - The Material Base"
        bars: "1-8"
        description: "Deep bass ostinato establishes extraction cycle"
        musical_idea: "D-A-D-F pattern = imperial rent loop"

      - section: "B - Consciousness Stirs"
        bars: "9-16"
        description: "Strings melody emerges, tentative, questioning"
        musical_idea: "Dorian mode B natural = hope; falls back to minor"

      - section: "C - The Contradiction Sharpens"
        bars: "17-24"
        description: "Dissonance increases, brass responds with force"
        musical_idea: "Tritone (Ab against D) = peak contradiction"

      - section: "D - Resolution?"
        bars: "25-32"
        description: "Co-optation, but distant echo remains"
        musical_idea: "Ends on dominant (A) = unresolved, waiting"

  panopticon:
    file: "babylon_theme_panopticon.mid"
    generator: "tools/generate_fascist_theme.py"
    concept: "Anxious evil - the exhaustion of maintaining oppression"
    duration: "~1:29"
    tempo: 108
    key: "E Phrygian"
    tracks:
      - name: "Harpsichord - The Machine"
        program: 6
        role: "Cold baroque patterns, surveillance pings"
      - name: "Strings - Anxiety"
        program: 44  # Tremolo strings
        role: "Constant underlying tension, never rests"
      - name: "Brass - State Violence"
        program: 61
        role: "Sudden stabs, overwhelming force"
      - name: "Timpani - The Clock"
        program: 47
        role: "Relentless ticking, the jackboot rhythm"
      - name: "Organ - False Grandeur"
        program: 19
        role: "Hollow majesty masking the void"

    structure:
      - section: "A - The Apparatus"
        bars: "1-8"
        description: "Machine state established - ticking, watching"
        musical_idea: "Mechanical 8th notes, surveillance pings"

      - section: "B - The Juggling"
        bars: "9-20"
        description: "Multiple plates spinning, irregular meters"
        musical_idea: "7/8 and 5/4 feels = barely controlled chaos"

      - section: "C - The Mirror"
        bars: "21-28"
        description: "Self-awareness - staring into what they are"
        musical_idea: "Chromatic descent = looking into the abyss"

      - section: "D - The Void / Return"
        bars: "29-40"
        description: "Near-collapse, then desperate reassertion"
        musical_idea: "Silence threatens, machine restarts frantically"

# =============================================================================
# PLANNED THEMES
# =============================================================================

planned:
  workers_anthem:
    concept: "Solidarity rising - from atomization to organization"
    key: "C major → G major (circle of fifths = building)"
    instruments: ["Accordion", "Brass ensemble", "Snare drum"]
    structure: "Fragmented → unison → polyphony → triumphant"

  bourgeois_waltz:
    concept: "Elegant decay - Viennese sophistication hiding rot"
    key: "A major with chromatic slides"
    instruments: ["Strings", "Harp", "Clarinet"]
    structure: "Beautiful → dissonant → beautiful (denial)"

  crisis_event:
    concept: "Rupture - when P(S|R) > P(S|A)"
    key: "Polytonal / Atonal"
    instruments: ["Full orchestra", "Prepared piano"]
    structure: "Chaos → silence → single voice emerges"

  periphery_lament:
    concept: "The global south - exploitation made musical"
    key: "Modal (Mixolydian, Lydian)"
    instruments: ["Oud", "Strings", "Frame drum"]
    structure: "Traditional melody crushed by industrial sounds"

  menu_ambient:
    concept: "The world map - history breathing"
    key: "Ambiguous (drone-based)"
    instruments: ["Synth pad", "Distant strings", "Radio static"]
    structure: "Non-linear, generative, responds to game state"

# =============================================================================
# DYNAMIC MUSIC SYSTEM (Future)
# =============================================================================

dynamic_layers:
  description: |
    Future system: Music changes based on game state.
    Layers fade in/out based on tension, ideology, events.

  proposed_layers:
    base: "Always playing - the material base drone"
    consciousness: "Fades in as worker ideology drifts left"
    repression: "Brass swells when state apparatus strengthens"
    hope: "Dorian mode shifts when organization increases"
    crisis: "Dissonance builds as tension approaches rupture"

  triggers:
    - condition: "tension > 0.7"
      action: "Add tritone bass layer"
    - condition: "ideology < -0.5"  # Revolutionary
      action: "Strings melody becomes prominent"
    - condition: "rupture_event"
      action: "Full crisis theme, then silence"

# =============================================================================
# GENERATION GUIDELINES
# =============================================================================

composition_rules:
  theoretical_consistency:
    - "Every musical choice must have theoretical justification"
    - "Instruments = class actors, not just timbres"
    - "Key/mode = emotional-political state"
    - "Structure = dialectical movement"

  technical_rules:
    - "Use General MIDI programs for portability"
    - "Velocity 0-127 maps to dynamics"
    - "Time in beats (quarter notes)"
    - "Channel = Track for simplicity"
    - "Named note constants for readability"

  avoid:
    - "Happy resolutions (the contradictions continue)"
    - "Triumphalist endings (no permanent victories)"
    - "Pure chaos without structure (dialectics has logic)"
    - "Pastiche without meaning (every note must work)"

# =============================================================================
# COMMANDS
# =============================================================================

commands:
  generate_phi: "poetry run python tools/generate_theme.py"
  generate_panopticon: "poetry run python tools/generate_fascist_theme.py"
  play_with_fluidsynth: "fluidsynth -a alsa /usr/share/sounds/sf2/FluidR3_GM.sf2 assets/music/*.mid"
  convert_to_wav: "fluidsynth -F output.wav /path/to/soundfont.sf2 input.mid"
