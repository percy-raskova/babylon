# Babylon Observer Layer Specification
# Machine-readable spec for the TopologyMonitor (Condensation Monitor)
# Implements percolation theory for phase transition detection

meta:
  version: "1.1.0"
  created: "2025-12-11"
  updated: "2025-12-12"
  purpose: "Document the Observer system that tracks solidarity network condensation and emits phase transition events"
  principle: "Graph + Math = History. No emotions, only topology."
  status: "COMPLETE"
  location: "src/babylon/engine/topology_monitor.py"
  tests: "tests/unit/topology/ (57 tests: 32 monitor + 25 phase transition)"
  sprint: "Sprint 3.3 - Phase Transition Events"
  audit_note: "Updated for Sprint 3.3 - PhaseTransitionEvent emission (2025-12-12)"

# =============================================================================
# NARRATIVE VOICE: THE BONDI ALGORITHM
# =============================================================================
# STATUS: DESIGN ONLY - No LLM integration implemented yet.
# The TopologyMonitor logs to Python logging, not to an LLM narrative generator.
# This section documents the intended voice when LLM integration is added.

narrative_voice:
  name: "The Bondi Algorithm"
  implementation_status: "DESIGN ONLY - awaiting LLM integration (Sprint 3.3+)"
  principle: |
    The Observer speaks with the cold, mechanical precision of a machine
    deciding who to arrest. No emotional language. No softening. Pure
    topological analysis delivered with algorithmic detachment.

  aesthetic: |
    The horror of state repression is amplified, not diminished, by
    clinical language. A machine cataloging human beings for elimination
    is more terrifying than angry rhetoric.

  bad_example:
    text: "The police are cracking down on protesters."
    problem: "Too vague, too emotional, too human."

  good_example:
    text: |
      High-centrality nodes identified. Degree centrality > 0.4.
      Executing targeted removal. Network fragmentation imminent.
      Probability of survival: 12%.
    principle: "Cold topology. Pure math. The machine doesn't hate - it calculates."

  vocabulary:
    avoid:
      - "cracking down"
      - "brutal"
      - "oppressive"
      - "fighting back"
      - "heroic resistance"
    prefer:
      - "targeted removal"
      - "network fragmentation"
      - "high-centrality nodes"
      - "percolation threshold"
      - "giant component"
      - "resilience test failed"
      - "probability of survival"

# =============================================================================
# NARRATIVE TEMPLATES
# =============================================================================

narrative_templates:
  gaseous_state:
    trigger: "percolation_ratio < 0.1"
    template: |
      STATE: Gaseous. Movement is atomized.
      Components: {num_components}. Max cluster: {max_component_size}.
      Percolation ratio: {percolation_ratio:.3f}. Below critical threshold.
      Assessment: No coordination capacity. Individual nodes isolated.

  phase_shift:
    trigger: "percolation_ratio crosses 0.5 from below"
    template: |
      PHASE SHIFT: Condensation detected.
      Giant component formed. L_max = {max_component_size} ({percolation_ratio:.1%} of network).
      Critical mass achieved. Vanguard Party crystallized from gaseous leftism.
      Warning: Coordination capacity now exceeds state disruption threshold.

  brittle_warning:
    trigger: "potential_liquidity > 2 * actual_liquidity"
    template: |
      WARNING: Network topology brittle.
      Potential edges: {potential_liquidity}. Actual edges: {actual_liquidity}.
      Sympathizer-to-cadre ratio exceeds safe threshold.
      Assessment: Broad but shallow. Lacks organizational discipline.
      Vulnerability: Single-point failures will cascade.

  sword_of_damocles:
    trigger: "resilience_test returns False"
    template: |
      ALERT: Sword of Damocles active.
      Resilience test FAILED. Removal of {removal_rate:.0%} nodes destroys giant component.
      Post-purge L_max: {post_purge_max_component} (was {original_max_component}).
      Assessment: Movement vulnerable to targeted decapitation.
      Recommendation: Redundant leadership structures required.

  purge_simulation:
    context: "When describing state repression capabilities"
    template: |
      PURGE SIMULATION: Executing Bondi Algorithm.
      Identifying high-centrality nodes. Degree threshold: 0.4.
      Nodes flagged for removal: {num_targets}.
      Projected network state post-purge:
        - Components: {post_components}
        - Max cluster: {post_max}
        - Coordination capacity: {capacity_pct:.0%} of original.
      Probability of movement survival: {survival_pct:.0%}.

# =============================================================================
# THEORETICAL FOUNDATION: PERCOLATION THEORY
# =============================================================================

theory:
  name: "Percolation Theory for Revolutionary Consciousness"

  gaseous_state:
    definition: "Many small, disconnected components"
    characteristic: "No giant component (L_max < 50% of N)"
    political_meaning: |
      Atomized leftism. Individual cells operate in isolation.
      No capacity for coordinated action. Vulnerable to targeted repression.
      State can eliminate nodes without cascade effects.

  liquid_state:
    definition: "Giant component spans majority of network"
    characteristic: "L_max >= 50% of N (percolation threshold crossed)"
    political_meaning: |
      Vanguard Party formation. Consciousness can propagate through network.
      Coordinated action possible. Removal of individual nodes does not
      destroy organizational capacity.

  phase_transition:
    definition: "The tick where percolation ratio crosses 0.5"
    characteristic: "Sudden, non-linear shift in network properties"
    political_meaning: |
      The moment of crystallization. Gaseous leftism condenses into
      organized revolutionary force. Like water freezing - gradual
      temperature drop, sudden phase change.

  resilience:
    definition: "Survival of giant component after targeted node removal"
    test: "Remove 20% of nodes. Does L_max survive at 40% of original?"
    political_meaning: |
      Can the movement survive decapitation? Star topology (charismatic
      leader) is fragile. Mesh topology (distributed leadership) is
      resilient. The test simulates state repression capabilities.

# =============================================================================
# METRICS REFERENCE
# =============================================================================

metrics:
  num_components:
    type: int
    description: "Number of disconnected subgraphs in solidarity network"
    interpretation: "Higher = more atomized. Lower = more unified."

  max_component_size:
    symbol: "L_max"
    type: int
    description: "Size of largest connected component"
    interpretation: "The giant component. The organizational core."

  percolation_ratio:
    formula: "L_max / N"
    type: Probability
    thresholds:
      gaseous: "< 0.1"
      transitional: "0.1 - 0.5"
      liquid: ">= 0.5"
    interpretation: "Giant component dominance over total network."

  potential_liquidity:
    threshold: "SOLIDARITY edges > 0.1"
    type: int
    description: "Sympathizer network size"
    interpretation: "Broad support base. May lack depth."

  actual_liquidity:
    threshold: "SOLIDARITY edges > 0.5"
    type: int
    description: "Cadre network size"
    interpretation: "Committed organizational core. The steel."

  is_resilient:
    type: bool
    test: "20% node removal, 40% survival threshold"
    interpretation: "Can movement survive targeted repression?"

# =============================================================================
# EVENT EMISSION (Sprint 3.3)
# =============================================================================

event_emission:
  status: "COMPLETE (Sprint 3.3)"
  event_type: "PhaseTransitionEvent"
  enum: "EventType.PHASE_TRANSITION"

  phase_states:
    gaseous:
      threshold: "percolation_ratio < 0.1"
      meaning: "Atomized leftism, no coordination capacity"
    transitional:
      threshold: "0.1 <= percolation_ratio < 0.5"
      meaning: "Emerging structure, unstable"
    liquid:
      threshold: "percolation_ratio >= 0.5"
      meaning: "Giant component, vanguard formation"

  emission_mechanism:
    description: |
      TopologyMonitor tracks phase state across ticks. When percolation_ratio
      crosses a threshold boundary (gaseous ↔ transitional ↔ liquid), a
      PhaseTransitionEvent is created and stored in _pending_events.

      The Simulation facade calls get_pending_events() after notify_observers_tick(),
      collecting all observer events and storing them in persistent_context['_observer_events'].

      On the NEXT tick, simulation_engine.step() reads these events from
      persistent_context and appends them to the WorldState.events list.

    key_insight: |
      Observer events appear in the NEXT tick's WorldState because observers
      run AFTER the WorldState is frozen for the current tick. This is correct
      behavior - the phase transition is detected AFTER the tick that caused it.

  internal_state:
    _previous_phase: "str | None - tracks last known phase for transition detection"
    _pending_events: "list[SimulationEvent] - events awaiting collection"

  methods:
    _classify_phase:
      signature: "_classify_phase(percolation_ratio: float) -> str"
      returns: "'gaseous' | 'transitional' | 'liquid'"
    get_pending_events:
      signature: "get_pending_events() -> list[SimulationEvent]"
      behavior: "Returns and clears the pending events list"

  integration_points:
    simulation_facade:
      method: "_collect_observer_events()"
      location: "src/babylon/engine/simulation.py"
      description: "Collects events from all observers with get_pending_events()"
    simulation_engine:
      method: "step()"
      location: "src/babylon/engine/simulation_engine.py"
      description: "Reads persistent_context['_observer_events'] and appends to WorldState.events"

# =============================================================================
# IMPLEMENTATION NOTES
# =============================================================================

implementation:
  observer_protocol:
    interface: "SimulationObserver"
    methods:
      - "on_simulation_start(initial_state, config)"
      - "on_tick(previous_state, new_state)"
      - "on_simulation_end(final_state)"
    constraint: "Observer MUST NOT mutate simulation state"

  resilience_interval:
    default: 5
    meaning: "Run purge simulation every N ticks"
    value_zero: "Disabled - no resilience testing"
    rationale: "Expensive operation, not needed every tick"

  graph_extraction:
    input: "WorldState.to_graph() -> nx.DiGraph"
    output: "nx.Graph (undirected) for component analysis"
    filter: "Only SOLIDARITY edges, only social_class nodes"
    rationale: "Territory nodes are spatial substrate, not solidarity network"

# =============================================================================
# METRICS COLLECTOR (Sprint 4.1)
# =============================================================================
# Unified metrics collection for dashboard and parameter sweeper integration

metrics_collector:
  status: "COMPLETE (Sprint 4.1)"
  location: "src/babylon/engine/observers/metrics.py"
  models: "src/babylon/models/metrics.py"
  tests: "tests/unit/engine/observers/test_metrics_collector.py, tests/unit/models/test_metrics_models.py (101 tests)"
  commits: ["1f338ce", "f6beb27", "87cbaf7"]
  purpose: |
    Unified metrics collection between the parameter sweeper and dashboard.
    Eliminates duplicate metrics logic by providing a single observer that
    both systems can consume.

  modes:
    interactive:
      description: "Rolling window of recent ticks for dashboard"
      window_size: 50  # Matches TrendPlotter.MAX_POINTS
      storage: "collections.deque(maxlen=50)"
    batch:
      description: "Accumulates all history for parameter sweeps"
      storage: "list[TickMetrics]"

  data_models:
    EntityMetrics:
      purpose: "Metrics snapshot for single entity"
      fields:
        - "wealth: Currency"
        - "consciousness: Probability"
        - "national_identity: Probability"
        - "agitation: Probability"
        - "p_acquiescence: Probability"
        - "p_revolution: Probability"
        - "organization: Probability"

    EdgeMetrics:
      purpose: "Metrics snapshot for relationships"
      fields:
        - "exploitation_tension: Probability"
        - "exploitation_rent: Currency"
        - "tribute_flow: Currency"
        - "wages_paid: Currency"
        - "solidarity_strength: Probability"

    TickMetrics:
      purpose: "Complete snapshot for single tick"
      fields:
        - "tick: int"
        - "p_w: EntityMetrics | None (Periphery Worker C001)"
        - "p_c: EntityMetrics | None (Comprador C002)"
        - "c_b: EntityMetrics | None (Core Bourgeoisie C003)"
        - "c_w: EntityMetrics | None (Labor Aristocracy C004)"
        - "edges: EdgeMetrics"
        - "imperial_rent_pool: Currency"
        - "global_tension: Probability"

    SweepSummary:
      purpose: "Aggregated stats for parameter sweep"
      fields:
        - "ticks_survived: int"
        - "outcome: Literal['SURVIVED', 'DIED', 'ERROR']"
        - "final_*_wealth: Currency (all 4 classes)"
        - "max_tension: Probability"
        - "crossover_tick: int | None (first P(S|R) > P(S|A))"
        - "cumulative_rent: Currency"
        - "peak_*_consciousness: Probability"

  key_methods:
    on_simulation_start: "Clears history, records initial state (tick 0)"
    on_tick: "Records new state snapshot"
    latest: "Property returning most recent TickMetrics"
    history: "Property returning list[TickMetrics]"
    summary: "Property computing SweepSummary from history"
    to_csv_rows: "Export for parameter_analysis.py CSV output"

  entity_mapping:
    C001: "p_w (Periphery Worker)"
    C002: "p_c (Comprador)"
    C003: "c_b (Core Bourgeoisie)"
    C004: "c_w (Labor Aristocracy)"

  dashboard_integration:
    location: "src/babylon/ui/main.py"
    pattern: |
      MetricsCollector registered as observer on Simulation.
      Dashboard polls collector.latest for real-time metrics.
      Falls back to direct WorldState access if collector has no data yet.
    components_using:
      - "TrendPlotter: metrics.imperial_rent_pool, metrics.global_tension"
      - "StateInspector: direct state access for full entity view"
      - "ControlDeck: state.tick from runner"

  # ---------------------------------------------------------------------------
  # METRICS AUDIT (2025-12-25)
  # ---------------------------------------------------------------------------
  # Comprehensive comparison of MetricsCollector vs available codebase data

  audit:
    date: "2025-12-25"
    status: "PHASE 4.1B COMPLETE"
    coverage_estimate: "~85% of meaningful metrics captured"
    phase_4_1b_completion:
      date: "2025-12-25"
      commits: ["96e6292", "5665520", "3b92753"]
      tests_added: 43
      total_tests: 144

    what_is_tracked:
      entity_metrics:
        fields:
          - "wealth, consciousness, national_identity, agitation"
          - "p_acquiescence, p_revolution, organization"
        note: "7 fields per entity, correctly aligned with parameter_analysis.py"
      edge_metrics:
        fields:
          - "exploitation_tension, exploitation_rent, tribute_flow"
          - "wages_paid, solidarity_strength"
        note: "5 fields, sparse by design (one value per edge type)"
      global_metrics:
        fields:
          - "tick, imperial_rent_pool, global_tension"

    critical_gaps:
      description: "Dashboard incomplete without these metrics"
      status: "FIXED IN PHASE 4.1B"
      items:
        current_super_wage_rate:
          source: "GlobalEconomy.current_super_wage_rate"
          type: "Coefficient"
          why_critical: "Core driver of labor aristocracy loyalty - why C_w supports imperialism"
          location: "src/babylon/models/entities/economy.py:68"
          status: "FIXED - added to TickMetrics"

        current_repression_level:
          source: "GlobalEconomy.current_repression_level"
          type: "Probability"
          why_critical: "System-wide P(S|R) factor - affects all survival calculations"
          location: "src/babylon/models/entities/economy.py:73"
          status: "FIXED - added to TickMetrics"

        pool_ratio:
          source: "Derived: imperial_rent_pool / initial_pool"
          type: "Probability"
          why_critical: "Triggers bourgeois heuristics at thresholds (0.7, 0.3, 0.1)"
          status: "FIXED - added to TickMetrics"

        percolation_ratio:
          source: "TopologyMonitor.percolation_ratio"
          type: "Probability"
          why_critical: "Phase transition indicator (gaseous→transitional→liquid→solid)"
          location: "src/babylon/engine/topology_monitor.py"
          status: "MODEL READY - TopologySummary added to TickMetrics, awaiting dashboard integration"

        cadre_density:
          source: "TopologyMonitor.cadre_density"
          type: "float [0,1]"
          why_critical: "Distinguishes vanguard party from mass movement"
          location: "src/babylon/engine/topology_monitor.py"
          status: "MODEL READY - TopologySummary added to TickMetrics, awaiting dashboard integration"

    high_priority_gaps:
      description: "Significantly improves analysis capability"
      status: "MOSTLY FIXED IN PHASE 4.1B"
      items:
        consciousness_gap:
          formula: "p_w.consciousness - c_w.consciousness"
          type: "float [-1, 1]"
          why_important: "Revolutionary divergence - when periphery awakens faster than core"
          status: "FIXED - added to TickMetrics"

        wealth_gap:
          formula: "c_b.wealth - p_w.wealth"
          type: "float (unbounded)"
          why_important: "Exploitation intensity indicator"
          status: "FIXED - added to TickMetrics"

        repression_faced:
          source: "SocialClass.repression_faced"
          type: "Probability"
          why_important: "Per-class state violence level (not system-wide)"
          location: "src/babylon/models/entities/social_class.py:303"
          status: "OPEN - per-entity metric, requires EntityMetrics extension"

        num_components:
          source: "TopologyMonitor.num_components"
          type: "int"
          why_important: "Movement fragmentation - how many isolated cells"
          status: "MODEL READY - in TopologySummary, awaiting dashboard integration"

    medium_priority_gaps:
      items:
        - "subsistence_threshold: Currency - input to survival calculus"
        - "effective_wealth: Currency - PPP-adjusted wealth"
        - "unearned_increment: Currency - exploitation benefit"
        - "is_resilient: bool - Sword of Damocles test result"
        - "event_count: int - activity level per tick"
        - "territory metrics: heat, population, evictions"

    low_priority_gaps:
      items:
        - "ppp_multiplier: usually static"
        - "subsidy_cap: static parameter"
        - "non-EXPLOITATION edge tensions: usually 0"

    implementation_issues:
      edge_overwrite_bug:
        location: "src/babylon/engine/observers/metrics.py:228-253"
        description: |
          When iterating over relationships, if multiple edges of same type exist,
          only the LAST one is captured due to simple assignment (not aggregation).
        status: "FIXED IN PHASE 4.1B"
        fix_applied: |
          Now uses list collection and aggregation:
          - exploitation_tension: max() of all EXPLOITATION edges
          - exploitation_rent: sum() of all EXPLOITATION edges
          - tribute_flow: sum() of all TRIBUTE edges
          - wages_paid: sum() of all WAGES edges
          - solidarity_strength: max() of all SOLIDARITY edges
        tests: "TestEdgeAggregationFix (5 tests)"

      global_tension_dilution:
        location: "src/babylon/engine/observers/metrics.py:255-263"
        description: |
          global_tension averages tension across ALL edge types (SOLIDARITY, WAGES, etc.),
          most of which have tension=0.0, artificially diluting the meaningful value.
        status: "FIXED IN PHASE 4.1B"
        fix_applied: |
          Now filters to EXPLOITATION edges only before averaging:
          exploitation_rels = [rel for rel in state.relationships
                               if rel.edge_type == EdgeType.EXPLOITATION]
        tests: "TestGlobalTensionBugFix (5 tests)"

      topology_not_integrated:
        location: "src/babylon/ui/main.py:60"
        description: |
          Dashboard Simulation only registers MetricsCollector as observer.
          TopologyMonitor is NOT registered, so percolation metrics unavailable.
        status: "OPEN - Phase 4.2 work"
        code: |
          simulation = Simulation(state, config, observers=[metrics_collector], defines=defines)
        impact: "Critical - phase transition data invisible to dashboard"
        fix: "Register TopologyMonitor, populate TickMetrics.topology from it"

    recommended_fixes:
      phase_1_critical:
        description: "Must fix for dashboard to be useful"
        status: "COMPLETE (Phase 4.1B)"
        completed: "2025-12-25"
        items:
          - "✅ Add current_super_wage_rate, current_repression_level to TickMetrics"
          - "✅ Add pool_ratio to TickMetrics"
          - "✅ Add TopologySummary model (percolation_ratio, cadre_density, num_components, phase)"
          - "✅ Add derived differentials (consciousness_gap, wealth_gap)"
        tests_added: 22
        commits: ["96e6292", "5665520"]

      phase_2_high:
        description: "Significantly improves insight"
        status: "COMPLETE (Phase 4.1B)"
        completed: "2025-12-25"
        items:
          - "✅ Fix global_tension to only average EXPLOITATION edges"
          - "✅ Handle multiple edges of same type correctly (aggregation)"
          - "⏳ Add repression_faced to EntityMetrics (deferred)"
        tests_added: 10
        commits: ["96e6292", "5665520"]

      phase_3_medium:
        description: "Nice to have for deep analysis"
        status: "OPEN"
        items:
          - "Add event_count tracking"
          - "Add territory aggregate metrics"
          - "Full TopologySnapshot history access"
          - "Wire TopologyMonitor to dashboard (populate TickMetrics.topology)"
        estimated_tests: 10
        estimated_effort: "1 hour TDD"

    phase_4_1b_additions:
      description: "New fields added to TickMetrics in Phase 4.1B"
      date: "2025-12-25"
      new_models:
        TopologySummary:
          location: "src/babylon/models/metrics.py"
          fields:
            - "percolation_ratio: Probability [0,1] - L_max/N"
            - "cadre_density: Probability [0,1] - actual/potential liquidity"
            - "num_components: int >= 0"
            - "phase: Literal['gaseous','transitional','liquid','solid']"
      new_tick_metrics_fields:
        economy_drivers:
          - "current_super_wage_rate: float >= 0 (default 0.20)"
          - "current_repression_level: Probability [0,1] (default 0.5)"
          - "pool_ratio: Probability [0,1] (default 1.0)"
        topology:
          - "topology: TopologySummary | None"
        differentials:
          - "consciousness_gap: float [-1,1] (P_w - C_w consciousness)"
          - "wealth_gap: float (C_b - P_w wealth, unbounded)"
      csv_export:
        new_columns:
          - "imperial_rent_pool, global_tension"
          - "current_super_wage_rate, current_repression_level, pool_ratio"
          - "consciousness_gap, wealth_gap"
