# Babylon Observer Layer Specification
# Machine-readable spec for the TopologyMonitor (Condensation Monitor)
# Implements percolation theory for phase transition detection

meta:
  version: "1.1.0"
  created: "2025-12-11"
  updated: "2025-12-12"
  purpose: "Document the Observer system that tracks solidarity network condensation and emits phase transition events"
  principle: "Graph + Math = History. No emotions, only topology."
  status: "COMPLETE"
  location: "src/babylon/engine/topology_monitor.py"
  tests: "tests/unit/topology/ (57 tests: 32 monitor + 25 phase transition)"
  sprint: "Sprint 3.3 - Phase Transition Events"
  audit_note: "Updated for Sprint 3.3 - PhaseTransitionEvent emission (2025-12-12)"

# =============================================================================
# NARRATIVE VOICE: THE BONDI ALGORITHM
# =============================================================================
# STATUS: DESIGN ONLY - No LLM integration implemented yet.
# The TopologyMonitor logs to Python logging, not to an LLM narrative generator.
# This section documents the intended voice when LLM integration is added.

narrative_voice:
  name: "The Bondi Algorithm"
  implementation_status: "DESIGN ONLY - awaiting LLM integration (Sprint 3.3+)"
  principle: |
    The Observer speaks with the cold, mechanical precision of a machine
    deciding who to arrest. No emotional language. No softening. Pure
    topological analysis delivered with algorithmic detachment.

  aesthetic: |
    The horror of state repression is amplified, not diminished, by
    clinical language. A machine cataloging human beings for elimination
    is more terrifying than angry rhetoric.

  bad_example:
    text: "The police are cracking down on protesters."
    problem: "Too vague, too emotional, too human."

  good_example:
    text: |
      High-centrality nodes identified. Degree centrality > 0.4.
      Executing targeted removal. Network fragmentation imminent.
      Probability of survival: 12%.
    principle: "Cold topology. Pure math. The machine doesn't hate - it calculates."

  vocabulary:
    avoid:
      - "cracking down"
      - "brutal"
      - "oppressive"
      - "fighting back"
      - "heroic resistance"
    prefer:
      - "targeted removal"
      - "network fragmentation"
      - "high-centrality nodes"
      - "percolation threshold"
      - "giant component"
      - "resilience test failed"
      - "probability of survival"

# =============================================================================
# NARRATIVE TEMPLATES
# =============================================================================

narrative_templates:
  gaseous_state:
    trigger: "percolation_ratio < 0.1"
    template: |
      STATE: Gaseous. Movement is atomized.
      Components: {num_components}. Max cluster: {max_component_size}.
      Percolation ratio: {percolation_ratio:.3f}. Below critical threshold.
      Assessment: No coordination capacity. Individual nodes isolated.

  phase_shift:
    trigger: "percolation_ratio crosses 0.5 from below"
    template: |
      PHASE SHIFT: Condensation detected.
      Giant component formed. L_max = {max_component_size} ({percolation_ratio:.1%} of network).
      Critical mass achieved. Vanguard Party crystallized from gaseous leftism.
      Warning: Coordination capacity now exceeds state disruption threshold.

  brittle_warning:
    trigger: "potential_liquidity > 2 * actual_liquidity"
    template: |
      WARNING: Network topology brittle.
      Potential edges: {potential_liquidity}. Actual edges: {actual_liquidity}.
      Sympathizer-to-cadre ratio exceeds safe threshold.
      Assessment: Broad but shallow. Lacks organizational discipline.
      Vulnerability: Single-point failures will cascade.

  sword_of_damocles:
    trigger: "resilience_test returns False"
    template: |
      ALERT: Sword of Damocles active.
      Resilience test FAILED. Removal of {removal_rate:.0%} nodes destroys giant component.
      Post-purge L_max: {post_purge_max_component} (was {original_max_component}).
      Assessment: Movement vulnerable to targeted decapitation.
      Recommendation: Redundant leadership structures required.

  purge_simulation:
    context: "When describing state repression capabilities"
    template: |
      PURGE SIMULATION: Executing Bondi Algorithm.
      Identifying high-centrality nodes. Degree threshold: 0.4.
      Nodes flagged for removal: {num_targets}.
      Projected network state post-purge:
        - Components: {post_components}
        - Max cluster: {post_max}
        - Coordination capacity: {capacity_pct:.0%} of original.
      Probability of movement survival: {survival_pct:.0%}.

# =============================================================================
# THEORETICAL FOUNDATION: PERCOLATION THEORY
# =============================================================================

theory:
  name: "Percolation Theory for Revolutionary Consciousness"

  gaseous_state:
    definition: "Many small, disconnected components"
    characteristic: "No giant component (L_max < 50% of N)"
    political_meaning: |
      Atomized leftism. Individual cells operate in isolation.
      No capacity for coordinated action. Vulnerable to targeted repression.
      State can eliminate nodes without cascade effects.

  liquid_state:
    definition: "Giant component spans majority of network"
    characteristic: "L_max >= 50% of N (percolation threshold crossed)"
    political_meaning: |
      Vanguard Party formation. Consciousness can propagate through network.
      Coordinated action possible. Removal of individual nodes does not
      destroy organizational capacity.

  phase_transition:
    definition: "The tick where percolation ratio crosses 0.5"
    characteristic: "Sudden, non-linear shift in network properties"
    political_meaning: |
      The moment of crystallization. Gaseous leftism condenses into
      organized revolutionary force. Like water freezing - gradual
      temperature drop, sudden phase change.

  resilience:
    definition: "Survival of giant component after targeted node removal"
    test: "Remove 20% of nodes. Does L_max survive at 40% of original?"
    political_meaning: |
      Can the movement survive decapitation? Star topology (charismatic
      leader) is fragile. Mesh topology (distributed leadership) is
      resilient. The test simulates state repression capabilities.

# =============================================================================
# METRICS REFERENCE
# =============================================================================

metrics:
  num_components:
    type: int
    description: "Number of disconnected subgraphs in solidarity network"
    interpretation: "Higher = more atomized. Lower = more unified."

  max_component_size:
    symbol: "L_max"
    type: int
    description: "Size of largest connected component"
    interpretation: "The giant component. The organizational core."

  percolation_ratio:
    formula: "L_max / N"
    type: Probability
    thresholds:
      gaseous: "< 0.1"
      transitional: "0.1 - 0.5"
      liquid: ">= 0.5"
    interpretation: "Giant component dominance over total network."

  potential_liquidity:
    threshold: "SOLIDARITY edges > 0.1"
    type: int
    description: "Sympathizer network size"
    interpretation: "Broad support base. May lack depth."

  actual_liquidity:
    threshold: "SOLIDARITY edges > 0.5"
    type: int
    description: "Cadre network size"
    interpretation: "Committed organizational core. The steel."

  is_resilient:
    type: bool
    test: "20% node removal, 40% survival threshold"
    interpretation: "Can movement survive targeted repression?"

# =============================================================================
# EVENT EMISSION (Sprint 3.3)
# =============================================================================

event_emission:
  status: "COMPLETE (Sprint 3.3)"
  event_type: "PhaseTransitionEvent"
  enum: "EventType.PHASE_TRANSITION"

  phase_states:
    gaseous:
      threshold: "percolation_ratio < 0.1"
      meaning: "Atomized leftism, no coordination capacity"
    transitional:
      threshold: "0.1 <= percolation_ratio < 0.5"
      meaning: "Emerging structure, unstable"
    liquid:
      threshold: "percolation_ratio >= 0.5"
      meaning: "Giant component, vanguard formation"

  emission_mechanism:
    description: |
      TopologyMonitor tracks phase state across ticks. When percolation_ratio
      crosses a threshold boundary (gaseous ↔ transitional ↔ liquid), a
      PhaseTransitionEvent is created and stored in _pending_events.

      The Simulation facade calls get_pending_events() after notify_observers_tick(),
      collecting all observer events and storing them in persistent_context['_observer_events'].

      On the NEXT tick, simulation_engine.step() reads these events from
      persistent_context and appends them to the WorldState.events list.

    key_insight: |
      Observer events appear in the NEXT tick's WorldState because observers
      run AFTER the WorldState is frozen for the current tick. This is correct
      behavior - the phase transition is detected AFTER the tick that caused it.

  internal_state:
    _previous_phase: "str | None - tracks last known phase for transition detection"
    _pending_events: "list[SimulationEvent] - events awaiting collection"

  methods:
    _classify_phase:
      signature: "_classify_phase(percolation_ratio: float) -> str"
      returns: "'gaseous' | 'transitional' | 'liquid'"
    get_pending_events:
      signature: "get_pending_events() -> list[SimulationEvent]"
      behavior: "Returns and clears the pending events list"

  integration_points:
    simulation_facade:
      method: "_collect_observer_events()"
      location: "src/babylon/engine/simulation.py"
      description: "Collects events from all observers with get_pending_events()"
    simulation_engine:
      method: "step()"
      location: "src/babylon/engine/simulation_engine.py"
      description: "Reads persistent_context['_observer_events'] and appends to WorldState.events"

# =============================================================================
# IMPLEMENTATION NOTES
# =============================================================================

implementation:
  observer_protocol:
    interface: "SimulationObserver"
    methods:
      - "on_simulation_start(initial_state, config)"
      - "on_tick(previous_state, new_state)"
      - "on_simulation_end(final_state)"
    constraint: "Observer MUST NOT mutate simulation state"

  resilience_interval:
    default: 5
    meaning: "Run purge simulation every N ticks"
    value_zero: "Disabled - no resilience testing"
    rationale: "Expensive operation, not needed every tick"

  graph_extraction:
    input: "WorldState.to_graph() -> nx.DiGraph"
    output: "nx.Graph (undirected) for component analysis"
    filter: "Only SOLIDARITY edges, only social_class nodes"
    rationale: "Territory nodes are spatial substrate, not solidarity network"
