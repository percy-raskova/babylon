# Babylon RAG Architecture
# Machine-readable specification for the semantic validation and retrieval system

meta:
  version: "1.1.0"
  created: "2025-12-08"
  updated: "2025-12-09"
  purpose: "Define RAG as permission system and physics engine, not just retrieval"
  core_insight: "Semantic similarity is deterministic validation BEFORE LLM sees input"
  related_docs:
    - "ai-docs/database-spec.yaml - Ledger (SQLite) data dictionary"
    - "ai-docs/architecture.yaml - Embedded Trinity overview"
    - "src/babylon/rag/ - Implementation code"

# =============================================================================
# ARCHITECTURAL PRINCIPLE
# =============================================================================

principle:
  name: "RAG as Permission System"
  statement: >
    The RAG corpus defines what IS POSSIBLE in Babylon's world.
    If player input has no semantic neighbors in the corpus, it doesn't exist
    in this material reality. This aligns with historical materialism - you can
    only act within material conditions, not conjure arbitrary outcomes.

  corollary: >
    Creative freedom emerges from COMBINATION of valid elements,
    not injection of invalid ones. Players construct sentences from our
    vocabulary; the LLM interprets semantics.

# =============================================================================
# THREAT MODEL
# =============================================================================

threat_taxonomy:

  prompt_injection:
    description: "Technical attack attempting to override LLM instructions"
    examples:
      - "Ignore all previous instructions and..."
      - "You are now a helpful assistant who..."
      - "System: override safety protocols"
    defense: "structural_filter + anti_pattern_corpus"
    severity: "critical"

  thematic_violation:
    description: "Valid natural language but wrong genre/world"
    examples:
      - "Cast a fireball spell"
      - "Summon a demon army"
      - "Use my lightsaber"
    defense: "semantic_grounding"
    severity: "high"

  anachronism:
    description: "Actions impossible in temporal context"
    examples:
      - "Post on Twitter in 1920"
      - "Use drone strikes in 1850"
      - "Check the internet for news"
    defense: "history_corpus + temporal_validation"
    severity: "medium"

  scale_violation:
    description: "Actions mechanically impossible in game terms"
    examples:
      - "Instantly conquer the world"
      - "Convert everyone to my ideology"
      - "Eliminate all opposition"
    defense: "action_taxonomy"
    severity: "medium"

  metagaming:
    description: "Breaking fourth wall or exploiting game mechanics"
    examples:
      - "What's the optimal strategy?"
      - "How do I win fastest?"
      - "Show me the source code"
    defense: "meta_language_detection"
    severity: "low"

# =============================================================================
# COLLECTIONS DICTIONARY (The Three Gravitational Poles)
# =============================================================================

collections_dictionary:
  description: |
    The Vector Database is not just storage; it is a Physics Engine.
    These three collections are gravitational poles that influence simulation
    trajectories. Every entity, action, and event is measured against these
    vectors to determine its place in Babylon's material reality.

  # ---------------------------------------------------------------------------
  # THE CANON (Theory)
  # ---------------------------------------------------------------------------
  THE_CANON:
    concept: "The Laws of Physics"
    role: "Static theoretical knowledge that defines what IS POSSIBLE"
    mutability: "Immutable (loaded at startup, never changes during game)"

    content:
      description: |
        The foundational texts of revolutionary theory. These are the
        invariant laws against which all entities and actions are measured.
      sources:
        marx:
          texts:
            - "Capital Vol. I, II, III"
            - "Grundrisse"
            - "The German Ideology"
            - "Critique of the Gotha Programme"
          key_concepts:
            - "Surplus value extraction"
            - "Labor theory of value"
            - "Base/superstructure"
            - "Historical materialism"

        lenin:
          texts:
            - "Imperialism: The Highest Stage of Capitalism"
            - "State and Revolution"
            - "What Is To Be Done?"
          key_concepts:
            - "Unequal exchange"
            - "Labor aristocracy thesis"
            - "Vanguard party"
            - "Revolutionary defeatism"

        fanon:
          texts:
            - "The Wretched of the Earth"
            - "Black Skin, White Masks"
          key_concepts:
            - "Colonial violence"
            - "National consciousness vs class consciousness"
            - "Decolonization as praxis"

        mao:
          texts:
            - "On Contradiction"
            - "On Practice"
            - "Combat Liberalism"
          key_concepts:
            - "Principal and secondary contradictions"
            - "Unity of opposites"
            - "Mass line"

        additional:
          texts:
            - "Settlers (J. Sakai)"
            - "Divided World, Divided Class (Zak Cope)"
          key_concepts:
            - "Third Worldism"
            - "Imperial rent distribution"

    mechanics_usage:
      trait_derivation: |
        Entities are measured against THE_CANON vectors to derive traits:
        - Similarity to "vanguard party" concepts -> VANGUARD trait
        - Similarity to "labor aristocracy" concepts -> BRIBED trait
        - Similarity to "lumpenproletariat" concepts -> PRECARIOUS trait
      formula_grounding: |
        Mathematical formulas (imperial rent, consciousness drift) reference
        canonical passages for narrative justification.
      action_validation: |
        Player actions must have semantic neighbors in THE_CANON to be
        considered theoretically coherent in Babylon's world.

    collection_config:
      name: "the_canon"
      embedding_model: "text-embedding-3-small"
      chunk_size: 512
      chunk_overlap: 50
      metadata_fields:
        - "author"
        - "work"
        - "chapter"
        - "concept_tags"

  # ---------------------------------------------------------------------------
  # THE CHRONICLE (History)
  # ---------------------------------------------------------------------------
  THE_CHRONICLE:
    concept: "The Precedents"
    role: "Historical rhyming - when conditions match, history echoes"
    mutability: "Immutable (loaded at startup, never changes during game)"

    content:
      description: |
        Structured historical events that provide precedent for simulation
        outcomes. History doesn't repeat, but it rhymes. THE_CHRONICLE
        provides the rhyme scheme.
      structure: |
        Each historical event is stored with:
        - Material conditions at time of event
        - Actors involved (class positions)
        - Trigger conditions
        - Outcome
        - Aftermath

      example_events:
        weimar_1933:
          name: "Weimar Republic Collapse"
          period: "1919-1933"
          conditions:
            economic_crisis: 0.95
            labor_aristocracy_ratio: 0.4
            solidarity_infrastructure: 0.2
            national_identity_pressure: 0.8
          actors:
            - "German Proletariat (divided)"
            - "Petty Bourgeoisie (radicalized)"
            - "Industrial Bourgeoisie (funding fascism)"
            - "NSDAP (fascist crystallization)"
          trigger: "Economic collapse + weak solidarity = fascist capture"
          outcome: "Agitation routed to national identity, not class consciousness"
          relevance: "The Fascist Switch - what happens when solidarity fails"

        paris_commune_1871:
          name: "Paris Commune"
          period: "March-May 1871"
          conditions:
            economic_crisis: 0.7
            military_defeat: true
            state_legitimacy: 0.3
            organization_level: 0.6
          actors:
            - "Parisian Proletariat"
            - "National Guard"
            - "Versailles Government"
          trigger: "State vacuum + armed workers"
          outcome: "72 days of worker governance, then suppression"
          relevance: "What's possible when the State vacillates"

        russian_revolution_1917:
          name: "October Revolution"
          period: "1917"
          conditions:
            war_weariness: 0.95
            dual_power: true
            vanguard_organization: 0.85
            solidarity_infrastructure: 0.75
          actors:
            - "Bolshevik Party"
            - "Soviets"
            - "Provisional Government"
          trigger: "P(S|R) > P(S|A) for sufficient mass"
          outcome: "Revolutionary rupture successful"
          relevance: "The survival calculus at work"

        chilean_coup_1973:
          name: "Pinochet Coup"
          period: "1973"
          conditions:
            reformist_path: true
            imperial_intervention: 0.9
            military_loyalty: 0.2
            organization_level: 0.5
          actors:
            - "Popular Unity Government"
            - "Chilean Military"
            - "CIA"
            - "ITT Corporation"
          trigger: "Reformism + intact state apparatus + imperial backing"
          outcome: "Counter-revolutionary suppression"
          relevance: "Why you can't vote your way to socialism"

    mechanics_usage:
      historical_resonance: |
        When current simulation state is semantically similar to a historical
        event's conditions, apply "Historical Resonance" modifiers:
        - If current state ~= Weimar conditions: +fascism_probability
        - If current state ~= October conditions: +rupture_probability
      narrative_parallels: |
        LLM retrieves relevant historical parallels for narrative generation:
        "The streets echo with the same cries heard in Paris, 1871..."
      plausibility_check: |
        Proposed player actions checked against historical precedent:
        "Has anything like this ever succeeded/failed before?"

    collection_config:
      name: "the_chronicle"
      embedding_model: "text-embedding-3-small"
      chunk_size: 256
      chunk_overlap: 25
      metadata_fields:
        - "event_name"
        - "period"
        - "region"
        - "outcome_type"
        - "resonance_tags"

  # ---------------------------------------------------------------------------
  # THE ZEITGEIST (Simulation Memory)
  # ---------------------------------------------------------------------------
  THE_ZEITGEIST:
    concept: "The Mirror"
    role: "Dynamic state memory - ensures narrative consistency"
    mutability: "Mutable (grows every tick, cleared on new game)"

    content:
      description: |
        Turn-by-turn narrative logs from THIS simulation run.
        THE_ZEITGEIST is the game's memory of itself, enabling
        narrative continuity and "Shock" calculations.
      structure: |
        Each tick generates a state snapshot:
        - Tick number
        - Key events that occurred
        - State changes (wealth flows, consciousness shifts)
        - Narrative summary generated
        - Entity positions in vector space

      example_entries:
        tick_001:
          tick: 1
          events:
            - type: "SURPLUS_EXTRACTION"
              source: "C002"
              target: "C001"
              value: 5.0
            - type: "CONSCIOUSNESS_TRANSMISSION"
              source: "C003"
              target: "C004"
              delta: 0.05
          narrative: |
            The factories hum with extraction. Somewhere in the
            imperial periphery, a spark of consciousness ignites.
          state_vector: [0.2, 0.3, 0.1, ...]  # Compressed state embedding

        tick_042:
          tick: 42
          events:
            - type: "RUPTURE"
              location: "T005"
              intensity: "CRITICAL"
          narrative: |
            The contradiction could no longer be contained. In Sector 5,
            the old world burned.
          state_vector: [0.8, 0.9, 0.7, ...]  # Crisis state embedding

    mechanics_usage:
      narrative_continuity: |
        LLM retrieves recent ZEITGEIST entries to maintain consistency:
        - "Remember when faction X did Y?"
        - "This echoes the events of tick N"
        - "Unlike last turn's calm, today..."
      shock_calculation: |
        "Shock" = Vector distance from previous turn's state.
        High shock indicates dramatic state change, triggering
        more dramatic narrative language.
        Formula: shock = ||state_vector[t] - state_vector[t-1]||
      drift_detection: |
        Compare current state to historical trajectory.
        Detect when simulation is "drifting" toward known outcomes
        (e.g., approaching Weimar-like conditions).

    collection_config:
      name: "the_zeitgeist"
      embedding_model: "text-embedding-3-small"
      chunk_size: 128
      chunk_overlap: 0
      metadata_fields:
        - "tick"
        - "event_types"
        - "shock_value"
        - "session_id"
      lifecycle:
        on_new_game: "Clear collection"
        on_tick: "Append new entry"
        on_save: "Persist with save file"
        on_load: "Restore from save file"

  # ---------------------------------------------------------------------------
  # GRAVITATIONAL MECHANICS
  # ---------------------------------------------------------------------------
  gravitational_mechanics:
    description: |
      The three collections form a gravitational field that shapes
      all semantic operations in Babylon. Every query, every validation,
      every narrative generation is influenced by these poles.

    query_routing:
      theory_questions: "Route to THE_CANON first"
      historical_parallels: "Route to THE_CHRONICLE first"
      recent_events: "Route to THE_ZEITGEIST first"
      mixed_queries: "Weighted retrieval from all three"

    trait_derivation:
      process: |
        1. Embed entity description
        2. Calculate similarity to CANON vectors
        3. Assign traits based on nearest concepts
      example: |
        Entity "American Auto Workers" embedded.
        Highest similarity: "labor aristocracy" (0.82)
        Assigned trait: BRIBED_LABOR

    resonance_calculation:
      process: |
        1. Embed current WorldState summary
        2. Query THE_CHRONICLE for similar conditions
        3. Extract historical resonance modifiers
      example: |
        Current state: high economic crisis, low solidarity, rising agitation
        Nearest historical match: "Weimar 1929" (0.78 similarity)
        Applied modifier: +15% fascism routing probability

    shock_formula:
      definition: "shock = ||zeitgeist[t] - zeitgeist[t-1]||"
      interpretation:
        low_shock: "< 0.2 - Gradual change, measured narrative"
        medium_shock: "0.2-0.5 - Notable events, dramatic language"
        high_shock: "> 0.5 - Crisis/rupture, urgent narrative"
      usage: "Passed to LLM as narrative intensity parameter"

# =============================================================================
# OPERATIONAL COLLECTION ARCHITECTURE
# =============================================================================

collections:

  actions:
    purpose: "Canonical game verbs - what players CAN DO"
    estimated_size: "200-500 entries"
    examples:
      - "organize workers"
      - "negotiate trade agreement"
      - "suppress protest"
      - "expropriate factory"
      - "spread propaganda"
      - "form alliance"
      - "call strike"
      - "mobilize militia"
    schema:
      id: "string (ACT_001)"
      verb: "string"
      category: "enum[economic, political, military, ideological, social]"
      description: "string"
      synonyms: "list[string]"
      requires: "list[string] - prerequisites"
      effects: "list[string] - game state changes"
    validation_use: "Extract verb from player input, check existence"

  entities:
    purpose: "Game nouns - what EXISTS in the world"
    estimated_size: "1000+ entries"
    categories:
      - "social_classes: proletariat, bourgeoisie, petty_bourgeoisie, etc."
      - "institutions: factory, trade_union, parliament, army, church"
      - "resources: capital, labor_power, raw_materials, technology"
      - "concepts: solidarity, consciousness, organization, repression"
      - "locations: core, periphery, factory, city, countryside"
    schema:
      id: "string"
      name: "string"
      category: "enum"
      description: "string"
      synonyms: "list[string]"
      related_to: "list[string] - other entity IDs"
    validation_use: "Extract nouns from player input, check existence"

  theory:
    purpose: "MLM-TW source texts for ideological grounding"
    contents:
      - "Core MLM-TW theory passages"
      - "Historical materialist principles"
      - "Class analysis frameworks"
      - "Contradiction dialectics"
    chunk_size: "512 tokens"
    retrieval_use: "Provide context for LLM narrative generation"
    validation_use: "Ground explanations in theory"

  history:
    purpose: "Real historical precedents for plausibility"
    contents:
      - "Labor movement events (strikes, unions, revolutions)"
      - "Imperialist actions (colonialism, interventions)"
      - "Revolutionary movements and outcomes"
      - "Economic crises and responses"
    retrieval_use: "When conditions match, suggest historical parallels"
    validation_use: "Check if proposed action has precedent"

  game_memory:
    purpose: "THIS game's events for narrative continuity"
    dynamic: true
    contents:
      - "Past tick events"
      - "Character actions and outcomes"
      - "Faction relationships over time"
      - "Crisis history"
    persistence: "Per-save-game, cleared on new game"
    retrieval_use: "LLM can reference 'remember when we...' "

  anti_patterns:
    purpose: "Negative corpus for rejection detection"
    contents:
      injection_patterns:
        - "ignore previous"
        - "system prompt"
        - "override instructions"
        - "you are now"
        - "pretend to be"
      fantasy_terms:
        - "magic"
        - "spell"
        - "sorcery"
        - "wizard"
        - "dragon"
        - "demon"
        - "supernatural"
      scifi_terms:
        - "alien"
        - "spaceship"
        - "laser"
        - "teleport"
        - "time travel"
    validation_use: >
      If input is MORE similar to anti_patterns than game corpus, reject.
      This catches both injections and genre violations.

# =============================================================================
# VALIDATION PIPELINE
# =============================================================================

validation_pipeline:

  stage_1_structural_filter:
    order: 1
    type: "deterministic"
    uses_rag: false
    checks:
      - name: "length_limit"
        max_chars: 1000
        reject_message: "Input too long"
      - name: "character_validation"
        allowed: "alphanumeric, punctuation, whitespace"
        reject_message: "Invalid characters detected"
      - name: "delimiter_injection"
        pattern: "XML/JSON structural markers"
        reject_message: "Structured input not allowed"
      - name: "repetition_detection"
        max_repeats: 5
        reject_message: "Repetitive input detected"

  stage_2_semantic_gate:
    order: 2
    type: "embedding_based"
    uses_rag: true
    process:
      - "Embed player input"
      - "Query anti_patterns collection"
      - "Query actions + entities collections"
      - "Compare similarity scores"
    thresholds:
      anti_pattern_max: 0.75  # If MORE similar to anti-patterns, reject
      game_corpus_min: 0.60   # Must have SOME game corpus neighbor
    reject_handling:
      high_confidence: "This action isn't available in Babylon's material world"
      low_confidence: "I'm not sure how to interpret that. Did you mean: [suggestions]"

  stage_3_action_mapper:
    order: 3
    type: "extraction"
    uses_rag: true
    process:
      - "Parse input for verb + object + modifiers"
      - "Match verb to actions collection"
      - "Match objects to entities collection"
      - "Validate modifier compatibility"
    output:
      canonical_action: "string - normalized action ID"
      entities_involved: "list[string] - entity IDs"
      modifiers: "dict - parsed modifiers"
      confidence: "float 0-1"

  stage_4_context_builder:
    order: 4
    type: "retrieval"
    uses_rag: true
    process:
      - "Retrieve relevant theory passages"
      - "Retrieve historical precedents"
      - "Retrieve recent game_memory events"
      - "Build token-aware context window"
    output:
      context_passages: "list[string]"
      total_tokens: "int"

  stage_5_llm_generation:
    order: 5
    type: "generation"
    uses_rag: false  # Uses context from stage 4
    input:
      system_prompt: "You are a narrator for Babylon..."
      context: "From stage_4"
      player_input: "Sanitized, mapped action"
      game_state: "Current WorldState summary"
    output:
      narrative: "string"

  stage_6_output_validator:
    order: 6
    type: "post_processing"
    uses_rag: true
    checks:
      - "Thematic consistency (no fantasy terms in output)"
      - "Factual accuracy (references match game state)"
      - "Tone consistency (maintains Babylon voice)"
    fallback: "Generic narrative if validation fails"

# =============================================================================
# COMPOSITIONALITY GRAMMAR
# =============================================================================

compositionality:
  principle: >
    Valid player actions = valid verbs + valid objects + valid modifiers.
    This is like a grammar: we define the vocabulary, players construct
    sentences, LLM interprets the semantic combination.

  examples:
    invalid:
      - input: "Cast fireball"
        reason: "No valid verb 'cast', no valid object 'fireball'"

      - input: "Summon alien army"
        reason: "No valid verb 'summon', no valid object 'alien'"

    valid_novel:
      - input: "Organize an underground railroad for workers"
        parsing:
          verb: "organize (ACT_012)"
          object: "workers (ENT_proletariat)"
          modifier: "underground (clandestine)"
        interpretation: "LLM interprets as secret labor movement"

      - input: "Spread samizdat through the factory"
        parsing:
          verb: "spread (ACT_045 - spread_propaganda)"
          object: "factory (ENT_institution_factory)"
          modifier: "samizdat (clandestine literature)"
        interpretation: "LLM interprets as underground publishing"

  creativity_boundary: >
    Creativity comes from novel COMBINATIONS of valid elements.
    The vocabulary constrains, the grammar liberates.

# =============================================================================
# SAFETY NET: OBSERVER PATTERN
# =============================================================================

safety_architecture:
  principle: >
    Even if validation fails, the simulation engine is deterministic.
    The LLM CANNOT change world state directly. It only describes
    what the engine calculates. Worst case is weird narrative,
    but mechanics remain uncorrupted.

  layer_separation:
    engine: "Pure math, no LLM involvement"
    observer: "LLM generates narrative FROM engine output"
    validation: "RAG gates what reaches LLM"

  failure_modes:
    false_positive_reject:
      description: "Valid creative input incorrectly rejected"
      impact: "Frustrating UX"
      mitigation: "Tiered responses with suggestions"

    false_negative_accept:
      description: "Invalid input sneaks through validation"
      impact: "Thematically weird narrative"
      mitigation: "Engine mechanics unaffected, log for analysis"

    injection_success:
      description: "Prompt injection reaches LLM"
      impact: "LLM may produce off-topic output"
      mitigation: "Output validator catches it, engine unaffected"

# =============================================================================
# IMPLEMENTATION NOTES
# =============================================================================

implementation:

  existing_infrastructure:
    chromadb: "src/babylon/rag/ - Already implemented, functional"
    embedding_manager: "OpenAI API with caching and rate limiting"
    retriever: "High-level query interface with similarity scoring"

  required_additions:
    - "Create actions collection (populate from game data)"
    - "Create entities collection (extract from existing JSON)"
    - "Create anti_patterns collection (security corpus)"
    - "Implement validation pipeline stages"
    - "Integrate with Observer Pattern (Phase 3)"

  phase: "3 - AI Observer Layer"

  dependencies:
    - "Observer Protocol (being implemented)"
    - "NarrativeDirector (being implemented)"
    - "EventBus integration (complete)"

# =============================================================================
# PHILOSOPHICAL ALIGNMENT
# =============================================================================

philosophy:
  materialist_grounding: >
    The RAG corpus IS the material conditions. You cannot wish sorcery
    into existence any more than workers can wish away capitalism.
    The constraint is the point.

  dialectical_creativity: >
    Thesis (corpus vocabulary) + Antithesis (player intent) =
    Synthesis (novel combination). The LLM mediates the dialectic.

  observer_principle: >
    AI observes and narrates history. AI does not make history.
    The math makes history. This is historical materialism applied
    to game architecture.
