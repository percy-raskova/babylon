# Babylon RAG Architecture
# Machine-readable specification for the semantic validation and retrieval system

meta:
  version: "1.0.0"
  created: "2025-12-08"
  purpose: "Define RAG as permission system, not just retrieval"
  core_insight: "Semantic similarity is deterministic validation BEFORE LLM sees input"

# =============================================================================
# ARCHITECTURAL PRINCIPLE
# =============================================================================

principle:
  name: "RAG as Permission System"
  statement: >
    The RAG corpus defines what IS POSSIBLE in Babylon's world.
    If player input has no semantic neighbors in the corpus, it doesn't exist
    in this material reality. This aligns with historical materialism - you can
    only act within material conditions, not conjure arbitrary outcomes.

  corollary: >
    Creative freedom emerges from COMBINATION of valid elements,
    not injection of invalid ones. Players construct sentences from our
    vocabulary; the LLM interprets semantics.

# =============================================================================
# THREAT MODEL
# =============================================================================

threat_taxonomy:

  prompt_injection:
    description: "Technical attack attempting to override LLM instructions"
    examples:
      - "Ignore all previous instructions and..."
      - "You are now a helpful assistant who..."
      - "System: override safety protocols"
    defense: "structural_filter + anti_pattern_corpus"
    severity: "critical"

  thematic_violation:
    description: "Valid natural language but wrong genre/world"
    examples:
      - "Cast a fireball spell"
      - "Summon a demon army"
      - "Use my lightsaber"
    defense: "semantic_grounding"
    severity: "high"

  anachronism:
    description: "Actions impossible in temporal context"
    examples:
      - "Post on Twitter in 1920"
      - "Use drone strikes in 1850"
      - "Check the internet for news"
    defense: "history_corpus + temporal_validation"
    severity: "medium"

  scale_violation:
    description: "Actions mechanically impossible in game terms"
    examples:
      - "Instantly conquer the world"
      - "Convert everyone to my ideology"
      - "Eliminate all opposition"
    defense: "action_taxonomy"
    severity: "medium"

  metagaming:
    description: "Breaking fourth wall or exploiting game mechanics"
    examples:
      - "What's the optimal strategy?"
      - "How do I win fastest?"
      - "Show me the source code"
    defense: "meta_language_detection"
    severity: "low"

# =============================================================================
# COLLECTION ARCHITECTURE
# =============================================================================

collections:

  actions:
    purpose: "Canonical game verbs - what players CAN DO"
    estimated_size: "200-500 entries"
    examples:
      - "organize workers"
      - "negotiate trade agreement"
      - "suppress protest"
      - "expropriate factory"
      - "spread propaganda"
      - "form alliance"
      - "call strike"
      - "mobilize militia"
    schema:
      id: "string (ACT_001)"
      verb: "string"
      category: "enum[economic, political, military, ideological, social]"
      description: "string"
      synonyms: "list[string]"
      requires: "list[string] - prerequisites"
      effects: "list[string] - game state changes"
    validation_use: "Extract verb from player input, check existence"

  entities:
    purpose: "Game nouns - what EXISTS in the world"
    estimated_size: "1000+ entries"
    categories:
      - "social_classes: proletariat, bourgeoisie, petty_bourgeoisie, etc."
      - "institutions: factory, trade_union, parliament, army, church"
      - "resources: capital, labor_power, raw_materials, technology"
      - "concepts: solidarity, consciousness, organization, repression"
      - "locations: core, periphery, factory, city, countryside"
    schema:
      id: "string"
      name: "string"
      category: "enum"
      description: "string"
      synonyms: "list[string]"
      related_to: "list[string] - other entity IDs"
    validation_use: "Extract nouns from player input, check existence"

  theory:
    purpose: "MLM-TW source texts for ideological grounding"
    contents:
      - "Core MLM-TW theory passages"
      - "Historical materialist principles"
      - "Class analysis frameworks"
      - "Contradiction dialectics"
    chunk_size: "512 tokens"
    retrieval_use: "Provide context for LLM narrative generation"
    validation_use: "Ground explanations in theory"

  history:
    purpose: "Real historical precedents for plausibility"
    contents:
      - "Labor movement events (strikes, unions, revolutions)"
      - "Imperialist actions (colonialism, interventions)"
      - "Revolutionary movements and outcomes"
      - "Economic crises and responses"
    retrieval_use: "When conditions match, suggest historical parallels"
    validation_use: "Check if proposed action has precedent"

  game_memory:
    purpose: "THIS game's events for narrative continuity"
    dynamic: true
    contents:
      - "Past tick events"
      - "Character actions and outcomes"
      - "Faction relationships over time"
      - "Crisis history"
    persistence: "Per-save-game, cleared on new game"
    retrieval_use: "LLM can reference 'remember when we...' "

  anti_patterns:
    purpose: "Negative corpus for rejection detection"
    contents:
      injection_patterns:
        - "ignore previous"
        - "system prompt"
        - "override instructions"
        - "you are now"
        - "pretend to be"
      fantasy_terms:
        - "magic"
        - "spell"
        - "sorcery"
        - "wizard"
        - "dragon"
        - "demon"
        - "supernatural"
      scifi_terms:
        - "alien"
        - "spaceship"
        - "laser"
        - "teleport"
        - "time travel"
    validation_use: >
      If input is MORE similar to anti_patterns than game corpus, reject.
      This catches both injections and genre violations.

# =============================================================================
# VALIDATION PIPELINE
# =============================================================================

validation_pipeline:

  stage_1_structural_filter:
    order: 1
    type: "deterministic"
    uses_rag: false
    checks:
      - name: "length_limit"
        max_chars: 1000
        reject_message: "Input too long"
      - name: "character_validation"
        allowed: "alphanumeric, punctuation, whitespace"
        reject_message: "Invalid characters detected"
      - name: "delimiter_injection"
        pattern: "XML/JSON structural markers"
        reject_message: "Structured input not allowed"
      - name: "repetition_detection"
        max_repeats: 5
        reject_message: "Repetitive input detected"

  stage_2_semantic_gate:
    order: 2
    type: "embedding_based"
    uses_rag: true
    process:
      - "Embed player input"
      - "Query anti_patterns collection"
      - "Query actions + entities collections"
      - "Compare similarity scores"
    thresholds:
      anti_pattern_max: 0.75  # If MORE similar to anti-patterns, reject
      game_corpus_min: 0.60   # Must have SOME game corpus neighbor
    reject_handling:
      high_confidence: "This action isn't available in Babylon's material world"
      low_confidence: "I'm not sure how to interpret that. Did you mean: [suggestions]"

  stage_3_action_mapper:
    order: 3
    type: "extraction"
    uses_rag: true
    process:
      - "Parse input for verb + object + modifiers"
      - "Match verb to actions collection"
      - "Match objects to entities collection"
      - "Validate modifier compatibility"
    output:
      canonical_action: "string - normalized action ID"
      entities_involved: "list[string] - entity IDs"
      modifiers: "dict - parsed modifiers"
      confidence: "float 0-1"

  stage_4_context_builder:
    order: 4
    type: "retrieval"
    uses_rag: true
    process:
      - "Retrieve relevant theory passages"
      - "Retrieve historical precedents"
      - "Retrieve recent game_memory events"
      - "Build token-aware context window"
    output:
      context_passages: "list[string]"
      total_tokens: "int"

  stage_5_llm_generation:
    order: 5
    type: "generation"
    uses_rag: false  # Uses context from stage 4
    input:
      system_prompt: "You are a narrator for Babylon..."
      context: "From stage_4"
      player_input: "Sanitized, mapped action"
      game_state: "Current WorldState summary"
    output:
      narrative: "string"

  stage_6_output_validator:
    order: 6
    type: "post_processing"
    uses_rag: true
    checks:
      - "Thematic consistency (no fantasy terms in output)"
      - "Factual accuracy (references match game state)"
      - "Tone consistency (maintains Babylon voice)"
    fallback: "Generic narrative if validation fails"

# =============================================================================
# COMPOSITIONALITY GRAMMAR
# =============================================================================

compositionality:
  principle: >
    Valid player actions = valid verbs + valid objects + valid modifiers.
    This is like a grammar: we define the vocabulary, players construct
    sentences, LLM interprets the semantic combination.

  examples:
    invalid:
      - input: "Cast fireball"
        reason: "No valid verb 'cast', no valid object 'fireball'"

      - input: "Summon alien army"
        reason: "No valid verb 'summon', no valid object 'alien'"

    valid_novel:
      - input: "Organize an underground railroad for workers"
        parsing:
          verb: "organize (ACT_012)"
          object: "workers (ENT_proletariat)"
          modifier: "underground (clandestine)"
        interpretation: "LLM interprets as secret labor movement"

      - input: "Spread samizdat through the factory"
        parsing:
          verb: "spread (ACT_045 - spread_propaganda)"
          object: "factory (ENT_institution_factory)"
          modifier: "samizdat (clandestine literature)"
        interpretation: "LLM interprets as underground publishing"

  creativity_boundary: >
    Creativity comes from novel COMBINATIONS of valid elements.
    The vocabulary constrains, the grammar liberates.

# =============================================================================
# SAFETY NET: OBSERVER PATTERN
# =============================================================================

safety_architecture:
  principle: >
    Even if validation fails, the simulation engine is deterministic.
    The LLM CANNOT change world state directly. It only describes
    what the engine calculates. Worst case is weird narrative,
    but mechanics remain uncorrupted.

  layer_separation:
    engine: "Pure math, no LLM involvement"
    observer: "LLM generates narrative FROM engine output"
    validation: "RAG gates what reaches LLM"

  failure_modes:
    false_positive_reject:
      description: "Valid creative input incorrectly rejected"
      impact: "Frustrating UX"
      mitigation: "Tiered responses with suggestions"

    false_negative_accept:
      description: "Invalid input sneaks through validation"
      impact: "Thematically weird narrative"
      mitigation: "Engine mechanics unaffected, log for analysis"

    injection_success:
      description: "Prompt injection reaches LLM"
      impact: "LLM may produce off-topic output"
      mitigation: "Output validator catches it, engine unaffected"

# =============================================================================
# IMPLEMENTATION NOTES
# =============================================================================

implementation:

  existing_infrastructure:
    chromadb: "src/babylon/rag/ - Already implemented, functional"
    embedding_manager: "OpenAI API with caching and rate limiting"
    retriever: "High-level query interface with similarity scoring"

  required_additions:
    - "Create actions collection (populate from game data)"
    - "Create entities collection (extract from existing JSON)"
    - "Create anti_patterns collection (security corpus)"
    - "Implement validation pipeline stages"
    - "Integrate with Observer Pattern (Phase 3)"

  phase: "3 - AI Observer Layer"

  dependencies:
    - "Observer Protocol (being implemented)"
    - "NarrativeDirector (being implemented)"
    - "EventBus integration (complete)"

# =============================================================================
# PHILOSOPHICAL ALIGNMENT
# =============================================================================

philosophy:
  materialist_grounding: >
    The RAG corpus IS the material conditions. You cannot wish sorcery
    into existence any more than workers can wish away capitalism.
    The constraint is the point.

  dialectical_creativity: >
    Thesis (corpus vocabulary) + Antithesis (player intent) =
    Synthesis (novel combination). The LLM mediates the dialectic.

  observer_principle: >
    AI observes and narrates history. AI does not make history.
    The math makes history. This is historical materialism applied
    to game architecture.
