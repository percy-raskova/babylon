# Babylon Project State
# What exists vs what's planned - KEEP THIS UPDATED

meta:
  version: "2.0.4"
  updated: "2025-12-26"
  last_sprint: "Political Economy of Liquidity - Epoch 1 (The Ledger)"
  principle: "Be honest about what's implemented vs aspirational"
  architecture_model: "Epoch + Slice (supersedes Six-Phase Fractal Evolution)"
  canonical_roadmap: "ai-docs/epochs-overview.md"
  last_audit: "Documentation Accuracy Audit (2025-12-26)"

# =============================================================================
# EPOCH + SLICE STATUS
# =============================================================================
#
# Epochs are playable checkpoints. Slices are complete vertical features.
# See ai-docs/epochs-overview.md for full details.
#
epoch_status:
  current_epoch: 1
  epoch_name: "The Demonstration"
  thesis: "The player watches the Imperial Circuit consume itself and sees the Fascist Bifurcation."

  slices:
    "1.1":
      name: "The Circuit"
      status: "COMPLETE"
      deliverables:
        - "ImperialRentSystem (4-phase extraction)"
        - "SolidaritySystem (consciousness transmission)"
        - "4-node Imperial Circuit scenario"
      files:
        - "src/babylon/engine/systems/economic.py"
        - "src/babylon/engine/systems/solidarity.py"
        - "src/babylon/engine/scenarios.py"

    "1.2":
      name: "The Struggle"
      status: "COMPLETE"
      deliverables:
        - "StruggleSystem (George Floyd Dynamic)"
        - "TerritorySystem (carceral geography)"
        - "Agency Layer mechanics"
      files:
        - "src/babylon/engine/systems/struggle.py"
        - "src/babylon/engine/systems/territory.py"

    "1.3":
      name: "The Observer"
      status: "COMPLETE"
      deliverables:
        - "SimulationObserver protocol"
        - "TopologyMonitor (phase transitions)"
        - "MetricsCollector (unified metrics)"
        - "11 EventTypes"
      files:
        - "src/babylon/engine/observer.py"
        - "src/babylon/engine/topology_monitor.py"
        - "src/babylon/engine/observers/metrics.py"

    "1.4":
      name: "The Rift"
      status: "COMPLETE"  # Core + Integration complete, only dashboard remains
      spec: "ai-docs/metabolic-slice.yaml"
      deliverables_complete:
        - "Territory metabolic fields (biocapacity, max_biocapacity, regeneration_rate, extraction_intensity)"
        - "SocialClass consumption fields (s_bio, s_class, consumption_needs computed)"
        - "WorldState computed properties (total_biocapacity, total_consumption, overshoot_ratio)"
        - "calculate_biocapacity_delta() and calculate_overshoot_ratio() formulas"
        - "ECOLOGICAL_OVERSHOOT EventType"
        - "MetabolismSystem with 15 unit tests"
        - "MetabolismSystem registered in DEFAULT_SYSTEMS (after TerritorySystem)"
        - "Ecological metrics in TickMetrics (overshoot_ratio, total_biocapacity, total_consumption)"
        - "MetricsCollector extracts ecological state from WorldState"
        - "Integration tests proving system runs in engine loop (15 tests)"
        - "MetabolismDefines in GameDefines (entropy_factor, overshoot_threshold, max_overshoot_ratio)"
        - "TopologyDefines in GameDefines (gaseous_threshold, condensation_threshold, vanguard_density_threshold)"
        - "EconomyDefines additions (negligible_rent, negligible_subsidy)"
        - "All magic numbers wired to GameDefines (no hardcoded thresholds in systems)"
      deliverables_remaining:
        - "Dashboard metabolic gauge (Slice 1.5)"
        - "[DEFERRED] Wire ImperialRentSystem to set extraction_intensity (Epoch 2)"
      formula: "ΔB = Regeneration - (Extraction × Entropy_Factor)"
      commits:
        - "090a843: feat(metabolic): add Slice 1.4A material basis"
        - "d215fff: test(metabolic): add comprehensive unit tests for Slice 1.4A"
        - "ada50da: test(metabolic): add TDD Red Phase tests for MetabolismSystem"
        - "fe7feb1: feat(metabolic): implement MetabolismSystem (TDD Green Phase)"
        - "7563101: test(metabolic): add TDD RED phase tests for Sprint 1.4C"
        - "ce5b888: feat(metabolic): wire MetabolismSystem into simulation engine (TDD Green Phase)"
        - "8e2009c: refactor(defines): add MetabolismDefines and TopologyDefines"
        - "e11cf6f: refactor(economic): wire negligible thresholds to GameDefines"
        - "4609e4f: refactor(topology): wire phase thresholds to GameDefines"

    "1.5":
      name: "The Dashboard"
      status: "PARTIAL"
      deliverables_complete:
        - "NiceGUI 4-panel layout"
        - "TrendPlotter, NarrativeTerminal, SystemLog, StateInspector"
        - "Control deck (STEP/PLAY/PAUSE/RESET)"
      deliverables_remaining:
        - "Wire 4-node scenario (currently 2-node)"
        - "4 wealth lines color-coded by class"
        - "Consciousness gap (P_w - C_w)"
        - "Metabolic gauge showing overshoot_ratio"
        - "Gramscian Wire MVP - dual narrative display"
      files:
        - "src/babylon/ui/main.py"
        - "src/babylon/ui/components.py"
      gramscian_wire_mvp:
        spec: "ai-docs/gramscian-wire-mvp.yaml"
        description: "Dual narrative display demonstrating 'neutrality is hegemony'"
        status: "PLANNED"

    "1.6":
      name: "The Endgame"
      status: "NOT_STARTED"
      deliverables_planned:
        - "ECOLOGICAL_OVERSHOOT detection"
        - "Solidarity check at crisis moment"
        - "Win/lose display (Revolutionary vs Fascist Path)"
        - "Bondi Algorithm narration"

  completion_criteria:
    - "[ ] 4-node Imperial Circuit running in dashboard"
    - "[x] MetabolismSystem depletes biocapacity over time (Sprint 1.4B)"
    - "[x] MetabolismSystem registered in engine (Sprint 1.4C)"
    - "[x] Ecological metrics collected by MetricsCollector (Sprint 1.4C)"
    - "[ ] ECOLOGICAL_OVERSHOOT fires at ~30-50 ticks"
    - "[ ] Dashboard shows rift widening visually"
    - "[ ] Endgame screen displays outcome based on solidarity"
    - "[x] Tests pass (current: 2464)"

  future_epochs:
    epoch_2:
      name: "The Game"
      thesis: "The player has agency. Decisions matter. Multiple endings."
      structure: "Staged into 4 sub-epochs (2A/2B/2C/2D) per epoch-readiness-review.yaml"

      sub_epochs:
        "2A":
          name: "Core Agency"
          thesis: "The player can act. Resources constrain choices."
          slices: ["2.1", "2.2a", "2.6"]
          status: "PLANNED"
        "2B":
          name: "Organization"
          thesis: "The party can fail from within. Class composition matters."
          slices: ["2.2b", "2.3", "2.8"]
          status: "PLANNED"
          scope_note: "Doctrine System simplified to 3 trunks for 2B MVP"
        "2C":
          name: "Information"
          thesis: "Win the narrative, know the terrain."
          slices: ["2.5", "2.9", "2.10"]
          status: "PLANNED"
          critical_gap: "State AI decision logic must be defined before implementation"
        "2D":
          name: "Combat"
          thesis: "Violence is the continuation of politics."
          slices: ["2.7"]
          status: "PLANNED"
          note: "Combat is last because it requires all other systems"

      slices:
        "2.1": { name: "Demographic Resolution", sub_epoch: "2A", spec: "ai-docs/demographics-spec.yaml" }
        "2.2a": { name: "Strategy Layer", sub_epoch: "2A", spec: "ai-docs/strategy-layer.yaml" }
        "2.2b": { name: "The Vanguard", sub_epoch: "2B", spec: "ai-docs/cohesion-mechanic.yaml" }
        "2.3": { name: "Reactionary Subject", sub_epoch: "2B", spec: "ai-docs/reactionary-subject.yaml" }
        "2.4": { name: "Reproductive Labor", sub_epoch: "DEFERRED", status: "CONCEPTUAL" }
        "2.5": { name: "The Wire", sub_epoch: "2C", spec: "ai-docs/gramscian-wire-vision.yaml" }
        "2.6": { name: "Resource Economy", sub_epoch: "2A", spec: "ai-docs/vanguard-economy.yaml" }
        "2.7": { name: "Kinetic Warfare", sub_epoch: "2D", spec: "ai-docs/kinetic-warfare.yaml" }
        "2.8": { name: "Doctrine System", sub_epoch: "2B", spec: "ai-docs/doctrine-tree.yaml" }
        "2.9": { name: "The Panopticon", sub_epoch: "2C", spec: "ai-docs/state-attention-economy.yaml" }
        "2.10": { name: "Epistemic Horizon", sub_epoch: "2C", spec: "ai-docs/fog-of-war.yaml" }
        "2.11": { name: "Multiple Scenarios", sub_epoch: "DEFERRED", status: "CONCEPTUAL" }

    epoch_3:
      name: "The Platform"
      thesis: "Others can build on this. Modding, custom scenarios, educational tools."
      slices:
        "3.1": "Liberation Mechanics"
        "3.2": "Scenario Editor"
        "3.3": "Modding API"

# =============================================================================
# IMPLEMENTATION STATUS
# =============================================================================

implemented:

  data_layer:
    status: "functional"
    components:
      json_data_files:
        status: "complete"
        details: "17 entity collections migrated from XML"
        location: "src/babylon/data/game/*.json"

      json_schemas:
        status: "complete"
        details: "Draft 2020-12 schemas for all entities"
        location: "src/babylon/schemas/"
        validation: "poetry run python tools/validate_schemas.py"

      pydantic_models:
        status: "partial"
        details: "Some models exist, not all entities covered"
        location: "src/babylon/data/models/"

      database:
        status: "configured"
        details: "SQLite setup, no tables populated yet"
        location: "src/babylon/data/database.py"

  core_logic:
    status: "complete"
    components:
      simulation_engine:
        status: "complete"
        details: "Modular engine with 7 Systems, ServiceContainer DI, typed events"
        location: "src/babylon/engine/simulation_engine.py"
        tests: "tests/unit/engine/test_simulation_engine.py (30+ tests)"
        architecture:
          - "SimulationEngine.run_tick(graph, services, context)"
          - "7 Systems: ImperialRent, Solidarity, Consciousness, Survival, Struggle, Contradiction, Territory"
          - "ServiceContainer: config, database, event_bus, formulas, defines"
          - "_convert_bus_event_to_pydantic(): EventBus → typed SimulationEvent (13 event classes)"
          - "Observer event injection via persistent_context['_observer_events']"

      service_container:
        status: "complete"
        details: "Dependency injection container for all services"
        location: "src/babylon/engine/services.py"
        tests: "tests/unit/engine/test_services.py"
        provides:
          - "config: SimulationConfig"
          - "database: DatabaseConnection"
          - "event_bus: EventBus"
          - "formulas: FormulaRegistry"

      event_bus:
        status: "complete"
        details: "Publish/subscribe event system with 11 EventTypes"
        location: "src/babylon/engine/event_bus.py"
        tests: "tests/unit/engine/test_event_bus.py (20 tests)"
        events_published:
          - "SURPLUS_EXTRACTION - imperial rent extracted"
          - "IMPERIAL_SUBSIDY - subsidy paid to comprador"
          - "ECONOMIC_CRISIS - crisis event triggered"
          - "CONSCIOUSNESS_TRANSMISSION - ideology transmitted via solidarity"
          - "MASS_AWAKENING - threshold crossed"
          - "EXCESSIVE_FORCE - spark event (George Floyd Dynamic)"
          - "UPRISING - revolt triggered"
          - "SOLIDARITY_SPIKE - solidarity infrastructure built"
          - "RUPTURE - tension reaches 1.0"
          - "SOLIDARITY_AWAKENING - source enters struggle"
          - "PHASE_TRANSITION - percolation state changes"

      formula_registry:
        status: "complete"
        details: "Hot-swappable formula lookup with 12 registered formulas"
        location: "src/babylon/engine/formula_registry.py"
        tests: "tests/unit/engine/test_formula_registry.py (14 tests)"

      systems:
        status: "complete"
        details: "4 modular System implementations"
        location: "src/babylon/engine/systems/"
        components:
          protocol: "System protocol with step(graph, services, context)"
          imperial_rent: "ImperialRentSystem - economic extraction"
          consciousness: "ConsciousnessSystem - ideology drift"
          survival: "SurvivalSystem - P(S|A) and P(S|R)"
          contradiction: "ContradictionSystem - tension accumulation"

      simulation_facade:
        status: "complete"
        details: "Stateful wrapper for multi-tick simulations"
        location: "src/babylon/engine/simulation.py"
        tests: "tests/unit/engine/test_simulation_facade.py (19 tests)"
        provides:
          - "Simulation.step() - advance one tick"
          - "Simulation.run(n) - run n ticks"
          - "Simulation.get_history() - all state snapshots"

      entity_factories:
        status: "complete"
        details: "Factory functions for entity creation"
        location: "src/babylon/engine/factories.py"
        tests: "tests/unit/engine/test_factories.py (30 tests)"
        provides:
          - "create_proletariat() - exploited class"
          - "create_bourgeoisie() - exploiter class"

      world_state:
        status: "complete"
        details: "Immutable state with NetworkX graph conversion, state_finances integration"
        location: "src/babylon/models/world_state.py"
        tests: "tests/unit/models/test_world_state.py (41 tests)"
        state_finances_integration:
          field: "state_finances: dict[str, StateFinance]"
          graph_storage: "G.graph['state_finances'] metadata"
          tests: "TestStateFinancesIntegration (6 tests)"

      finance_models:
        status: "complete"
        details: "Political Economy of Liquidity - Epoch 1 (The Ledger)"
        spec: "ai-docs/political-economy-liquidity.yaml"
        location: "src/babylon/models/entities/"
        tests: "tests/unit/models/ (187 tests)"
        models:
          state_finance:
            location: "src/babylon/models/entities/state_finance.py"
            fields: ["treasury", "police_budget", "social_reproduction_budget", "tax_rate", "tribute_income", "debt_level", "debt_ceiling"]
            computed: ["burn_rate"]
            tests: "test_state_finance.py (55 tests)"
          revolutionary_finance:
            location: "src/babylon/models/entities/revolutionary_finance.py"
            fields: ["war_chest", "operational_burn", "dues_income", "expropriation_income", "donor_income", "heat", "reformist_drift"]
            tests: "test_revolutionary_finance.py (56 tests)"
          precarity_state:
            location: "src/babylon/models/entities/precarity_state.py"
            fields: ["nominal_wage", "ppp_factor", "inflation_index", "subsistence_threshold", "organization"]
            computed: ["real_wage", "precarity_index", "proletarianization_risk"]
            tests: "test_precarity_state.py (65 tests)"
        cost_checking:
          location: "src/babylon/engine/simulation_engine.py"
          behavior: "Logs warning when treasury < burn_rate"
          tests: "TestCostChecking (5 tests)"

      simulation_config:
        status: "complete"
        details: "Frozen config with all formula coefficients"
        location: "src/babylon/models/config.py"
        tests: "tests/unit/models/test_config.py (42 tests)"

      formulas:
        status: "complete"
        details: "All MLM-TW formulas implemented and tested"
        location: "src/babylon/systems/formulas.py (348 lines)"
        tests: "tests/unit/formulas/ (40 tests)"
        includes:
          - "calculate_imperial_rent() - consciousness-dependent extraction"
          - "calculate_acquiescence_probability() - P(S|A) sigmoid"
          - "calculate_revolution_probability() - P(S|R)"
          - "calculate_consciousness_drift() - dΨ/dt ideology change"

      scenarios:
        status: "complete"
        details: "Factory functions for test scenarios"
        location: "src/babylon/engine/scenarios.py"
        includes:
          - "create_two_node_scenario()"
          - "create_high_tension_scenario()"
          - "create_labor_aristocracy_scenario()"

      history_persistence:
        status: "complete"
        details: "History stack, file I/O, auto-checkpointing"
        location: "src/babylon/engine/history/"
        tests: "tests/unit/engine/history/ (123 tests)"
        includes:
          - "HistoryStack - undo/redo with max_depth pruning"
          - "save_state/load_state - WorldState file I/O"
          - "save_checkpoint/load_checkpoint - full state + config + metadata"
          - "AutoCheckpointer - interval-based automatic saves"
          - "Atomic writes - temp file + rename pattern"

      contradiction_analysis:
        status: "partial"
        details: "ContradictionAnalysis class exists, basic methods work"
        location: "src/babylon/systems/contradiction_analysis.py"
        note: "Legacy - tension now tracked on Relationship edges"

  ai_layer:
    status: "partial"
    components:
      observer_protocol:
        status: "complete"
        details: "SimulationObserver protocol with lifecycle hooks"
        location: "src/babylon/engine/observer.py"
        tests: "tests/unit/engine/test_observer_pattern.py (32 tests)"
        provides:
          - "SimulationObserver protocol (@runtime_checkable)"
          - "on_simulation_start(initial_state, config)"
          - "on_tick(previous_state, new_state)"
          - "on_simulation_end(final_state)"
        implementations:
          - "NarrativeDirector - AI narrative generation"
          - "TopologyMonitor - phase transition detection"
          - "EconomyMonitor - economic crisis detection"
          - "CausalChainObserver - Shock Doctrine patterns"
          - "MetricsCollector - unified metrics for dashboard/sweeper (Sprint 4.1)"

      narrative_director:
        status: "complete"
        details: "AI Game Master that observes simulation and generates narrative using typed SimulationEvent objects"
        location: "src/babylon/ai/director.py"
        tests: "tests/unit/ai/test_narrative_director.py, test_director_rag.py, tests/integration/test_narrative_pipeline.py (36 tests)"
        provides:
          - "NarrativeDirector class implementing SimulationObserver"
          - "RAG pipeline injection (optional)"
          - "Prompt builder injection (optional)"
          - "Error handling per ADR003"
          - "Typed event consumption via state.events (Sprint 4.1)"
          - "SEMANTIC_MAP with EventType enum keys for theoretical context"
          - "SIGNIFICANT_EVENT_TYPES frozenset for narrative triggering"
        sprint_4_1_changes:
          - "Changed on_tick to use state.events instead of event_log strings"
          - "SEMANTIC_MAP now uses EventType enum keys"
          - "Added SIGNIFICANT_EVENT_TYPES: ECONOMIC_CRISIS, PHASE_TRANSITION, UPRISING, EXCESSIVE_FORCE, RUPTURE"
          - "_retrieve_context_from_typed_events() method for semantic bridge"

      prompt_builder:
        status: "complete"
        details: "Builds prompts following Marxist dialectical materialism with typed event formatting"
        location: "src/babylon/ai/prompt_builder.py"
        tests: "tests/unit/ai/test_prompt_builder.py, tests/integration/test_narrative_pipeline.py"
        provides:
          - "DialecticalPromptBuilder class"
          - "build_system_prompt() - AI identity"
          - "build_context_block(state, rag_context, events: list[SimulationEvent])"
          - "_calculate_tension() - aggregate tension level"
          - "_format_event() - typed event formatting with match/case (Sprint 4.1)"
        sprint_4_1_changes:
          - "Changed events param type from list[str] to list[SimulationEvent]"
          - "Added _format_event() method with match/case for all event types"
          - "PhaseTransitionEvent includes phase state and cadre_density"
          - "CrisisEvent includes pool_ratio and decision"
          - "SparkEvent includes trigger_type and node_id"
          - "UprisingEvent includes participants count"

      rag_pipeline:
        status: "infrastructure_complete"
        details: "RAG query pipeline implemented, but NO DATA populated"
        location: "src/babylon/rag/rag_pipeline.py"
        tests: "RAG module tests"
        provides:
          - "RagPipeline.query(text, top_k) → QueryResponse"
          - "Sync wrapper for async operations"
        missing: "Corpus data - ChromaDB is empty, no documents to retrieve"

      chromadb:
        status: "configured"
        details: "ChromaDB 1.x API with PersistentClient"
        location: "src/babylon/data/chroma_manager.py"
        api_version: "1.3.5 (modern PersistentClient API)"
        collections_defined:
          - "THEORY_COLLECTION: marxist_theory (EMPTY)"
          - "HISTORY_COLLECTION: game_history (EMPTY)"
          - "ENTITIES_COLLECTION: entity_embeddings (EMPTY)"
        missing: "Document ingestion pipeline, corpus data"

      llm_client:
        status: "not_implemented"
        details: "No LLM provider integration yet"
        priority: "CRITICAL - Sprint 3.3"
        primary_choice: "DeepSeek API (OpenAI-compatible, cost-effective)"
        fallback_options:
          - "Ollama HTTP API (local models)"
          - "Anthropic SDK (Claude)"

  tooling:
    status: "functional"
    components:
      xml_migration:
        status: "complete"
        location: "tools/migrate_xml_to_json.py"

      schema_validation:
        status: "complete"
        location: "tools/validate_schemas.py"

      testing:
        status: "configured"
        details: "Pytest with markers, some tests exist"

      linting:
        status: "configured"
        details: "Ruff + MyPy strict"

# =============================================================================
# NOT YET IMPLEMENTED
# =============================================================================

not_implemented:

  llm_provider:
    priority: "critical"
    description: "LLM client abstraction for Claude/Ollama"
    blockers: "None - ready to implement"
    phase: 3
    sprint: "3.3"
    estimated_lines: 200

  event_generation:
    priority: "high"
    description: "Systems emit events for wealth transfer, ideology drift"
    blockers: "None - architecture supports it"
    phase: 3
    sprint: "3.3"
    details: |
      Currently only ContradictionSystem emits events (rupture).
      ImperialRentSystem needs to emit exploitation events for narrative.
    estimated_lines: 30

  rag_corpus:
    priority: "medium"
    description: "Marxist theory documents for RAG retrieval"
    blockers: "None"
    phase: 3
    sprint: "3.3"
    source: "Marxists.org archive (user has full corpus available)"
    mvp_selection:
      description: "Curated minimal corpus for vertical slice"
      recommended_texts:
        - title: "Wage Labour and Capital"
          author: "Karl Marx (1847)"
          relevance: "Core explanation of surplus value extraction - directly maps to Imperial Rent"
          url: "https://www.marxists.org/archive/marx/works/1847/wage-labour/"
        - title: "Value, Price and Profit"
          author: "Karl Marx (1865)"
          relevance: "Accessible explanation of exploitation mechanics"
          url: "https://www.marxists.org/archive/marx/works/1865/value-price-profit/"
        - title: "Erta Klas - Principles of Communism"
          author: "Frederick Engels (1847)"
          relevance: "Q&A format, good for chunking, covers class relations"
          url: "https://www.marxists.org/archive/marx/works/1847/11/prin-com.htm"
        - title: "Imperialism, the Highest Stage of Capitalism (Chapters 1-4)"
          author: "V.I. Lenin (1917)"
          relevance: "Core theory for Imperial Rent and core-periphery dynamics"
          url: "https://www.marxists.org/archive/lenin/works/1916/imp-hsc/"
        - title: "The Wretched of the Earth (Chapter 1)"
          author: "Frantz Fanon (1961)"
          relevance: "Third Worldist perspective on colonial extraction"
          url: "https://www.marxists.org/subject/africa/fanon/"
      estimated_chunks: "~200-500 chunks from 5 texts"
      ingestion_approach: "Simple script to fetch, chunk, embed, store in ChromaDB"

  vertical_slice_testing:
    priority: "high"
    description: "Integration tests proving full narrative pipeline"
    blockers: "LLM provider"
    phase: 3
    sprint: "3.3"
    approach: "Pytest integration tests instead of CLI runner"
    rationale:
      - "Programmatic verification of data flow"
      - "Reproducible in CI/CD"
      - "Assertions on narrative generation"
      - "No manual interaction required"
    test_scenarios:
      - "test_narrative_generated_on_exploitation_event"
      - "test_rag_context_included_in_prompt"
      - "test_deepseek_api_called_with_correct_format"
      - "test_full_vertical_slice_10_ticks"

  ui:
    priority: "active"
    description: "Developer Dashboard MVP - 4-panel layout operational"
    status: "FUNCTIONAL"
    phase: 4
    pattern: "root_function"  # Use ui.run(main_page), NOT @ui.page decorator
    components:
      control_deck:
        status: "complete"
        location: "src/babylon/ui/controls.py"
        tests: "tests/unit/ui/test_controls.py (20 tests)"
        features:
          - "STEP button - advance 1 tick"
          - "PLAY button - start continuous loop"
          - "PAUSE button - stop loop"
          - "RESET button - reload simulation"
          - "Tick counter - TICK: 000 format"
        styling: "Cybernetic Terminal - dark bg, green text, monospace"
      main_app:
        status: "complete"
        location: "src/babylon/ui/main.py"
        tests: "tests/unit/ui/test_main.py"
        note: "Uses root function pattern to avoid NiceGUI mode conflict"
        layout: "3-column CSS Grid (1fr 2fr 1fr) with flex children"
      dashboard_components:
        status: "complete"
        location: "src/babylon/ui/components.py"
        tests: "tests/unit/ui/test_components.py (100+ tests)"
        components:
          trend_plotter: "ECharts time-series metrics (left panel)"
          narrative_terminal: "Typewriter narrative display (center top)"
          system_log: "Event log with auto-scroll (center bottom)"
          state_inspector: "JSON editor for WorldState (right panel)"
      async_runner:
        status: "complete"
        location: "src/babylon/engine/async_runner.py"
        tests: "tests/unit/engine/test_async_runner.py"
        purpose: "Non-blocking simulation for responsive UI during PLAY mode"
        pattern: "Background thread with queue for UI callbacks"
      subcutaneous_tests:
        status: "complete"
        location: "tests/integration/test_dashboard_integration.py"
        purpose: "Integration tests with mocked NiceGUI components"
        pattern: "Mock UI, test component logic without browser"
    layout_fix_2025_12_25:
      issue: "CSS Grid/Flexbox interaction - grid cell widths not propagating to flex-1 children"
      root_cause: "flex-1 elements inside grid cells collapse to zero width without explicit w-full"
      solution: "Add w-full class to all column and element wrappers in grid cells"
      pattern: "grid cell → column with w-full → element with w-full + flex-1"
      files_changed:
        - "src/babylon/ui/main.py (grid layout)"
        - "src/babylon/ui/components.py (component containers)"
        - "src/babylon/ui/terminal.py (terminal container)"
    blockers: "None - Dashboard operational"

  branching_history:
    priority: "low"
    description: "Timeline branching for history stack (branch_id, create_branch)"
    blockers: "None - deferred for simplicity"
    notes: "Current linear history sufficient; add branching if needed for UI"

  sanity_spies:
    priority: "low"
    description: "Runtime invariant validators (Babylon Protocol)"
    blockers: "Event bus for integration"
    design_doc: "brainstorm/babylon-protocol-verification.md"

# =============================================================================
# PLANNED FEATURES (BRAINSTORM)
# =============================================================================

planned:

  gramscian_wiki:
    status: "brainstorm"
    location: "brainstorm/gramscian-wiki-engine.md"
    description: "Hegemony as factional control over in-game wiki"
    dependencies: ["jinja2", "markdown renderer"]

  llm_tech_tree:
    status: "implemented"
    location: "src/babylon/data/technologies.json (T006-T011)"
    description: "AI as dual-use technology in game mechanics"

# =============================================================================
# FUTURE CONCEPTS (QUARANTINED IDEAS)
# =============================================================================

future_concepts:

  layer_0_pivot:
    phase: 3.5
    status: "brainstorm"
    description: |
      Layer 0 Pivot: Future refactor to ground all Social Graph (Topology) nodes
      onto a Spatial Graph (Territory). Moves from abstract 'Factions' to
      'Territory-bound Factions' with Host/Parasite tenure systems.

      Key insight: Political power has material basis in territorial control.
      The question "who controls this neighborhood?" precedes "who has ideology?"
    key_components:
      - "Strategic Sectors: territorial units (Slums, Financial District, Factory Zone)"
      - "Subversive Tenancy: De Facto control while enemy holds Legal control"
      - "Suspicion metric: probability of Eviction Event triggering"
      - "Enclosure: converting communal tenure to private (primitive accumulation)"
    dependencies: ["Phase 3.4 Imperial Circuit stable"]

  vanguard_economy:
    phase: 4
    status: "brainstorm"
    location: "brainstorm/mechanics/vanguard_economy.md"
    description: |
      Implementation of Cadre/Sympathizer distinction and Coherence mechanics.
      Moves away from generic "mana" to materialist simulation of Organization vs Movement.
      Key mechanic: Coherence Factor derived from Cadre:Sympathizer ratio.
      Player trap: "Influencer Trap" - farming Reputation faster than training Cadre
      leads to massive but uncontrollable mob during historical rupture.
    resources:
      - "Cadre Labor (CL): Deterministic, high-value, structural actions"
      - "Sympathizer Labor (SL): Stochastic, mass volume, mass actions"
      - "Reputation: Multiplier for SL volume (not quality)"
    formula: "Effective Output = (SL * Reputation) * Coherence Factor"
    dependencies: ["Phase 3.4 Imperial Circuit complete"]

  kinetic_warfare:
    phase: 5
    status: "brainstorm"
    location: "brainstorm/mechanics/kinetic_warfare.md"
    description: |
      Asymmetric combat focusing on infrastructure sabotage, supply chain interdiction,
      and risk/blowback calculation (Civilian harm vs. State damage).
      Not modeling frontlines (Hearts of Iron) but System Disruption and Insurgency.
      Combat occurs on Layer 0 Spatial Graph (Nodes and Edges).
    target_triad:
      - "Nodes of Extraction: Industrial farms, mines, logistics hubs (starve State of resources)"
      - "Edges of Circulation: Power lines, fiber cables, highways (Social Blowback mechanic)"
      - "Nodes of Realization: Data centers, arms factories, command bunkers (QRF threat)"
    gameplay_loop:
      - "Reconnaissance: Reveal hidden attributes (Defense, Connectivity, Collateral Risk)"
      - "Preparation: Cultivate local sympathy (Human Shield effect)"
      - "Strike: Auto-resolved tactical resolution based on Force correlations"
      - "Fallout: Calculate Consciousness shift and State Repression"
    dependencies: ["Layer 0 Spatial Graph", "Consciousness Vector"]

# =============================================================================
# CURRENT FOCUS
# =============================================================================

current_focus:
  primary: "Epoch 1: The Demonstration - completing Slices 1.4-1.6"
  roadmap: "ai-docs/epochs-overview.md"
  legacy_roadmap: "brainstorm/plans/four-phase-engine-blueprint.md (DEPRECATED)"
  legacy_phase_roadmap: "ai-docs/roadmap.md (DEPRECATED - see epochs-overview.md)"
  architecture_spec: "ai-docs/game-loop-architecture.yaml"
  verification_framework: "brainstorm/babylon-protocol-verification.md"

  current_slice:
    epoch: 1
    slice: "1.5"
    name: "The Dashboard"
    spec: "ai-docs/state.yaml (Slice 1.5 section)"
    goal: "Wire 4-node Imperial Circuit to dashboard, add metabolic gauge"
    previous_slice:
      slice: "1.4"
      name: "The Rift"
      status: "COMPLETE"
      note: "MetabolismSystem integrated, ecological metrics collected"

  epoch_1_scope:
    description: "Playable demo showing Imperial Circuit self-destruction"
    thesis: "The player watches the Imperial Circuit consume itself and sees the Fascist Bifurcation."
    entities: "4-node Imperial Circuit: P_w, P_c, C_b, C_w"
    phenomenon: "Metabolic rift → ecological overshoot → crisis resolution"
    outcome: "Win (solidarity) or Lose (fascism) based on solidarity_strength"

  recently_completed:
    - "XML to JSON migration"
    - "JSON Schema system (36 schemas)"
    - "Schema validation tooling"
    - "LLM technology entries (T006-T011)"
    - "Project rename to Babylon"
    - "AI documentation system (ai-docs/)"
    - "Four-phase engine blueprint"
    - "Sprint 1: Types & Enums (Probability, Currency, Ideology, etc.)"
    - "Sprint 1: StrEnums (SocialRole, EdgeType, IntensityLevel, ResolutionType)"
    - "Tech debt cleanup: Migrated dataclasses to Pydantic"
    - "Created src/babylon/models/entities/ (Effect, Contradiction, Trigger)"
    - "Deleted old files: data/models/contradiction.py, data/models/trigger.py, core/contradiction.py"
    - "Sprint 2: SocialClass entity model (Phase 1 node)"
    - "Sprint 2: Relationship entity model (Phase 1 edge)"
    - "Phase 1 integration tests (11 tests proving the equations)"
    - "Phase 2 architecture design (Data/Logic separation)"
    - "Created ai-docs/game-loop-architecture.yaml"
    - "Created brainstorm/plans/phase2-game-loop-design.md"
    - "ADR010: Direct Entities + Formulas architecture (bypass Economy/Politics)"
    - "Gap analysis: 8 gaps identified and resolved"
    - "Formula-to-Entity wiring specification documented"
    - "ADR011: Pure Graph Architecture (multi-AI consensus: Claude + Gemini)"
    - "Decision: Delete Economy/Politics classes (not preserve)"
    - "Decision: NetworkX from day one (not deferred)"
    - "Decision: Hybrid state management (Snapshots + Events)"
    - "Sprint 3: SimulationConfig model (42 tests)"
    - "Sprint 4: WorldState with NetworkX integration (35 tests)"
    - "Sprint 5: SimulationEngine step() function (19 tests)"
    - "Sprint 6: Factory functions and integration tests (20 tests)"
    - "Sprint 7: Deleted Economy/Politics classes per ADR011"
    - "PHASE 2 COMPLETE: 318 tests passing, deterministic game loop"
    - "Sprint 7.5: Consciousness Drift integration (7 tests, 325 total)"
    - "Brainstorm: Babylon Protocol - emergence vs bugs verification framework"
    - "Sprint 7.6: Configurable tension rate + consciousness feedback tests (5 tests, 330 total)"
    - "Sprint 8: History Stack with File I/O and Auto-Checkpointing (123 tests, 453 total)"
    - "Sprint 9: Component System (Material, Vitality, Spatial, Ideological, Organization)"
    - "Sprint 10: ServiceContainer dependency injection (Sprint 3 architecture)"
    - "Sprint 11: System Protocol and 4 System implementations"
    - "Sprint 12: Simulation facade and entity factories (57 tests, 704 total)"
    - "Integration Proof: 100-tick simulation proves wealth transfer dynamics"
    - "Sprint 3.1: Observer Pattern - SimulationObserver protocol (32 tests, 736 total)"
    - "Sprint 3.2: RAG Integration - RagPipeline injection into NarrativeDirector (27 tests, 763 total)"
    - "Tech debt: Fixed 90 mypy errors in RAG module (Mikado refactor)"
    - "Tech debt: Migrated ChromaDB API from deprecated Client to PersistentClient"
    - "Sprint 3.1 Event Schema: src/babylon/models/events.py (SimulationEvent, ExtractionEvent)"
    - "Sprint 3.1 Event Schema: WorldState.events: list[SimulationEvent] field"
    - "Sprint 3.1 Event Schema: _convert_bus_event_to_pydantic() in SimulationEngine"
    - "Sprint 3.1 Event Schema: DomainFactory.create_extraction_event(), Assert.has_event()"
    - "Sprint 3.1+ Event Expansion: Added RUPTURE to EventType enum"
    - "Sprint 3.1+ Event Expansion: 3 base classes (ConsciousnessEvent, StruggleEvent, ContradictionEvent)"
    - "Sprint 3.1+ Event Expansion: 8 concrete events (SubsidyEvent, CrisisEvent, TransmissionEvent, MassAwakeningEvent, SparkEvent, UprisingEvent, SolidaritySpikeEvent, RuptureEvent)"
    - "Sprint 3.1+ Event Expansion: _convert_bus_event_to_pydantic() handles all 10 EventTypes"
    - "Sprint 3.1+ Event Expansion: Factory methods for all event types in DomainFactory"
    - "Sprint 3.3 Topology Events: Added PHASE_TRANSITION to EventType (now 11 types)"
    - "Sprint 3.3 Topology Events: TopologyEvent and PhaseTransitionEvent models"
    - "Sprint 3.3 Topology Events: TopologyMonitor phase state tracking (_classify_phase)"
    - "Sprint 3.3 Topology Events: TopologyMonitor.get_pending_events() for event collection"
    - "Sprint 3.3 Topology Events: Simulation facade _collect_observer_events()"
    - "Sprint 3.3 Topology Events: Observer events injected into next tick via persistent_context"
    - "Sprint 3.3 4-Phase Model: Added cadre_density to TopologySnapshot and PhaseTransitionEvent"
    - "Sprint 3.3 4-Phase Model: _classify_phase updated for gaseous/transitional/liquid/solid"
    - "Sprint 3.3 4-Phase Model: Solid phase (cadre_density >= 0.5) distinguishes vanguard from mass movement"
    - "Sprint 4.1 Narrative Bridge: PromptBuilder.build_context_block accepts list[SimulationEvent]"
    - "Sprint 4.1 Narrative Bridge: Added _format_event() method with match/case for all event types"
    - "Sprint 4.1 Narrative Bridge: NarrativeDirector.on_tick uses state.events instead of event_log"
    - "Sprint 4.1 Narrative Bridge: SEMANTIC_MAP changed from string keys to EventType enum keys"
    - "Sprint 4.1 Narrative Bridge: Added SIGNIFICANT_EVENT_TYPES frozenset for narrative filtering"
    - "Phase 4 UI: AsyncSimulationRunner for non-blocking UI during PLAY mode"
    - "Phase 4 UI: Subcutaneous integration tests for dashboard components"
    - "Phase 4 UI: 4-panel dashboard layout with TrendPlotter, NarrativeTerminal, SystemLog, StateInspector"
    - "Phase 4 UI: CSS Grid/Flexbox width propagation fix (w-full on flex-1 children in grid cells)"
    - "Phase 4.1: MetricsCollector observer - unified metrics for dashboard/sweeper (TDD: 101 tests)"
    - "Phase 4.1: Metrics Pydantic models (EntityMetrics, EdgeMetrics, TickMetrics, SweepSummary)"
    - "Phase 4.1: Dashboard integration - MetricsCollector registered as Simulation observer"
    - "Political Economy of Liquidity Epoch 1: StateFinance model (55 tests)"
    - "Political Economy of Liquidity Epoch 1: RevolutionaryFinance model (56 tests)"
    - "Political Economy of Liquidity Epoch 1: PrecarityState model with computed fields (65 tests)"
    - "Political Economy of Liquidity Epoch 1: WorldState.state_finances integration (6 tests)"
    - "Political Economy of Liquidity Epoch 1: Cost-checking in step() (5 tests)"

  current_phase:
    name: "Phase 3.4: The Imperial Circuit"
    status: "IN PROGRESS - Sprint 3.4.3 next"
    goal: "Expand 2-node model to 4-node with true MLM-TW dynamics"
    tech: "SolidaritySystem + Multi-dimensional consciousness + Fascist Bifurcation"
    result_so_far: "886 tests passing, Imperial Circuit operational, Proletarian Internationalism complete"
    key_insight: "solidarity_strength stored on edge, not auto-calculated - enables Fascist Bifurcation"
    mantras:
      - "The bomb factory pays well. That's the problem."
      - "Agitation without solidarity produces fascism, not revolution."
    completed_sprints:
      sprint_3_1:
        name: "The Dialectical Interface"
        status: "COMPLETE"
        deliverables:
          - "SimulationObserver protocol"
          - "NarrativeDirector implementation"
          - "Observer lifecycle hooks"
        tests_added: 32
      sprint_3_2:
        name: "The Materialist Retrieval"
        status: "COMPLETE"
        deliverables:
          - "DialecticalPromptBuilder"
          - "RAG pipeline injection"
          - "Context hierarchy assembly"
        tests_added: 27
    remaining_work:
      sprint_3_3:
        name: "LLM Integration (Vertical Slice)"
        status: "NOT STARTED"
        deliverables:
          - "LLM Provider protocol + implementations"
          - "Event generation in ImperialRentSystem"
          - "Static theoretical quotes fallback"
          - "Vertical slice CLI runner"
    architecture: "Observer reads state, builds context, calls LLM, outputs narrative"

  previous_phase:
    name: "Phase 2: The Topological Engine"
    status: "COMPLETE"
    goal: "Game loop that runs equations forward in time"
    tech: "Pure Python, Pydantic, Pytest - NO UI, NO AI"
    result: "704 tests passing, modular System architecture, all feedback loops proven"
    key_insight: "Separate Data (WorldState) from Logic (SimulationEngine)"
    key_decisions:
      - "ADR010 - Direct Entities + Formulas"
      - "ADR011 - Pure Graph Architecture (multi-AI consensus)"
    feedback_loops_proven:
      - "Rent Spiral - extraction impoverishes worker"
      - "Consciousness Drift - exploited workers become revolutionary"
      - "Consciousness Resistance - revolutionary workers resist extraction"
      - "Repression Trap - high repression delays but doesn't prevent revolution"
      - "Tension Accumulation - wealth gap increases contradiction tension"
    architecture: "Graph + Math = History"

  next_phase:
    name: "Phase 3.4: The Imperial Circuit"
    goal: "Expand 2-node model to 4-node model with true MLM-TW dynamics"
    tech: "WAGES edge type + Multi-dimensional consciousness"
    spec: "ai-docs/imperial-circuit.yaml"
    rationale: |
      The 2-node model is "orthodox book-worship Marxism" - too simple.
      It correctly models periphery dynamics (exploitation → consciousness → revolution)
      but fails to capture WHY core workers support imperialism: they benefit from it.
      "The bomb factory pays well. That's the problem."
    key_components:
      - "4 nodes: P_w (periphery worker), P_c (comprador), C_b (core bourgeoisie), C_w (core worker)"
      - "WAGES edge: C_b → C_w (super-wages funded by imperial rent)"
      - "TRIBUTE edge: P_c → C_b (imperial rent transfer)"
      - "Multi-dimensional consciousness: class_consciousness + national_identity + atomization"
      - "W/V ratio determining consciousness direction (up for periphery, down for core)"
    sprints:
      3_4_1: "WAGES Edge Type - enable super-wage flow"
      3_4_2: "4-Node Scenario - create_imperial_circuit_scenario()"
      3_4_3: "Multi-Dimensional Consciousness - split ideology variable"
      3_4_4: "Dynamic Balance - shrinking pool, bourgeoisie choices"
    blockers: "None - Phase 3.3 vertical slice provides foundation"

  phase_3_5:
    name: "Phase 3.5: The Territorial Foundation (Layer 0)"
    status: "COMPLETE"
    goal: "Ground all Social Graph nodes onto a Spatial Graph (Territory)"
    tech: "Spatial Graph + Host/Parasite tenure + Enclosure mechanics"
    key_components:
      - "Strategic Sectors - territorial units (Slums, Financial District, etc.)"
      - "Subversive Tenancy - De Facto control while enemy holds Legal control"
      - "Suspicion metric - likelihood of Eviction Event"
      - "Enclosure mechanics - converting communal to private tenure"
    architectural_insight: |
      Layer 0 Pivot: Refactor to ground all Social Graph (Topology) nodes onto
      a Spatial Graph (Territory). Moves from abstract 'Factions' to
      'Territory-bound Factions' with Host/Parasite tenure systems.
      This enables modeling geographic class struggle, gentrification,
      and the material basis of political power (who controls what land).
    blockers: "Phase 3.4 Imperial Circuit should be stable first"

  future_phase:
    name: "Phase 4: The Control Room"
    goal: "NiceGUI dashboard for simulation control and visualization"
    tech: "NiceGUI + State visualizations + User controls"
    key_components:
      - "State dashboard - entity status, tension gauges"
      - "Narrative display - LLM-generated prose"
      - "Control panel - start/stop/step simulation"
      - "History browser - timeline with undo/redo"
    blockers: "Phase 3.5 territorial foundation should be complete"

  sprint_status:
    sprint_1:
      name: "Value Types & Enums"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/models/types.py (6 types)"
        - "src/babylon/models/enums.py (4 enums)"
        - "tests/unit/models/test_types.py (45 tests)"
        - "tests/unit/models/test_enums.py (22 tests)"
      tests_passing: 131

    sprint_1_5:
      name: "Physics Module"
      status: "COMPLETE (PRE-EXISTING)"
      discovery: "2024-12-07 - Formulas already existed in src/babylon/systems/formulas.py"
      location: "src/babylon/systems/formulas.py (349 lines)"
      tests: "tests/unit/formulas/ (40 tests, ALL PASSING)"
      formulas_implemented:
        - "calculate_imperial_rent() - Imperial rent extraction"
        - "calculate_acquiescence_probability() - P(S|A) sigmoid"
        - "calculate_revolution_probability() - P(S|R)"
        - "calculate_crossover_threshold() - When revolt becomes rational"
        - "calculate_labor_aristocracy_ratio() - Wc/Vc ratio"
        - "is_labor_aristocracy() - Boolean check"
        - "calculate_consciousness_drift() - dΨ/dt ideology change"
        - "apply_loss_aversion() - Kahneman-Tversky λ=2.25"
        - "calculate_exchange_ratio() - Unequal exchange ε"
        - "calculate_value_transfer() - Core-periphery flows"
        - "prebisch_singer_effect() - Deteriorating terms of trade"
      lesson_learned: "Always explore actual codebase before planning new work"

    sprint_2:
      name: "Entity Models"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/models/entities/social_class.py (SocialClass)"
        - "src/babylon/models/entities/relationship.py (Relationship)"
        - "tests/unit/models/test_social_class.py (31 tests)"
        - "tests/unit/models/test_relationship.py (29 tests)"
        - "tests/integration/test_phase1_blueprint.py (11 tests)"
      tests_passing: 202
      phase_1_complete: true
      notes: "Phase 1 blueprint proven: two nodes, one edge, formulas work"

    sprint_3:
      name: "SimulationConfig"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/models/config.py (SimulationConfig)"
        - "tests/unit/models/test_config.py (42 tests)"
      tests_passing: 244
      notes: "Frozen config with all formula coefficients"

    sprint_4:
      name: "WorldState with NetworkX"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/models/world_state.py (WorldState)"
        - "tests/unit/models/test_world_state.py (35 tests)"
      tests_passing: 279
      notes: "Immutable state, to_graph()/from_graph() conversion"

    sprint_5:
      name: "SimulationEngine step()"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/simulation_engine.py"
        - "tests/unit/engine/test_simulation_engine.py (19 tests)"
      tests_passing: 298
      notes: "Pure function, deterministic, encodes historical materialism"

    sprint_6:
      name: "Factory Functions & Integration Tests"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/scenarios.py"
        - "tests/integration/test_phase2_game_loop.py (20 tests)"
      tests_passing: 318
      notes: "Feedback loops proven: rent spiral, repression trap"

    sprint_7:
      name: "Delete Economy/Politics per ADR011"
      status: "COMPLETE"
      deliverables:
        - "Deleted src/babylon/core/economy.py"
        - "Deleted src/babylon/core/politics.py"
        - "Updated __main__.py to use engine"
      tests_passing: 318
      notes: "Pure Graph Architecture - no institutional classes"

    sprint_7_5:
      name: "Consciousness Drift Integration"
      status: "COMPLETE"
      deliverables:
        - "_update_consciousness_drift() helper function"
        - "consciousness_decay_lambda config field"
        - "tests/unit/engine/test_simulation_engine.py::TestStepConsciousnessDrift (7 tests)"
      tests_passing: 325
      notes: "Worker ideology drifts revolutionary as extraction continues"

    sprint_7_6:
      name: "Configurable Tension Rate & Feedback Tests"
      status: "COMPLETE"
      deliverables:
        - "tension_accumulation_rate config field"
        - "TestStepTensionRate (3 tests)"
        - "TestConsciousnessFeedbackLoop (2 tests)"
      tests_passing: 330
      notes: "All feedback loops now proven with integration tests"

    sprint_8:
      name: "History Stack with File I/O and Auto-Checkpointing"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/history/models.py (5 Pydantic models)"
        - "src/babylon/engine/history/stack.py (7 pure functions)"
        - "src/babylon/engine/history/io.py (6 I/O functions + 4 exception types)"
        - "src/babylon/engine/history/auto_checkpoint.py (AutoCheckpointer class)"
        - "tests/unit/engine/history/ (123 tests)"
      tests_passing: 453
      notes: "Undo/redo, save/load, auto-checkpointing. Branching deferred."

    sprint_9:
      name: "Component System (Material Ontology)"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/models/components/base.py (Component protocol)"
        - "src/babylon/models/components/material.py (MaterialComponent)"
        - "src/babylon/models/components/vitality.py (VitalityComponent)"
        - "src/babylon/models/components/spatial.py (SpatialComponent)"
        - "src/babylon/models/components/ideological.py (IdeologicalComponent)"
        - "src/babylon/models/components/organization.py (OrganizationComponent)"
        - "tests/unit/models/components/ (129 tests)"
      tests_passing: 582
      notes: "Frozen Pydantic models with constrained types"

    sprint_10:
      name: "ServiceContainer & Dependency Injection"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/services.py (ServiceContainer)"
        - "src/babylon/engine/event_bus.py (EventBus)"
        - "src/babylon/engine/formula_registry.py (FormulaRegistry)"
        - "src/babylon/engine/database.py (DatabaseConnection)"
        - "tests/unit/engine/test_services.py"
        - "tests/unit/engine/test_event_bus.py (20 tests)"
        - "tests/unit/engine/test_formula_registry.py (14 tests)"
      tests_passing: 630
      notes: "Clean dependency injection for testability"

    sprint_11:
      name: "System Protocol & Implementations"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/systems/protocol.py (System protocol)"
        - "src/babylon/engine/systems/economic.py (ImperialRentSystem)"
        - "src/babylon/engine/systems/ideology.py (ConsciousnessSystem)"
        - "src/babylon/engine/systems/survival.py (SurvivalSystem)"
        - "src/babylon/engine/systems/contradiction.py (ContradictionSystem)"
      tests_passing: 647
      notes: "Modular systems with shared ServiceContainer"

    sprint_12:
      name: "Simulation Facade & Entity Factories"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/simulation.py (Simulation class)"
        - "src/babylon/engine/factories.py (create_proletariat, create_bourgeoisie)"
        - "src/babylon/engine/history_formatter.py (format_class_struggle_history)"
        - "tests/unit/engine/test_simulation_facade.py (19 tests)"
        - "tests/unit/engine/test_factories.py (30 tests)"
        - "tests/integration/test_class_struggle.py (8 tests)"
      tests_passing: 704
      notes: "Integration proof: 100-tick wealth transfer verified"

    sprint_3_1:
      name: "The Dialectical Interface (Observer Pattern)"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/observer.py (SimulationObserver protocol)"
        - "src/babylon/ai/director.py (NarrativeDirector)"
        - "Modified src/babylon/engine/simulation.py (observer support)"
        - "tests/unit/engine/test_observer_pattern.py (32 tests)"
        - "tests/unit/ai/test_narrative_director.py"
      tests_passing: 736
      notes: "Observer Pattern for AI narrative integration"

    sprint_3_2:
      name: "The Materialist Retrieval (RAG Integration)"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/ai/prompt_builder.py (DialecticalPromptBuilder)"
        - "Modified src/babylon/ai/director.py (RAG injection)"
        - "tests/unit/ai/test_prompt_builder.py"
        - "tests/unit/ai/test_director_rag.py (27 tests)"
      tests_passing: 763
      notes: "RAG pipeline integrated, context hierarchy implemented"
      tech_debt_resolved:
        - "90 mypy errors in RAG module (Mikado refactor)"
        - "ChromaDB API migration to PersistentClient"

    sprint_3_3:
      name: "LLM Integration (Vertical Slice)"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/ai/llm_provider.py (protocol + DeepSeek implementation)"
        - "Modified ImperialRentSystem (event generation)"
        - "RAG corpus ingestion script (5 texts from Marxists.org)"
        - "Integration tests proving full narrative pipeline"
        - "4-phase model: cadre_density in TopologySnapshot/PhaseTransitionEvent"
        - "_classify_phase() returns gaseous/transitional/liquid/solid"
      llm_choice: "DeepSeek API (OpenAI-compatible, cost-effective)"
      testing_approach: "Integration tests instead of CLI runner"
      rag_corpus: "5 curated texts from Marxists.org (~200-500 chunks)"
      tests_passing: 800
      scope: "Factory worker vs capitalist, one phenomenon (wealth transfer)"
      phase_model: "4-phase: gaseous/transitional/liquid/solid (cadre_density distinguishes mass movement from vanguard)"

    sprint_4_1:
      name: "The Narrative Bridge (Typed Event Pipeline)"
      status: "COMPLETE"
      deliverables:
        - "PromptBuilder.build_context_block accepts list[SimulationEvent]"
        - "_format_event() method with match/case for all event types"
        - "NarrativeDirector.on_tick uses state.events instead of event_log"
        - "SEMANTIC_MAP with EventType enum keys"
        - "SIGNIFICANT_EVENT_TYPES frozenset for filtering"
        - "_retrieve_context_from_typed_events() for semantic bridge"
        - "tests/integration/test_narrative_pipeline.py (9 tests)"
      tests_passing: 1795
      commits: "d756498"
      key_insight: "AI pipeline now consumes typed events, enabling rich formatting per event type"
      significant_events:
        - "ECONOMIC_CRISIS"
        - "PHASE_TRANSITION"
        - "UPRISING"
        - "EXCESSIVE_FORCE"
        - "RUPTURE"

    sprint_3_4_1:
      name: "Economic Infrastructure (Imperial Circuit)"
      status: "COMPLETE"
      deliverables:
        - "EdgeType.TRIBUTE (P_c → C_b tribute transfer)"
        - "EdgeType.WAGES (C_b → C_w super-wages)"
        - "EdgeType.CLIENT_STATE (C_b → P_c imperial subsidy)"
        - "EventType.IMPERIAL_SUBSIDY (narrative event)"
        - "4-phase ImperialRentSystem (extraction, tribute, wages, subsidy)"
        - "Relationship.subsidy_cap field for CLIENT_STATE edges"
        - "SimulationConfig: comprador_cut, super_wage_rate, subsidy_* params"
      tests_passing: 829
      commit: "5c5dbc9"
      key_insight: "Wealth converts to repression (not conserved) for imperial subsidy"

    sprint_3_4_2:
      name: "Proletarian Internationalism"
      status: "COMPLETE"
      deliverables:
        - "SolidaritySystem - consciousness transmission via SOLIDARITY edges"
        - "Relationship.solidarity_strength field (STORED ON EDGE)"
        - "EventType.SOLIDARITY_AWAKENING (source enters active struggle)"
        - "EventType.CONSCIOUSNESS_TRANSMISSION (delta transfer)"
        - "EventType.MASS_AWAKENING (target crosses threshold)"
        - "calculate_solidarity_transmission() formula"
        - "SimulationConfig: solidarity_activation_threshold, mass_awakening_threshold"
      tests_passing: 886
      commit: "61fe9c1"
      key_insight: |
        solidarity_strength is STORED ON EDGE, not auto-calculated from organization.
        This enables Fascist Bifurcation: same material conditions → different outcomes
        based on whether solidarity infrastructure was BUILT beforehand.
        "Agitation without solidarity produces fascism, not revolution."

  phase_roadmap:
    # ==========================================================================
    # HISTORICAL REFERENCE ONLY - SUPERSEDED BY EPOCH + SLICE MODEL
    # ==========================================================================
    # This Phase numbering system is deprecated as of 2025-12-26.
    # See ai-docs/epochs-overview.md for the current organizational model.
    # Kept for historical reference - old commits reference these phases.
    #
    # Mapping:
    #   Phase 0-2  → Epoch 0 (The Kernel)
    #   Phase 3-4  → Epoch 1 (The Demonstration)
    #   Phase 5+   → Epoch 2-3 (The Game, The Platform)
    # ==========================================================================
    superseded_by: "ai-docs/epochs-overview.md (Epoch + Slice model)"
    superseded_date: "2025-12-26"
    superseded_note: "Four-Phase Blueprint → Six-Phase Fractal Evolution (2025-12-09) → Epoch + Slice (2025-12-26)"
    phase_1:
      name: "Minimum Viable Dialectic"
      summary: "Prove the equations work"
      status: "COMPLETE"
    phase_2:
      name: "Topological Engine"
      summary: "The physics/update loop"
      status: "COMPLETE"
    phase_2_5:
      name: "Test Refactor (Operation Clean Slate)"
      summary: "Testing infrastructure - DomainFactory, BabylonAssert, MetricsSpy"
      status: "COMPLETE"
      added: "2025-12-12 (Truth Sync)"
    phase_2_6:
      name: "Observer Protocol"
      summary: "Decoupled observation - SimulationObserver, TopologyMonitor"
      status: "COMPLETE"
      added: "2025-12-12 (Truth Sync)"
      note: "models/events.py (Pydantic event schema) COMPLETE - Sprint 3.1 Event Schema"
    phase_3:
      name: "Observer Pattern"
      summary: "AI narrates, never controls"
      status: "COMPLETE (Sprint 3.3 - Vertical Slice)"
    phase_3_4:
      name: "Imperial Circuit"
      summary: "4-node model with WAGES edges"
      status: "IN PROGRESS"
      sprints:
        3_4_1:
          name: "Economic Infrastructure"
          status: "COMPLETE"
          deliverables:
            - "TRIBUTE edge type (P_c → C_b)"
            - "WAGES edge type (C_b → C_w)"
            - "CLIENT_STATE edge type (C_b → P_c subsidy)"
            - "IMPERIAL_SUBSIDY event type"
            - "4-phase ImperialRentSystem"
          tests: "829 tests passing"
          commit: "5c5dbc9"
        3_4_2:
          name: "Proletarian Internationalism"
          status: "COMPLETE"
          deliverables:
            - "SolidaritySystem (consciousness transmission)"
            - "solidarity_strength edge attribute (stored infrastructure)"
            - "SOLIDARITY_AWAKENING event type"
            - "CONSCIOUSNESS_TRANSMISSION event type"
            - "MASS_AWAKENING event type"
            - "Fascist Bifurcation mechanic enabled"
          tests: "886 tests passing"
          commit: "61fe9c1"
          key_insight: "solidarity_strength is STORED ON EDGE, not auto-calculated - enables Fascist Bifurcation"
        3_4_3:
          name: "Multi-Dimensional Consciousness (The George Jackson Refactor)"
          status: "COMPLETE"
          deliverables:
            - "IdeologicalProfile model (class_consciousness, national_identity, agitation)"
            - "calculate_ideological_routing() formula"
            - "Fascist Bifurcation mechanic: agitation + solidarity → revolution, agitation alone → fascism"
            - "Removed legacy scalar ideology - clean migration to multi-dimensional model"
          tests: "987 tests passing"
          commits: ["73d991d", "51c4de6"]
          key_insight: "Fascism is the defensive form of capitalism."
        3_4_4:
          name: "Dynamic Balance"
          status: "PLANNED"
          deliverables:
            - "Imperial rent pool as emergent property"
            - "Bourgeoisie choice system"
            - "Crisis events as phase transitions"
    phase_3_5:
      name: "Territorial Foundation (Layer 0)"
      summary: "Spatial Graph grounding Social Graph"
      status: "PLANNED"
      key_components:
        - "Strategic Sectors (territorial units)"
        - "Subversive Tenancy (Host/Parasite logic)"
        - "Suspicion metric (Eviction risk)"
        - "Enclosure mechanics"
    phase_4:
      name: "Control Room"
      summary: "NiceGUI dashboard"
      status: "PLANNED"
    phase_5:
      name: "Internal Colonies"
      summary: "Fractal topology - race/gender/geographic stratification"
      status: "FUTURE"
      key_insight: "Composite/Graph pattern enables modeling stratification within Core"
    phase_6:
      name: "Full Simulation"
      summary: "Multi-country, multi-faction, full complexity"
      status: "FUTURE"

  next_steps:
    # Using Epoch + Slice model - see ai-docs/epochs-overview.md
    current_work: "Slice 1.5: The Dashboard (wire 4-node scenario, metabolic gauge)"
    epoch_1_remaining:
      - "Slice 1.5: The Dashboard - wire 4-node scenario, metabolic gauge"
      - "Slice 1.6: The Endgame - win/lose display based on solidarity"
    epoch_1_completed:
      - "Slice 1.1: The Circuit - ImperialRentSystem, 4-node scenario"
      - "Slice 1.2: The Struggle - StruggleSystem, TerritorySystem"
      - "Slice 1.3: The Observer - SimulationObserver, TopologyMonitor, MetricsCollector"
      - "Slice 1.4: The Rift - MetabolismSystem, ecological metrics (Sprint 1.4A/B/C)"
    epoch_2_planned:
      - "Slice 2.1: Demographic Resolution (ai-docs/demographics-spec.yaml)"
      - "Slice 2.2: Player Controls"
      - "Slice 2.3: Reproductive Labor"
    optional:
      - "Expand RAG corpus with more Marxists.org texts"
      - "Timeline branching for history stack"

    # Historical sprint references (pre-Epoch model)
    completed_sprints_historical:
      note: "Sprint numbering superseded by Slice numbering - kept for git history reference"
      completed:
        - "Sprint 3.3: Vertical Slice → part of Slice 1.3 (Observer)"
        - "Sprint 3.4.1-3.4.3: Imperial Circuit → Slice 1.1 (Circuit)"
        - "Sprint 3.5: Territorial Substrate → Slice 1.2 (Struggle)"
        - "Phase 4.0: Dashboard MVP → Slice 1.5 (Dashboard)"

  # ---------------------------------------------------------------------------
  # VERTICAL INTEGRATION INITIATIVE: "The Living Circuit"
  # ---------------------------------------------------------------------------
  #
  # Diagnosis (2025-12-25):
  #   The dashboard EXISTS but doesn't REVEAL anything interesting.
  #   Imperial rent hovers at 100, tension moves infinitesimally.
  #   Root cause: Dashboard shows 2-node scenario, not the 4-node Imperial Circuit.
  #
  # Mantra: "A flat line on a fancy graph is still a flat line."
  #
  vertical_integration:
    initiative_name: "The Living Circuit"
    status: "IN PROGRESS"
    diagnosis:
      problem: "Dashboard is boring - flat metrics, single node visible"
      root_causes:
        - "Using create_two_node_scenario() instead of create_imperial_circuit_scenario()"
        - "TrendPlotter only shows P_w (Periphery Worker), not all 4 classes"
        - "Metrics show static wealth, not dynamic FLOWS between nodes"
        - "Default GameDefines coefficients produce equilibrium, not crisis"
      insight: "The dashboard is a LENS. It can't show interesting things if the simulation is static."

    sprint_4_1_a:
      name: "Wire the Circuit"
      status: "PLANNED"
      goal: "Switch dashboard to 4-node Imperial Circuit scenario"
      deliverables:
        - "main.py: import create_imperial_circuit_scenario"
        - "main.py: replace create_two_node_scenario() call"
        - "Verify 4 nodes appear in StateInspector: P_w, P_c, C_b, C_w"
        - "Verify 5 edges: EXPLOITATION, TRIBUTE, WAGES, CLIENT_STATE, SOLIDARITY"
      files:
        - "src/babylon/ui/main.py (scenario import change)"
      success_criteria: "StateInspector shows all 4 classes with their relationships"

    sprint_4_1_b:
      name: "Expose Meaningful Metrics"
      status: "PLANNED"
      goal: "TrendPlotter shows dynamics worth watching"
      deliverables:
        - "TrendPlotter: 4 wealth lines (color-coded by SocialRole)"
        - "TrendPlotter: Consciousness differential (P_w - C_w)"
        - "TrendPlotter: Solidarity edge strength over time"
        - "TrendPlotter: Imperial rent pool level"
        - "SystemLog: Filter for SIGNIFICANT_EVENT_TYPES only"
      metrics_to_track:
        wealth_by_class:
          - "P_w (Periphery Worker) - red line"
          - "P_c (Comprador) - orange line"
          - "C_b (Core Bourgeoisie) - blue line"
          - "C_w (Labor Aristocracy) - green line"
        differentials:
          - "consciousness_gap: P_w.consciousness - C_w.consciousness"
          - "wealth_gap: C_b.wealth - P_w.wealth"
        flows:
          - "imperial_rent: total extraction per tick"
          - "super_wages: WAGES edge value_flow"
          - "solidarity_strength: SOLIDARITY edge attribute"
      key_insight: |
        The INTERESTING dynamics are in RELATIONSHIPS, not node attributes.
        - EXPLOITATION rate (how fast value flows out of periphery)
        - Consciousness DIFFERENTIAL (gap between P_w and C_w awareness)
        - SOLIDARITY strength (infrastructure for revolution vs fascism)

    sprint_4_1_c:
      name: "Tune for Crisis"
      status: "PLANNED"
      goal: "Simulation produces crisis within 30-50 ticks"
      deliverables:
        - "GameDefines adjustment: faster consciousness drift"
        - "GameDefines adjustment: higher tension accumulation"
        - "Test Fascist Bifurcation path (solidarity_strength = 0)"
        - "Test Revolutionary path (solidarity_strength > 0)"
        - "Verify George Floyd Dynamic spark mechanics"
      balance_targets:
        - "Crisis event within 30-50 ticks of default scenario"
        - "Visible consciousness divergence by tick 20"
        - "Measurable wealth transfer by tick 10"
        - "Fascist vs Revolutionary bifurcation clearly distinguishable"
      formula_tuning:
        - "consciousness_drift_k: increase for faster awakening"
        - "tension_accumulation_rate: increase for faster crisis"
        - "extraction_efficiency: balance for sustainable extraction"

    philosophical_grounding: |
      Horizontal expansion (more features) doesn't help if vertical integration
      (making existing features work together) isn't complete.

      The 4-node Imperial Circuit model exists. The dashboard exists.
      But they're not connected. We're watching a 2-node toy model
      on a 4-panel dashboard built for a 4-node system.

      "A working 4-node simulation beats a broken 10-node simulation."

  mantra: "Graph + Math = History"
  epoch_mantra: "Build the demonstration first. Then build the game. Finally, build the platform."
  old_mantras:
    - "The bomb factory pays well. That's the problem."
    - "State is data. Engine is logic. They never mix."
    - "Agitation without solidarity produces fascism, not revolution."
    - "Fascism is the defensive form of capitalism."
    - "A flat line on a fancy graph is still a flat line."
  milestone: "Political Economy of Liquidity Epoch 1 COMPLETE: Finance models + WorldState integration"
  next_milestone: "Slice 1.5: The Dashboard - wire 4-node scenario, metabolic gauge"
  test_count: 2651
  test_count_note: "Updated 2025-12-31 - Magic number refactoring complete"

  magic_number_refactoring:
    status: "COMPLETE"
    date: "2025-12-31"
    scope: "21 test files in tests/unit/models/"
    pattern: "Centralized frozen dataclass constants"
    location: "tests/constants.py"
    adr: "ADR031_test_constants_architecture"
    categories_added:
      - "WealthDefaults (10.0, 50.0, 100.0, 500.0, etc.)"
      - "ProbabilityDefaults (0.0-1.0 semantic values)"
      - "IdeologyDefaults (-1.0 to +1.0 political spectrum)"
      - "ConsciousnessDefaults (George Jackson model)"
      - "TerritoryDefaults (heat, rent, population)"
      - "EconomicFlowDefaults (extraction, rent pool)"
      - "RevolutionaryFinanceDefaults (war_chest, income streams)"
      - "VitalityDefaults (population, subsistence)"
      - "OrganizationDefaults (cohesion, cadre)"
      - "SpatialDefaults (mobility)"
      - "AgitationDefaults (George Jackson agitation)"
    phases_completed:
      phase_1: "test_types.py, test_social_class.py, test_config.py, test_territory.py, test_world_state.py"
      phase_2: "test_relationship.py, test_state_finance.py, test_economy.py, test_events.py, test_precarity_state.py"
      phase_3: "Component tests (material, ideological, organization, spatial, vitality)"
      phase_4: "test_revolutionary_finance.py, test_graph_models.py, test_metrics_models.py"
    key_insight: |
      Boundary values testing type contracts (0.0, 1.0, -1.0) stay inline.
      Domain-semantic values (DEFAULT_WEALTH, MIDPOINT, REVOLUTIONARY) use constants.
      This preserves test readability while eliminating magic numbers.

  metrics_audit:
    date: "2025-12-25"
    status: "PHASE 4.1B COMPLETE - ~85% coverage"
    source_document: "brainstorm/metrics-collector-audit-reasoning.md"
    critical_fixed_in_4_1b:
      - "current_super_wage_rate ✅ FIXED - now in TickMetrics"
      - "current_repression_level ✅ FIXED - now in TickMetrics"
      - "pool_ratio ✅ ADDED - imperial rent pool health"
      - "consciousness_gap ✅ ADDED - P_w - C_w differential"
      - "wealth_gap ✅ ADDED - C_b - P_w differential"
    topology_model_ready:
      - "TopologySummary model ✅ CREATED - percolation_ratio, cadre_density, phase"
      - "Integration with dashboard ❌ PENDING - TopologyMonitor not registered"
    bugs_fixed_in_4_1b:
      - "global_tension ✅ FIXED - now only averages EXPLOITATION edges"
      - "edge metrics ✅ FIXED - aggregates (max tension, sum flows)"
    remaining_gaps:
      - "TopologyMonitor dashboard integration (Phase 4.2)"
      - "Territory aggregate metrics (heat, population)"
      - "Event count per tick"
      - "repression_faced per entity"
    full_audit: "See observer-layer.yaml metrics_collector.audit section"

  analysis_insight: |
    2025-12-25: Diagnosed why dashboard is boring.
    Using create_two_node_scenario() instead of create_imperial_circuit_scenario().
    Dashboard shows 1 of 4 classes, misses the whole Imperial Circuit dynamic.
    The dashboard is a LENS - it can't show interesting things if simulation is static.

    2025-12-25: MetricsCollector audit reveals ~60% coverage.
    Critical missing: economy drivers (wage_rate, repression) and topology (percolation).
    These are the DIALS that make the simulation interesting to watch.
    Without them, dashboard shows effects but not causes.

    2025-12-25: PHASE 4.1B COMPLETE via TDD (43 new tests).
    Fixed: current_super_wage_rate, current_repression_level, pool_ratio exposed.
    Fixed: consciousness_gap, wealth_gap derived differentials.
    Fixed: global_tension bug (was averaging all edges, now EXPLOITATION only).
    Fixed: edge aggregation bug (was overwriting, now max/sum).
    Created: TopologySummary model ready for dashboard integration.
    Documented: Causal DAG (Fundamentals → Systems → Metrics) in architecture.yaml.
  philosophical_grounding: |
    "The Economy is not a class; it is the sum of all EXTRACTS_FROM edges."
    Architecture encodes theory. The code IS the analysis.

# =============================================================================
# IDEA QUARANTINE PROTOCOL
# =============================================================================

quarantine:
  location: "~/projects/game/notes/"
  purpose: "Dump ideas without derailing implementation"
  rule: "If it's not in next_steps, it goes in notes/ or brainstorm/deferred-ideas.md"
  deferred_parking: "brainstorm/deferred-ideas.md"

# =============================================================================
# TECH DEBT
# =============================================================================

tech_debt:

  legacy_xml:
    location: "src/babylon/data/xml/"
    status: "Migrated, kept for reference"
    action: "Can delete after confidence in JSON"
    priority: "low"

  legacy_economy_politics:
    status: "RESOLVED"
    action: "Deleted in Sprint 7 per ADR011"
    notes: "Pure Graph Architecture - no institutional classes"

  incomplete_models:
    issue: "Not all entities have Pydantic models"
    action: "Generate from JSON schemas as needed"
    priority: "low - current models sufficient for Phase 2-3"

  test_coverage:
    status: "EXCELLENT"
    current: "1926 tests passing (2025-12-14)"
    coverage: "Core engine + systems + persistence + components + events + AI narrative fully tested, TDD discipline maintained"
    action: "Continue TDD for new features"
    testing_infrastructure:
      - "DomainFactory (tests/factories/domain.py) - 31 tests"
      - "BabylonAssert (tests/assertions.py) - 55 tests"
      - "MockMetricsCollector (tests/mocks/metrics_collector.py) - 8 tests"
      - "Event model tests (tests/unit/models/test_events.py) - 44 tests"
      - "Event conversion tests (tests/unit/engine/test_event_conversion.py) - 13 tests"
      - "Phase transition tests (tests/unit/topology/test_phase_transition.py) - 30 tests (Sprint 3.3 4-phase model)"
      - "Narrative pipeline tests (tests/integration/test_narrative_pipeline.py) - 9 tests (Sprint 4.1)"
      - "MetricsCollector tests (tests/unit/engine/observers/test_metrics_collector.py) - 60 tests (Sprint 4.1 TDD)"
      - "Metrics model tests (tests/unit/models/test_metrics_models.py) - 41 tests (Sprint 4.1 TDD)"

  documentation_drift:
    issue: "README.md still references PostgreSQL, old structure"
    action: "Update when Phase 3 complete"
    priority: "low - ai-docs/ is source of truth"

  legacy_contradiction_analysis:
    location: "src/babylon/systems/contradiction_analysis.py"
    status: "Partially superseded"
    notes: "Tension now tracked on Relationship edges, but legacy class still used in __main__.py"
    action: "Evaluate during Phase 3"
