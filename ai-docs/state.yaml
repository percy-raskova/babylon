# Babylon Project State
# What exists vs what's planned - KEEP THIS UPDATED

meta:
  version: "1.4.0"
  updated: "2025-12-12"
  principle: "Be honest about what's implemented vs aspirational"
  architecture_epoch: "Six-Phase Fractal Evolution"
  last_audit: "Operation Truth Sync (2025-12-12)"

# =============================================================================
# IMPLEMENTATION STATUS
# =============================================================================

implemented:

  data_layer:
    status: "functional"
    components:
      json_data_files:
        status: "complete"
        details: "17 entity collections migrated from XML"
        location: "src/babylon/data/game/*.json"

      json_schemas:
        status: "complete"
        details: "Draft 2020-12 schemas for all entities"
        location: "src/babylon/schemas/"
        validation: "poetry run python tools/validate_schemas.py"

      pydantic_models:
        status: "partial"
        details: "Some models exist, not all entities covered"
        location: "src/babylon/data/models/"

      database:
        status: "configured"
        details: "SQLite setup, no tables populated yet"
        location: "src/babylon/data/database.py"

  core_logic:
    status: "complete"
    components:
      simulation_engine:
        status: "complete"
        details: "Modular engine with 4 Systems, ServiceContainer DI"
        location: "src/babylon/engine/simulation_engine.py"
        tests: "tests/unit/engine/test_simulation_engine.py (30+ tests)"
        architecture:
          - "SimulationEngine.run_tick(graph, services, context)"
          - "4 Systems: ImperialRent, Consciousness, Survival, Contradiction"
          - "ServiceContainer: config, database, event_bus, formulas"

      service_container:
        status: "complete"
        details: "Dependency injection container for all services"
        location: "src/babylon/engine/services.py"
        tests: "tests/unit/engine/test_services.py"
        provides:
          - "config: SimulationConfig"
          - "database: DatabaseConnection"
          - "event_bus: EventBus"
          - "formulas: FormulaRegistry"

      event_bus:
        status: "complete"
        details: "Publish/subscribe event system"
        location: "src/babylon/engine/event_bus.py"
        tests: "tests/unit/engine/test_event_bus.py (20 tests)"
        events_published:
          - "rupture - when tension reaches 1.0"

      formula_registry:
        status: "complete"
        details: "Hot-swappable formula lookup with 12 registered formulas"
        location: "src/babylon/engine/formula_registry.py"
        tests: "tests/unit/engine/test_formula_registry.py (14 tests)"

      systems:
        status: "complete"
        details: "4 modular System implementations"
        location: "src/babylon/engine/systems/"
        components:
          protocol: "System protocol with step(graph, services, context)"
          imperial_rent: "ImperialRentSystem - economic extraction"
          consciousness: "ConsciousnessSystem - ideology drift"
          survival: "SurvivalSystem - P(S|A) and P(S|R)"
          contradiction: "ContradictionSystem - tension accumulation"

      simulation_facade:
        status: "complete"
        details: "Stateful wrapper for multi-tick simulations"
        location: "src/babylon/engine/simulation.py"
        tests: "tests/unit/engine/test_simulation_facade.py (19 tests)"
        provides:
          - "Simulation.step() - advance one tick"
          - "Simulation.run(n) - run n ticks"
          - "Simulation.get_history() - all state snapshots"

      entity_factories:
        status: "complete"
        details: "Factory functions for entity creation"
        location: "src/babylon/engine/factories.py"
        tests: "tests/unit/engine/test_factories.py (30 tests)"
        provides:
          - "create_proletariat() - exploited class"
          - "create_bourgeoisie() - exploiter class"

      world_state:
        status: "complete"
        details: "Immutable state with NetworkX graph conversion"
        location: "src/babylon/models/world_state.py"
        tests: "tests/unit/models/test_world_state.py (35 tests)"

      simulation_config:
        status: "complete"
        details: "Frozen config with all formula coefficients"
        location: "src/babylon/models/config.py"
        tests: "tests/unit/models/test_config.py (42 tests)"

      formulas:
        status: "complete"
        details: "All MLM-TW formulas implemented and tested"
        location: "src/babylon/systems/formulas.py (348 lines)"
        tests: "tests/unit/formulas/ (40 tests)"
        includes:
          - "calculate_imperial_rent() - consciousness-dependent extraction"
          - "calculate_acquiescence_probability() - P(S|A) sigmoid"
          - "calculate_revolution_probability() - P(S|R)"
          - "calculate_consciousness_drift() - dΨ/dt ideology change"

      scenarios:
        status: "complete"
        details: "Factory functions for test scenarios"
        location: "src/babylon/engine/scenarios.py"
        includes:
          - "create_two_node_scenario()"
          - "create_high_tension_scenario()"
          - "create_labor_aristocracy_scenario()"

      history_persistence:
        status: "complete"
        details: "History stack, file I/O, auto-checkpointing"
        location: "src/babylon/engine/history/"
        tests: "tests/unit/engine/history/ (123 tests)"
        includes:
          - "HistoryStack - undo/redo with max_depth pruning"
          - "save_state/load_state - WorldState file I/O"
          - "save_checkpoint/load_checkpoint - full state + config + metadata"
          - "AutoCheckpointer - interval-based automatic saves"
          - "Atomic writes - temp file + rename pattern"

      contradiction_analysis:
        status: "partial"
        details: "ContradictionAnalysis class exists, basic methods work"
        location: "src/babylon/systems/contradiction_analysis.py"
        note: "Legacy - tension now tracked on Relationship edges"

  ai_layer:
    status: "partial"
    components:
      observer_protocol:
        status: "complete"
        details: "SimulationObserver protocol with lifecycle hooks"
        location: "src/babylon/engine/observer.py"
        tests: "tests/unit/engine/test_observer_pattern.py (32 tests)"
        provides:
          - "SimulationObserver protocol (@runtime_checkable)"
          - "on_simulation_start(initial_state, config)"
          - "on_tick(previous_state, new_state)"
          - "on_simulation_end(final_state)"

      narrative_director:
        status: "complete"
        details: "AI Game Master that observes simulation and generates narrative"
        location: "src/babylon/ai/director.py"
        tests: "tests/unit/ai/test_narrative_director.py, test_director_rag.py (27 tests)"
        provides:
          - "NarrativeDirector class implementing SimulationObserver"
          - "RAG pipeline injection (optional)"
          - "Prompt builder injection (optional)"
          - "Error handling per ADR003"
        missing: "LLM client integration (Sprint 3.3)"

      prompt_builder:
        status: "complete"
        details: "Builds prompts following Marxist dialectical materialism"
        location: "src/babylon/ai/prompt_builder.py"
        tests: "tests/unit/ai/test_prompt_builder.py"
        provides:
          - "DialecticalPromptBuilder class"
          - "build_system_prompt() - AI identity"
          - "build_context_block(state, rag_context, events)"
          - "_calculate_tension() - aggregate tension level"

      rag_pipeline:
        status: "infrastructure_complete"
        details: "RAG query pipeline implemented, but NO DATA populated"
        location: "src/babylon/rag/rag_pipeline.py"
        tests: "RAG module tests"
        provides:
          - "RagPipeline.query(text, top_k) → QueryResponse"
          - "Sync wrapper for async operations"
        missing: "Corpus data - ChromaDB is empty, no documents to retrieve"

      chromadb:
        status: "configured"
        details: "ChromaDB 1.x API with PersistentClient"
        location: "src/babylon/data/chroma_manager.py"
        api_version: "1.3.5 (modern PersistentClient API)"
        collections_defined:
          - "THEORY_COLLECTION: marxist_theory (EMPTY)"
          - "HISTORY_COLLECTION: game_history (EMPTY)"
          - "ENTITIES_COLLECTION: entity_embeddings (EMPTY)"
        missing: "Document ingestion pipeline, corpus data"

      llm_client:
        status: "not_implemented"
        details: "No LLM provider integration yet"
        priority: "CRITICAL - Sprint 3.3"
        primary_choice: "DeepSeek API (OpenAI-compatible, cost-effective)"
        fallback_options:
          - "Ollama HTTP API (local models)"
          - "Anthropic SDK (Claude)"

  tooling:
    status: "functional"
    components:
      xml_migration:
        status: "complete"
        location: "tools/migrate_xml_to_json.py"

      schema_validation:
        status: "complete"
        location: "tools/validate_schemas.py"

      testing:
        status: "configured"
        details: "Pytest with markers, some tests exist"

      linting:
        status: "configured"
        details: "Ruff + MyPy strict"

# =============================================================================
# NOT YET IMPLEMENTED
# =============================================================================

not_implemented:

  llm_provider:
    priority: "critical"
    description: "LLM client abstraction for Claude/Ollama"
    blockers: "None - ready to implement"
    phase: 3
    sprint: "3.3"
    estimated_lines: 200

  event_generation:
    priority: "high"
    description: "Systems emit events for wealth transfer, ideology drift"
    blockers: "None - architecture supports it"
    phase: 3
    sprint: "3.3"
    details: |
      Currently only ContradictionSystem emits events (rupture).
      ImperialRentSystem needs to emit exploitation events for narrative.
    estimated_lines: 30

  rag_corpus:
    priority: "medium"
    description: "Marxist theory documents for RAG retrieval"
    blockers: "None"
    phase: 3
    sprint: "3.3"
    source: "Marxists.org archive (user has full corpus available)"
    mvp_selection:
      description: "Curated minimal corpus for vertical slice"
      recommended_texts:
        - title: "Wage Labour and Capital"
          author: "Karl Marx (1847)"
          relevance: "Core explanation of surplus value extraction - directly maps to Imperial Rent"
          url: "https://www.marxists.org/archive/marx/works/1847/wage-labour/"
        - title: "Value, Price and Profit"
          author: "Karl Marx (1865)"
          relevance: "Accessible explanation of exploitation mechanics"
          url: "https://www.marxists.org/archive/marx/works/1865/value-price-profit/"
        - title: "Erta Klas - Principles of Communism"
          author: "Frederick Engels (1847)"
          relevance: "Q&A format, good for chunking, covers class relations"
          url: "https://www.marxists.org/archive/marx/works/1847/11/prin-com.htm"
        - title: "Imperialism, the Highest Stage of Capitalism (Chapters 1-4)"
          author: "V.I. Lenin (1917)"
          relevance: "Core theory for Imperial Rent and core-periphery dynamics"
          url: "https://www.marxists.org/archive/lenin/works/1916/imp-hsc/"
        - title: "The Wretched of the Earth (Chapter 1)"
          author: "Frantz Fanon (1961)"
          relevance: "Third Worldist perspective on colonial extraction"
          url: "https://www.marxists.org/subject/africa/fanon/"
      estimated_chunks: "~200-500 chunks from 5 texts"
      ingestion_approach: "Simple script to fetch, chunk, embed, store in ChromaDB"

  vertical_slice_testing:
    priority: "high"
    description: "Integration tests proving full narrative pipeline"
    blockers: "LLM provider"
    phase: 3
    sprint: "3.3"
    approach: "Pytest integration tests instead of CLI runner"
    rationale:
      - "Programmatic verification of data flow"
      - "Reproducible in CI/CD"
      - "Assertions on narrative generation"
      - "No manual interaction required"
    test_scenarios:
      - "test_narrative_generated_on_exploitation_event"
      - "test_rag_context_included_in_prompt"
      - "test_deepseek_api_called_with_correct_format"
      - "test_full_vertical_slice_10_ticks"

  ui:
    priority: "low"
    description: "Player interface (NiceGUI planned)"
    blockers: "Phase 3 vertical slice complete"
    phase: 4

  branching_history:
    priority: "low"
    description: "Timeline branching for history stack (branch_id, create_branch)"
    blockers: "None - deferred for simplicity"
    notes: "Current linear history sufficient; add branching if needed for UI"

  sanity_spies:
    priority: "low"
    description: "Runtime invariant validators (Babylon Protocol)"
    blockers: "Event bus for integration"
    design_doc: "brainstorm/babylon-protocol-verification.md"

# =============================================================================
# PLANNED FEATURES (BRAINSTORM)
# =============================================================================

planned:

  gramscian_wiki:
    status: "brainstorm"
    location: "brainstorm/gramscian-wiki-engine.md"
    description: "Hegemony as factional control over in-game wiki"
    dependencies: ["jinja2", "markdown renderer"]

  llm_tech_tree:
    status: "implemented"
    location: "src/babylon/data/technologies.json (T006-T011)"
    description: "AI as dual-use technology in game mechanics"

# =============================================================================
# FUTURE CONCEPTS (QUARANTINED IDEAS)
# =============================================================================

future_concepts:

  layer_0_pivot:
    phase: 3.5
    status: "brainstorm"
    description: |
      Layer 0 Pivot: Future refactor to ground all Social Graph (Topology) nodes
      onto a Spatial Graph (Territory). Moves from abstract 'Factions' to
      'Territory-bound Factions' with Host/Parasite tenure systems.

      Key insight: Political power has material basis in territorial control.
      The question "who controls this neighborhood?" precedes "who has ideology?"
    key_components:
      - "Strategic Sectors: territorial units (Slums, Financial District, Factory Zone)"
      - "Subversive Tenancy: De Facto control while enemy holds Legal control"
      - "Suspicion metric: probability of Eviction Event triggering"
      - "Enclosure: converting communal tenure to private (primitive accumulation)"
    dependencies: ["Phase 3.4 Imperial Circuit stable"]

  vanguard_economy:
    phase: 4
    status: "brainstorm"
    location: "brainstorm/mechanics/vanguard_economy.md"
    description: |
      Implementation of Cadre/Sympathizer distinction and Coherence mechanics.
      Moves away from generic "mana" to materialist simulation of Organization vs Movement.
      Key mechanic: Coherence Factor derived from Cadre:Sympathizer ratio.
      Player trap: "Influencer Trap" - farming Reputation faster than training Cadre
      leads to massive but uncontrollable mob during historical rupture.
    resources:
      - "Cadre Labor (CL): Deterministic, high-value, structural actions"
      - "Sympathizer Labor (SL): Stochastic, mass volume, mass actions"
      - "Reputation: Multiplier for SL volume (not quality)"
    formula: "Effective Output = (SL * Reputation) * Coherence Factor"
    dependencies: ["Phase 3.4 Imperial Circuit complete"]

  kinetic_warfare:
    phase: 5
    status: "brainstorm"
    location: "brainstorm/mechanics/kinetic_warfare.md"
    description: |
      Asymmetric combat focusing on infrastructure sabotage, supply chain interdiction,
      and risk/blowback calculation (Civilian harm vs. State damage).
      Not modeling frontlines (Hearts of Iron) but System Disruption and Insurgency.
      Combat occurs on Layer 0 Spatial Graph (Nodes and Edges).
    target_triad:
      - "Nodes of Extraction: Industrial farms, mines, logistics hubs (starve State of resources)"
      - "Edges of Circulation: Power lines, fiber cables, highways (Social Blowback mechanic)"
      - "Nodes of Realization: Data centers, arms factories, command bunkers (QRF threat)"
    gameplay_loop:
      - "Reconnaissance: Reveal hidden attributes (Defense, Connectivity, Collateral Risk)"
      - "Preparation: Cultivate local sympathy (Human Shield effect)"
      - "Strike: Auto-resolved tactical resolution based on Force correlations"
      - "Fallout: Calculate Consciousness shift and State Repression"
    dependencies: ["Layer 0 Spatial Graph", "Consciousness Vector"]

# =============================================================================
# CURRENT FOCUS
# =============================================================================

current_focus:
  primary: "Transitioning from Phase III (Material Base) to Phase IV (Superstructure)"
  roadmap: "ai-docs/roadmap.md"
  legacy_roadmap: "brainstorm/plans/four-phase-engine-blueprint.md (DEPRECATED)"
  phase2_design: "brainstorm/plans/phase2-game-loop-design.md"
  architecture_spec: "ai-docs/game-loop-architecture.yaml"
  verification_framework: "brainstorm/babylon-protocol-verification.md"

  vertical_slice_scope:
    description: "Minimal complete gameplay experience"
    entities: "Factory worker (proletariat) vs Capitalist (bourgeoisie)"
    location: "One city (implicit)"
    phenomenon: "Wealth transfer via Imperial Rent"
    flow: "Simulation tick → Events → RAG context → LLM prompt → Narrative output"

  recently_completed:
    - "XML to JSON migration"
    - "JSON Schema system (36 schemas)"
    - "Schema validation tooling"
    - "LLM technology entries (T006-T011)"
    - "Project rename to Babylon"
    - "AI documentation system (ai-docs/)"
    - "Four-phase engine blueprint"
    - "Sprint 1: Types & Enums (Probability, Currency, Ideology, etc.)"
    - "Sprint 1: StrEnums (SocialRole, EdgeType, IntensityLevel, ResolutionType)"
    - "Tech debt cleanup: Migrated dataclasses to Pydantic"
    - "Created src/babylon/models/entities/ (Effect, Contradiction, Trigger)"
    - "Deleted old files: data/models/contradiction.py, data/models/trigger.py, core/contradiction.py"
    - "Sprint 2: SocialClass entity model (Phase 1 node)"
    - "Sprint 2: Relationship entity model (Phase 1 edge)"
    - "Phase 1 integration tests (11 tests proving the equations)"
    - "Phase 2 architecture design (Data/Logic separation)"
    - "Created ai-docs/game-loop-architecture.yaml"
    - "Created brainstorm/plans/phase2-game-loop-design.md"
    - "ADR010: Direct Entities + Formulas architecture (bypass Economy/Politics)"
    - "Gap analysis: 8 gaps identified and resolved"
    - "Formula-to-Entity wiring specification documented"
    - "ADR011: Pure Graph Architecture (multi-AI consensus: Claude + Gemini)"
    - "Decision: Delete Economy/Politics classes (not preserve)"
    - "Decision: NetworkX from day one (not deferred)"
    - "Decision: Hybrid state management (Snapshots + Events)"
    - "Sprint 3: SimulationConfig model (42 tests)"
    - "Sprint 4: WorldState with NetworkX integration (35 tests)"
    - "Sprint 5: SimulationEngine step() function (19 tests)"
    - "Sprint 6: Factory functions and integration tests (20 tests)"
    - "Sprint 7: Deleted Economy/Politics classes per ADR011"
    - "PHASE 2 COMPLETE: 318 tests passing, deterministic game loop"
    - "Sprint 7.5: Consciousness Drift integration (7 tests, 325 total)"
    - "Brainstorm: Babylon Protocol - emergence vs bugs verification framework"
    - "Sprint 7.6: Configurable tension rate + consciousness feedback tests (5 tests, 330 total)"
    - "Sprint 8: History Stack with File I/O and Auto-Checkpointing (123 tests, 453 total)"
    - "Sprint 9: Component System (Material, Vitality, Spatial, Ideological, Organization)"
    - "Sprint 10: ServiceContainer dependency injection (Sprint 3 architecture)"
    - "Sprint 11: System Protocol and 4 System implementations"
    - "Sprint 12: Simulation facade and entity factories (57 tests, 704 total)"
    - "Integration Proof: 100-tick simulation proves wealth transfer dynamics"
    - "Sprint 3.1: Observer Pattern - SimulationObserver protocol (32 tests, 736 total)"
    - "Sprint 3.2: RAG Integration - RagPipeline injection into NarrativeDirector (27 tests, 763 total)"
    - "Tech debt: Fixed 90 mypy errors in RAG module (Mikado refactor)"
    - "Tech debt: Migrated ChromaDB API from deprecated Client to PersistentClient"

  current_phase:
    name: "Phase 3.4: The Imperial Circuit"
    status: "IN PROGRESS - Sprint 3.4.3 next"
    goal: "Expand 2-node model to 4-node with true MLM-TW dynamics"
    tech: "SolidaritySystem + Multi-dimensional consciousness + Fascist Bifurcation"
    result_so_far: "886 tests passing, Imperial Circuit operational, Proletarian Internationalism complete"
    key_insight: "solidarity_strength stored on edge, not auto-calculated - enables Fascist Bifurcation"
    mantras:
      - "The bomb factory pays well. That's the problem."
      - "Agitation without solidarity produces fascism, not revolution."
    completed_sprints:
      sprint_3_1:
        name: "The Dialectical Interface"
        status: "COMPLETE"
        deliverables:
          - "SimulationObserver protocol"
          - "NarrativeDirector implementation"
          - "Observer lifecycle hooks"
        tests_added: 32
      sprint_3_2:
        name: "The Materialist Retrieval"
        status: "COMPLETE"
        deliverables:
          - "DialecticalPromptBuilder"
          - "RAG pipeline injection"
          - "Context hierarchy assembly"
        tests_added: 27
    remaining_work:
      sprint_3_3:
        name: "LLM Integration (Vertical Slice)"
        status: "NOT STARTED"
        deliverables:
          - "LLM Provider protocol + implementations"
          - "Event generation in ImperialRentSystem"
          - "Static theoretical quotes fallback"
          - "Vertical slice CLI runner"
    architecture: "Observer reads state, builds context, calls LLM, outputs narrative"

  previous_phase:
    name: "Phase 2: The Topological Engine"
    status: "COMPLETE"
    goal: "Game loop that runs equations forward in time"
    tech: "Pure Python, Pydantic, Pytest - NO UI, NO AI"
    result: "704 tests passing, modular System architecture, all feedback loops proven"
    key_insight: "Separate Data (WorldState) from Logic (SimulationEngine)"
    key_decisions:
      - "ADR010 - Direct Entities + Formulas"
      - "ADR011 - Pure Graph Architecture (multi-AI consensus)"
    feedback_loops_proven:
      - "Rent Spiral - extraction impoverishes worker"
      - "Consciousness Drift - exploited workers become revolutionary"
      - "Consciousness Resistance - revolutionary workers resist extraction"
      - "Repression Trap - high repression delays but doesn't prevent revolution"
      - "Tension Accumulation - wealth gap increases contradiction tension"
    architecture: "Graph + Math = History"

  next_phase:
    name: "Phase 3.4: The Imperial Circuit"
    goal: "Expand 2-node model to 4-node model with true MLM-TW dynamics"
    tech: "WAGES edge type + Multi-dimensional consciousness"
    spec: "ai-docs/imperial-circuit.yaml"
    rationale: |
      The 2-node model is "orthodox book-worship Marxism" - too simple.
      It correctly models periphery dynamics (exploitation → consciousness → revolution)
      but fails to capture WHY core workers support imperialism: they benefit from it.
      "The bomb factory pays well. That's the problem."
    key_components:
      - "4 nodes: P_w (periphery worker), P_c (comprador), C_b (core bourgeoisie), C_w (core worker)"
      - "WAGES edge: C_b → C_w (super-wages funded by imperial rent)"
      - "TRIBUTE edge: P_c → C_b (imperial rent transfer)"
      - "Multi-dimensional consciousness: class_consciousness + national_identity + atomization"
      - "W/V ratio determining consciousness direction (up for periphery, down for core)"
    sprints:
      3_4_1: "WAGES Edge Type - enable super-wage flow"
      3_4_2: "4-Node Scenario - create_imperial_circuit_scenario()"
      3_4_3: "Multi-Dimensional Consciousness - split ideology variable"
      3_4_4: "Dynamic Balance - shrinking pool, bourgeoisie choices"
    blockers: "None - Phase 3.3 vertical slice provides foundation"

  phase_3_5:
    name: "Phase 3.5: The Territorial Foundation (Layer 0)"
    status: "COMPLETE"
    goal: "Ground all Social Graph nodes onto a Spatial Graph (Territory)"
    tech: "Spatial Graph + Host/Parasite tenure + Enclosure mechanics"
    key_components:
      - "Strategic Sectors - territorial units (Slums, Financial District, etc.)"
      - "Subversive Tenancy - De Facto control while enemy holds Legal control"
      - "Suspicion metric - likelihood of Eviction Event"
      - "Enclosure mechanics - converting communal to private tenure"
    architectural_insight: |
      Layer 0 Pivot: Refactor to ground all Social Graph (Topology) nodes onto
      a Spatial Graph (Territory). Moves from abstract 'Factions' to
      'Territory-bound Factions' with Host/Parasite tenure systems.
      This enables modeling geographic class struggle, gentrification,
      and the material basis of political power (who controls what land).
    blockers: "Phase 3.4 Imperial Circuit should be stable first"

  future_phase:
    name: "Phase 4: The Control Room"
    goal: "NiceGUI dashboard for simulation control and visualization"
    tech: "NiceGUI + State visualizations + User controls"
    key_components:
      - "State dashboard - entity status, tension gauges"
      - "Narrative display - LLM-generated prose"
      - "Control panel - start/stop/step simulation"
      - "History browser - timeline with undo/redo"
    blockers: "Phase 3.5 territorial foundation should be complete"

  sprint_status:
    sprint_1:
      name: "Value Types & Enums"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/models/types.py (6 types)"
        - "src/babylon/models/enums.py (4 enums)"
        - "tests/unit/models/test_types.py (45 tests)"
        - "tests/unit/models/test_enums.py (22 tests)"
      tests_passing: 131

    sprint_1_5:
      name: "Physics Module"
      status: "COMPLETE (PRE-EXISTING)"
      discovery: "2024-12-07 - Formulas already existed in src/babylon/systems/formulas.py"
      location: "src/babylon/systems/formulas.py (349 lines)"
      tests: "tests/unit/formulas/ (40 tests, ALL PASSING)"
      formulas_implemented:
        - "calculate_imperial_rent() - Imperial rent extraction"
        - "calculate_acquiescence_probability() - P(S|A) sigmoid"
        - "calculate_revolution_probability() - P(S|R)"
        - "calculate_crossover_threshold() - When revolt becomes rational"
        - "calculate_labor_aristocracy_ratio() - Wc/Vc ratio"
        - "is_labor_aristocracy() - Boolean check"
        - "calculate_consciousness_drift() - dΨ/dt ideology change"
        - "apply_loss_aversion() - Kahneman-Tversky λ=2.25"
        - "calculate_exchange_ratio() - Unequal exchange ε"
        - "calculate_value_transfer() - Core-periphery flows"
        - "prebisch_singer_effect() - Deteriorating terms of trade"
      lesson_learned: "Always explore actual codebase before planning new work"

    sprint_2:
      name: "Entity Models"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/models/entities/social_class.py (SocialClass)"
        - "src/babylon/models/entities/relationship.py (Relationship)"
        - "tests/unit/models/test_social_class.py (31 tests)"
        - "tests/unit/models/test_relationship.py (29 tests)"
        - "tests/integration/test_phase1_blueprint.py (11 tests)"
      tests_passing: 202
      phase_1_complete: true
      notes: "Phase 1 blueprint proven: two nodes, one edge, formulas work"

    sprint_3:
      name: "SimulationConfig"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/models/config.py (SimulationConfig)"
        - "tests/unit/models/test_config.py (42 tests)"
      tests_passing: 244
      notes: "Frozen config with all formula coefficients"

    sprint_4:
      name: "WorldState with NetworkX"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/models/world_state.py (WorldState)"
        - "tests/unit/models/test_world_state.py (35 tests)"
      tests_passing: 279
      notes: "Immutable state, to_graph()/from_graph() conversion"

    sprint_5:
      name: "SimulationEngine step()"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/simulation_engine.py"
        - "tests/unit/engine/test_simulation_engine.py (19 tests)"
      tests_passing: 298
      notes: "Pure function, deterministic, encodes historical materialism"

    sprint_6:
      name: "Factory Functions & Integration Tests"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/scenarios.py"
        - "tests/integration/test_phase2_game_loop.py (20 tests)"
      tests_passing: 318
      notes: "Feedback loops proven: rent spiral, repression trap"

    sprint_7:
      name: "Delete Economy/Politics per ADR011"
      status: "COMPLETE"
      deliverables:
        - "Deleted src/babylon/core/economy.py"
        - "Deleted src/babylon/core/politics.py"
        - "Updated __main__.py to use engine"
      tests_passing: 318
      notes: "Pure Graph Architecture - no institutional classes"

    sprint_7_5:
      name: "Consciousness Drift Integration"
      status: "COMPLETE"
      deliverables:
        - "_update_consciousness_drift() helper function"
        - "consciousness_decay_lambda config field"
        - "tests/unit/engine/test_simulation_engine.py::TestStepConsciousnessDrift (7 tests)"
      tests_passing: 325
      notes: "Worker ideology drifts revolutionary as extraction continues"

    sprint_7_6:
      name: "Configurable Tension Rate & Feedback Tests"
      status: "COMPLETE"
      deliverables:
        - "tension_accumulation_rate config field"
        - "TestStepTensionRate (3 tests)"
        - "TestConsciousnessFeedbackLoop (2 tests)"
      tests_passing: 330
      notes: "All feedback loops now proven with integration tests"

    sprint_8:
      name: "History Stack with File I/O and Auto-Checkpointing"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/history/models.py (5 Pydantic models)"
        - "src/babylon/engine/history/stack.py (7 pure functions)"
        - "src/babylon/engine/history/io.py (6 I/O functions + 4 exception types)"
        - "src/babylon/engine/history/auto_checkpoint.py (AutoCheckpointer class)"
        - "tests/unit/engine/history/ (123 tests)"
      tests_passing: 453
      notes: "Undo/redo, save/load, auto-checkpointing. Branching deferred."

    sprint_9:
      name: "Component System (Material Ontology)"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/models/components/base.py (Component protocol)"
        - "src/babylon/models/components/material.py (MaterialComponent)"
        - "src/babylon/models/components/vitality.py (VitalityComponent)"
        - "src/babylon/models/components/spatial.py (SpatialComponent)"
        - "src/babylon/models/components/ideological.py (IdeologicalComponent)"
        - "src/babylon/models/components/organization.py (OrganizationComponent)"
        - "tests/unit/models/components/ (129 tests)"
      tests_passing: 582
      notes: "Frozen Pydantic models with constrained types"

    sprint_10:
      name: "ServiceContainer & Dependency Injection"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/services.py (ServiceContainer)"
        - "src/babylon/engine/event_bus.py (EventBus)"
        - "src/babylon/engine/formula_registry.py (FormulaRegistry)"
        - "src/babylon/engine/database.py (DatabaseConnection)"
        - "tests/unit/engine/test_services.py"
        - "tests/unit/engine/test_event_bus.py (20 tests)"
        - "tests/unit/engine/test_formula_registry.py (14 tests)"
      tests_passing: 630
      notes: "Clean dependency injection for testability"

    sprint_11:
      name: "System Protocol & Implementations"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/systems/protocol.py (System protocol)"
        - "src/babylon/engine/systems/economic.py (ImperialRentSystem)"
        - "src/babylon/engine/systems/ideology.py (ConsciousnessSystem)"
        - "src/babylon/engine/systems/survival.py (SurvivalSystem)"
        - "src/babylon/engine/systems/contradiction.py (ContradictionSystem)"
      tests_passing: 647
      notes: "Modular systems with shared ServiceContainer"

    sprint_12:
      name: "Simulation Facade & Entity Factories"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/simulation.py (Simulation class)"
        - "src/babylon/engine/factories.py (create_proletariat, create_bourgeoisie)"
        - "src/babylon/engine/history_formatter.py (format_class_struggle_history)"
        - "tests/unit/engine/test_simulation_facade.py (19 tests)"
        - "tests/unit/engine/test_factories.py (30 tests)"
        - "tests/integration/test_class_struggle.py (8 tests)"
      tests_passing: 704
      notes: "Integration proof: 100-tick wealth transfer verified"

    sprint_3_1:
      name: "The Dialectical Interface (Observer Pattern)"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/observer.py (SimulationObserver protocol)"
        - "src/babylon/ai/director.py (NarrativeDirector)"
        - "Modified src/babylon/engine/simulation.py (observer support)"
        - "tests/unit/engine/test_observer_pattern.py (32 tests)"
        - "tests/unit/ai/test_narrative_director.py"
      tests_passing: 736
      notes: "Observer Pattern for AI narrative integration"

    sprint_3_2:
      name: "The Materialist Retrieval (RAG Integration)"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/ai/prompt_builder.py (DialecticalPromptBuilder)"
        - "Modified src/babylon/ai/director.py (RAG injection)"
        - "tests/unit/ai/test_prompt_builder.py"
        - "tests/unit/ai/test_director_rag.py (27 tests)"
      tests_passing: 763
      notes: "RAG pipeline integrated, context hierarchy implemented"
      tech_debt_resolved:
        - "90 mypy errors in RAG module (Mikado refactor)"
        - "ChromaDB API migration to PersistentClient"

    sprint_3_3:
      name: "LLM Integration (Vertical Slice)"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/ai/llm_provider.py (protocol + DeepSeek implementation)"
        - "Modified ImperialRentSystem (event generation)"
        - "RAG corpus ingestion script (5 texts from Marxists.org)"
        - "Integration tests proving full narrative pipeline"
      llm_choice: "DeepSeek API (OpenAI-compatible, cost-effective)"
      testing_approach: "Integration tests instead of CLI runner"
      rag_corpus: "5 curated texts from Marxists.org (~200-500 chunks)"
      tests_passing: 800
      scope: "Factory worker vs capitalist, one phenomenon (wealth transfer)"

    sprint_3_4_1:
      name: "Economic Infrastructure (Imperial Circuit)"
      status: "COMPLETE"
      deliverables:
        - "EdgeType.TRIBUTE (P_c → C_b tribute transfer)"
        - "EdgeType.WAGES (C_b → C_w super-wages)"
        - "EdgeType.CLIENT_STATE (C_b → P_c imperial subsidy)"
        - "EventType.IMPERIAL_SUBSIDY (narrative event)"
        - "4-phase ImperialRentSystem (extraction, tribute, wages, subsidy)"
        - "Relationship.subsidy_cap field for CLIENT_STATE edges"
        - "SimulationConfig: comprador_cut, super_wage_rate, subsidy_* params"
      tests_passing: 829
      commit: "5c5dbc9"
      key_insight: "Wealth converts to repression (not conserved) for imperial subsidy"

    sprint_3_4_2:
      name: "Proletarian Internationalism"
      status: "COMPLETE"
      deliverables:
        - "SolidaritySystem - consciousness transmission via SOLIDARITY edges"
        - "Relationship.solidarity_strength field (STORED ON EDGE)"
        - "EventType.SOLIDARITY_AWAKENING (source enters active struggle)"
        - "EventType.CONSCIOUSNESS_TRANSMISSION (delta transfer)"
        - "EventType.MASS_AWAKENING (target crosses threshold)"
        - "calculate_solidarity_transmission() formula"
        - "SimulationConfig: solidarity_activation_threshold, mass_awakening_threshold"
      tests_passing: 886
      commit: "61fe9c1"
      key_insight: |
        solidarity_strength is STORED ON EDGE, not auto-calculated from organization.
        This enables Fascist Bifurcation: same material conditions → different outcomes
        based on whether solidarity infrastructure was BUILT beforehand.
        "Agitation without solidarity produces fascism, not revolution."

  phase_roadmap:
    superseded_note: "Four-Phase Blueprint → Six-Phase Fractal Evolution (2025-12-09)"
    phase_1:
      name: "Minimum Viable Dialectic"
      summary: "Prove the equations work"
      status: "COMPLETE"
    phase_2:
      name: "Topological Engine"
      summary: "The physics/update loop"
      status: "COMPLETE"
    phase_2_5:
      name: "Test Refactor (Operation Clean Slate)"
      summary: "Testing infrastructure - DomainFactory, BabylonAssert, MetricsSpy"
      status: "COMPLETE"
      added: "2025-12-12 (Truth Sync)"
    phase_2_6:
      name: "Observer Protocol"
      summary: "Decoupled observation - SimulationObserver, TopologyMonitor"
      status: "COMPLETE"
      added: "2025-12-12 (Truth Sync)"
      note: "models/events.py (Pydantic event schema) is PLANNED, not implemented"
    phase_3:
      name: "Observer Pattern"
      summary: "AI narrates, never controls"
      status: "COMPLETE (Sprint 3.3 - Vertical Slice)"
    phase_3_4:
      name: "Imperial Circuit"
      summary: "4-node model with WAGES edges"
      status: "IN PROGRESS"
      sprints:
        3_4_1:
          name: "Economic Infrastructure"
          status: "COMPLETE"
          deliverables:
            - "TRIBUTE edge type (P_c → C_b)"
            - "WAGES edge type (C_b → C_w)"
            - "CLIENT_STATE edge type (C_b → P_c subsidy)"
            - "IMPERIAL_SUBSIDY event type"
            - "4-phase ImperialRentSystem"
          tests: "829 tests passing"
          commit: "5c5dbc9"
        3_4_2:
          name: "Proletarian Internationalism"
          status: "COMPLETE"
          deliverables:
            - "SolidaritySystem (consciousness transmission)"
            - "solidarity_strength edge attribute (stored infrastructure)"
            - "SOLIDARITY_AWAKENING event type"
            - "CONSCIOUSNESS_TRANSMISSION event type"
            - "MASS_AWAKENING event type"
            - "Fascist Bifurcation mechanic enabled"
          tests: "886 tests passing"
          commit: "61fe9c1"
          key_insight: "solidarity_strength is STORED ON EDGE, not auto-calculated - enables Fascist Bifurcation"
        3_4_3:
          name: "Multi-Dimensional Consciousness (The George Jackson Refactor)"
          status: "COMPLETE"
          deliverables:
            - "IdeologicalProfile model (class_consciousness, national_identity, agitation)"
            - "calculate_ideological_routing() formula"
            - "Fascist Bifurcation mechanic: agitation + solidarity → revolution, agitation alone → fascism"
            - "Removed legacy scalar ideology - clean migration to multi-dimensional model"
          tests: "987 tests passing"
          commits: ["73d991d", "51c4de6"]
          key_insight: "Fascism is the defensive form of capitalism."
        3_4_4:
          name: "Dynamic Balance"
          status: "PLANNED"
          deliverables:
            - "Imperial rent pool as emergent property"
            - "Bourgeoisie choice system"
            - "Crisis events as phase transitions"
    phase_3_5:
      name: "Territorial Foundation (Layer 0)"
      summary: "Spatial Graph grounding Social Graph"
      status: "PLANNED"
      key_components:
        - "Strategic Sectors (territorial units)"
        - "Subversive Tenancy (Host/Parasite logic)"
        - "Suspicion metric (Eviction risk)"
        - "Enclosure mechanics"
    phase_4:
      name: "Control Room"
      summary: "NiceGUI dashboard"
      status: "PLANNED"
    phase_5:
      name: "Internal Colonies"
      summary: "Fractal topology - race/gender/geographic stratification"
      status: "FUTURE"
      key_insight: "Composite/Graph pattern enables modeling stratification within Core"
    phase_6:
      name: "Full Simulation"
      summary: "Multi-country, multi-faction, full complexity"
      status: "FUTURE"

  next_steps:
    current_sprint: "Sprint 3.4.4: Dynamic Balance"
    completed:
      - "Sprint 3.3: Vertical Slice (COMPLETE)"
      - "Sprint 3.4.1: Economic Infrastructure - TRIBUTE, WAGES, CLIENT_STATE edges (COMPLETE)"
      - "Sprint 3.4.2: Proletarian Internationalism - SolidaritySystem (COMPLETE)"
      - "Sprint 3.4.3: Multi-Dimensional Consciousness - IdeologicalProfile (COMPLETE)"
      - "Sprint 3.5: Layer 0 Territorial Substrate (COMPLETE)"
    in_progress:
      - "Verify Agitation Router mechanics in integration tests"
    planned:
      - "Sprint 3.4.4: Dynamic Balance - shrinking pool, bourgeoisie choices"
      - "Phase 4: NiceGUI Control Room - dashboard for simulation"
      - "Phase 5: Internal Colonies - fractal topology within Core"
    optional:
      - "Expand RAG corpus with more Marxists.org texts"
      - "Timeline branching for history stack"

  mantra: "Graph + Math = History"
  new_mantra: "The bomb factory pays well. That's the problem."
  old_mantra: "State is data. Engine is logic. They never mix."
  fascist_trap_mantra: "Agitation without solidarity produces fascism, not revolution."
  george_jackson_mantra: "Fascism is the defensive form of capitalism."
  milestone: "SPRINT 3.4.3 COMPLETE: George Jackson Refactor - IdeologicalProfile replaces scalar ideology"
  next_milestone: "SPRINT 3.4.4: Dynamic Balance - verify agitation routing mechanics"
  test_count: 1668
  test_count_note: "Updated 2025-12-12 via Operation Truth Sync audit"
  analysis_insight: |
    2025-12-09: Identified why vertical slice stalls after tick 2.
    Consciousness formula has k/λ ratio = 5.0, hits ceiling at tick 2.
    This is CORRECT for periphery dynamics, but model is too simple.
    Current model is "orthodox book-worship Marxism" - missing:
    - Super-wages (W > V) for core workers
    - Imperial rent pool dynamics
    - False consciousness from material benefit
    - Multi-dimensional consciousness (class vs national vs atomization)
  philosophical_grounding: |
    "The Economy is not a class; it is the sum of all EXTRACTS_FROM edges."
    Architecture encodes theory. The code IS the analysis.

# =============================================================================
# IDEA QUARANTINE PROTOCOL
# =============================================================================

quarantine:
  location: "~/projects/game/notes/"
  purpose: "Dump ideas without derailing implementation"
  rule: "If it's not in next_steps, it goes in notes/ or brainstorm/deferred-ideas.md"
  deferred_parking: "brainstorm/deferred-ideas.md"

# =============================================================================
# TECH DEBT
# =============================================================================

tech_debt:

  legacy_xml:
    location: "src/babylon/data/xml/"
    status: "Migrated, kept for reference"
    action: "Can delete after confidence in JSON"
    priority: "low"

  legacy_economy_politics:
    status: "RESOLVED"
    action: "Deleted in Sprint 7 per ADR011"
    notes: "Pure Graph Architecture - no institutional classes"

  incomplete_models:
    issue: "Not all entities have Pydantic models"
    action: "Generate from JSON schemas as needed"
    priority: "low - current models sufficient for Phase 2-3"

  test_coverage:
    status: "EXCELLENT"
    current: "1668 tests passing (2025-12-12)"
    coverage: "Core engine + systems + persistence + components fully tested, TDD discipline maintained"
    action: "Continue TDD for new features"
    testing_infrastructure:
      - "DomainFactory (tests/factories/domain.py) - 31 tests"
      - "BabylonAssert (tests/assertions.py) - 55 tests"
      - "MockMetricsCollector (tests/mocks/metrics_collector.py) - 8 tests"

  documentation_drift:
    issue: "README.md still references PostgreSQL, old structure"
    action: "Update when Phase 3 complete"
    priority: "low - ai-docs/ is source of truth"

  legacy_contradiction_analysis:
    location: "src/babylon/systems/contradiction_analysis.py"
    status: "Partially superseded"
    notes: "Tension now tracked on Relationship edges, but legacy class still used in __main__.py"
    action: "Evaluate during Phase 3"
