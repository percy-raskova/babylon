# Babylon Project State
# What exists vs what's planned - KEEP THIS UPDATED

meta:
  version: "1.1.0"
  updated: "2025-12-08"
  principle: "Be honest about what's implemented vs aspirational"

# =============================================================================
# IMPLEMENTATION STATUS
# =============================================================================

implemented:

  data_layer:
    status: "functional"
    components:
      json_data_files:
        status: "complete"
        details: "17 entity collections migrated from XML"
        location: "src/babylon/data/game/*.json"

      json_schemas:
        status: "complete"
        details: "Draft 2020-12 schemas for all entities"
        location: "src/babylon/schemas/"
        validation: "poetry run python tools/validate_schemas.py"

      pydantic_models:
        status: "partial"
        details: "Some models exist, not all entities covered"
        location: "src/babylon/data/models/"

      database:
        status: "configured"
        details: "SQLite setup, no tables populated yet"
        location: "src/babylon/data/database.py"

  core_logic:
    status: "complete"
    components:
      simulation_engine:
        status: "complete"
        details: "Modular engine with 4 Systems, ServiceContainer DI"
        location: "src/babylon/engine/simulation_engine.py"
        tests: "tests/unit/engine/test_simulation_engine.py (30+ tests)"
        architecture:
          - "SimulationEngine.run_tick(graph, services, context)"
          - "4 Systems: ImperialRent, Consciousness, Survival, Contradiction"
          - "ServiceContainer: config, database, event_bus, formulas"

      service_container:
        status: "complete"
        details: "Dependency injection container for all services"
        location: "src/babylon/engine/services.py"
        tests: "tests/unit/engine/test_services.py"
        provides:
          - "config: SimulationConfig"
          - "database: DatabaseConnection"
          - "event_bus: EventBus"
          - "formulas: FormulaRegistry"

      event_bus:
        status: "complete"
        details: "Publish/subscribe event system"
        location: "src/babylon/engine/event_bus.py"
        tests: "tests/unit/engine/test_event_bus.py (20 tests)"
        events_published:
          - "rupture - when tension reaches 1.0"

      formula_registry:
        status: "complete"
        details: "Hot-swappable formula lookup with 12 registered formulas"
        location: "src/babylon/engine/formula_registry.py"
        tests: "tests/unit/engine/test_formula_registry.py (14 tests)"

      systems:
        status: "complete"
        details: "4 modular System implementations"
        location: "src/babylon/engine/systems/"
        components:
          protocol: "System protocol with step(graph, services, context)"
          imperial_rent: "ImperialRentSystem - economic extraction"
          consciousness: "ConsciousnessSystem - ideology drift"
          survival: "SurvivalSystem - P(S|A) and P(S|R)"
          contradiction: "ContradictionSystem - tension accumulation"

      simulation_facade:
        status: "complete"
        details: "Stateful wrapper for multi-tick simulations"
        location: "src/babylon/engine/simulation.py"
        tests: "tests/unit/engine/test_simulation_facade.py (19 tests)"
        provides:
          - "Simulation.step() - advance one tick"
          - "Simulation.run(n) - run n ticks"
          - "Simulation.get_history() - all state snapshots"

      entity_factories:
        status: "complete"
        details: "Factory functions for entity creation"
        location: "src/babylon/engine/factories.py"
        tests: "tests/unit/engine/test_factories.py (30 tests)"
        provides:
          - "create_proletariat() - exploited class"
          - "create_bourgeoisie() - exploiter class"

      world_state:
        status: "complete"
        details: "Immutable state with NetworkX graph conversion"
        location: "src/babylon/models/world_state.py"
        tests: "tests/unit/models/test_world_state.py (35 tests)"

      simulation_config:
        status: "complete"
        details: "Frozen config with all formula coefficients"
        location: "src/babylon/models/config.py"
        tests: "tests/unit/models/test_config.py (42 tests)"

      formulas:
        status: "complete"
        details: "All MLM-TW formulas implemented and tested"
        location: "src/babylon/systems/formulas.py (348 lines)"
        tests: "tests/unit/formulas/ (40 tests)"
        includes:
          - "calculate_imperial_rent() - consciousness-dependent extraction"
          - "calculate_acquiescence_probability() - P(S|A) sigmoid"
          - "calculate_revolution_probability() - P(S|R)"
          - "calculate_consciousness_drift() - dΨ/dt ideology change"

      scenarios:
        status: "complete"
        details: "Factory functions for test scenarios"
        location: "src/babylon/engine/scenarios.py"
        includes:
          - "create_two_node_scenario()"
          - "create_high_tension_scenario()"
          - "create_labor_aristocracy_scenario()"

      history_persistence:
        status: "complete"
        details: "History stack, file I/O, auto-checkpointing"
        location: "src/babylon/engine/history/"
        tests: "tests/unit/engine/history/ (123 tests)"
        includes:
          - "HistoryStack - undo/redo with max_depth pruning"
          - "save_state/load_state - WorldState file I/O"
          - "save_checkpoint/load_checkpoint - full state + config + metadata"
          - "AutoCheckpointer - interval-based automatic saves"
          - "Atomic writes - temp file + rename pattern"

      contradiction_analysis:
        status: "partial"
        details: "ContradictionAnalysis class exists, basic methods work"
        location: "src/babylon/systems/contradiction_analysis.py"
        note: "Legacy - tension now tracked on Relationship edges"

  ai_layer:
    status: "scaffolded"
    components:
      chromadb:
        status: "configured"
        details: "Connection setup exists"
        location: "src/babylon/rag/"
        missing: "Populated embeddings, query interface"

      embeddings:
        status: "partial"
        details: "entity_embedding_service.py exists"
        missing: "Full corpus embedded"

  tooling:
    status: "functional"
    components:
      xml_migration:
        status: "complete"
        location: "tools/migrate_xml_to_json.py"

      schema_validation:
        status: "complete"
        location: "tools/validate_schemas.py"

      testing:
        status: "configured"
        details: "Pytest with markers, some tests exist"

      linting:
        status: "configured"
        details: "Ruff + MyPy strict"

# =============================================================================
# NOT YET IMPLEMENTED
# =============================================================================

not_implemented:

  observer_protocol:
    priority: "high"
    description: "Interface for LLM to observe state changes"
    blockers: "None - ready to implement"
    phase: 3

  context_builder:
    priority: "high"
    description: "Token-aware function to build LLM context from state"
    blockers: "None - ready to implement"
    phase: 3

  ai_narrative:
    priority: "high"
    description: "LLM generates prose from state changes (Observer Pattern)"
    blockers: "Event bus needed"
    phase: 3

  ui:
    priority: "medium"
    description: "Player interface (NiceGUI planned)"
    blockers: "Phase 3 narrative layer"
    phase: 4

  branching_history:
    priority: "low"
    description: "Timeline branching for history stack (branch_id, create_branch)"
    blockers: "None - deferred for simplicity"
    notes: "Current linear history sufficient; add branching if needed for UI"

  sanity_spies:
    priority: "low"
    description: "Runtime invariant validators (Babylon Protocol)"
    blockers: "Event bus for integration"
    design_doc: "brainstorm/babylon-protocol-verification.md"

# =============================================================================
# PLANNED FEATURES (BRAINSTORM)
# =============================================================================

planned:

  gramscian_wiki:
    status: "brainstorm"
    location: "brainstorm/gramscian-wiki-engine.md"
    description: "Hegemony as factional control over in-game wiki"
    dependencies: ["jinja2", "markdown renderer"]

  llm_tech_tree:
    status: "implemented"
    location: "src/babylon/data/technologies.json (T006-T011)"
    description: "AI as dual-use technology in game mechanics"

# =============================================================================
# CURRENT FOCUS
# =============================================================================

current_focus:
  primary: "PHASE 2 COMPLETE - Ready for Phase 3: Observer Pattern"
  roadmap: "brainstorm/plans/four-phase-engine-blueprint.md"
  phase2_design: "brainstorm/plans/phase2-game-loop-design.md"
  architecture_spec: "ai-docs/game-loop-architecture.yaml"
  verification_framework: "brainstorm/babylon-protocol-verification.md"

  recently_completed:
    - "XML to JSON migration"
    - "JSON Schema system (36 schemas)"
    - "Schema validation tooling"
    - "LLM technology entries (T006-T011)"
    - "Project rename to Babylon"
    - "AI documentation system (ai-docs/)"
    - "Four-phase engine blueprint"
    - "Sprint 1: Types & Enums (Probability, Currency, Ideology, etc.)"
    - "Sprint 1: StrEnums (SocialRole, EdgeType, IntensityLevel, ResolutionType)"
    - "Tech debt cleanup: Migrated dataclasses to Pydantic"
    - "Created src/babylon/models/entities/ (Effect, Contradiction, Trigger)"
    - "Deleted old files: data/models/contradiction.py, data/models/trigger.py, core/contradiction.py"
    - "Sprint 2: SocialClass entity model (Phase 1 node)"
    - "Sprint 2: Relationship entity model (Phase 1 edge)"
    - "Phase 1 integration tests (11 tests proving the equations)"
    - "Phase 2 architecture design (Data/Logic separation)"
    - "Created ai-docs/game-loop-architecture.yaml"
    - "Created brainstorm/plans/phase2-game-loop-design.md"
    - "ADR010: Direct Entities + Formulas architecture (bypass Economy/Politics)"
    - "Gap analysis: 8 gaps identified and resolved"
    - "Formula-to-Entity wiring specification documented"
    - "ADR011: Pure Graph Architecture (multi-AI consensus: Claude + Gemini)"
    - "Decision: Delete Economy/Politics classes (not preserve)"
    - "Decision: NetworkX from day one (not deferred)"
    - "Decision: Hybrid state management (Snapshots + Events)"
    - "Sprint 3: SimulationConfig model (42 tests)"
    - "Sprint 4: WorldState with NetworkX integration (35 tests)"
    - "Sprint 5: SimulationEngine step() function (19 tests)"
    - "Sprint 6: Factory functions and integration tests (20 tests)"
    - "Sprint 7: Deleted Economy/Politics classes per ADR011"
    - "PHASE 2 COMPLETE: 318 tests passing, deterministic game loop"
    - "Sprint 7.5: Consciousness Drift integration (7 tests, 325 total)"
    - "Brainstorm: Babylon Protocol - emergence vs bugs verification framework"
    - "Sprint 7.6: Configurable tension rate + consciousness feedback tests (5 tests, 330 total)"
    - "Sprint 8: History Stack with File I/O and Auto-Checkpointing (123 tests, 453 total)"
    - "Sprint 9: Component System (Material, Vitality, Spatial, Ideological, Organization)"
    - "Sprint 10: ServiceContainer dependency injection (Sprint 3 architecture)"
    - "Sprint 11: System Protocol and 4 System implementations"
    - "Sprint 12: Simulation facade and entity factories (57 tests, 704 total)"
    - "Integration Proof: 100-tick simulation proves wealth transfer dynamics"

  current_phase:
    name: "Phase 2: The Topological Engine"
    status: "COMPLETE"
    goal: "Game loop that runs equations forward in time"
    tech: "Pure Python, Pydantic, Pytest - NO UI, NO AI"
    result: "704 tests passing, modular System architecture, all feedback loops proven"
    key_insight: "Separate Data (WorldState) from Logic (SimulationEngine)"
    key_decisions:
      - "ADR010 - Direct Entities + Formulas"
      - "ADR011 - Pure Graph Architecture (multi-AI consensus)"
    feedback_loops_proven:
      - "Rent Spiral - extraction impoverishes worker"
      - "Consciousness Drift - exploited workers become revolutionary"
      - "Consciousness Resistance - revolutionary workers resist extraction"
      - "Repression Trap - high repression delays but doesn't prevent revolution"
      - "Tension Accumulation - wealth gap increases contradiction tension"
    architecture: "Graph + Math = History"

  next_phase:
    name: "Phase 3: The Observer Pattern"
    goal: "AI narrates state changes without controlling simulation"
    tech: "Observer Protocol + LLM abstraction + Context Builder"
    key_components:
      - "Observer Protocol - interface for LLM to observe state"
      - "Context Builder - token-aware state serialization"
      - "LLM Abstraction - Ollama/Claude provider"
      - "More Event Types - wealth_transfer, ideology_drift, etc."
      - "AI Observer - generate narrative from events (read-only)"
    blockers: "None - ready to begin"
    prerequisites_complete:
      - "EventBus implemented (src/babylon/engine/event_bus.py)"
      - "ServiceContainer implemented (src/babylon/engine/services.py)"
      - "History system complete (undo/redo, persistence)"
      - "100-tick simulation proven working"

  sprint_status:
    sprint_1:
      name: "Value Types & Enums"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/models/types.py (6 types)"
        - "src/babylon/models/enums.py (4 enums)"
        - "tests/unit/models/test_types.py (45 tests)"
        - "tests/unit/models/test_enums.py (22 tests)"
      tests_passing: 131

    sprint_1_5:
      name: "Physics Module"
      status: "COMPLETE (PRE-EXISTING)"
      discovery: "2024-12-07 - Formulas already existed in src/babylon/systems/formulas.py"
      location: "src/babylon/systems/formulas.py (349 lines)"
      tests: "tests/unit/formulas/ (40 tests, ALL PASSING)"
      formulas_implemented:
        - "calculate_imperial_rent() - Imperial rent extraction"
        - "calculate_acquiescence_probability() - P(S|A) sigmoid"
        - "calculate_revolution_probability() - P(S|R)"
        - "calculate_crossover_threshold() - When revolt becomes rational"
        - "calculate_labor_aristocracy_ratio() - Wc/Vc ratio"
        - "is_labor_aristocracy() - Boolean check"
        - "calculate_consciousness_drift() - dΨ/dt ideology change"
        - "apply_loss_aversion() - Kahneman-Tversky λ=2.25"
        - "calculate_exchange_ratio() - Unequal exchange ε"
        - "calculate_value_transfer() - Core-periphery flows"
        - "prebisch_singer_effect() - Deteriorating terms of trade"
      lesson_learned: "Always explore actual codebase before planning new work"

    sprint_2:
      name: "Entity Models"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/models/entities/social_class.py (SocialClass)"
        - "src/babylon/models/entities/relationship.py (Relationship)"
        - "tests/unit/models/test_social_class.py (31 tests)"
        - "tests/unit/models/test_relationship.py (29 tests)"
        - "tests/integration/test_phase1_blueprint.py (11 tests)"
      tests_passing: 202
      phase_1_complete: true
      notes: "Phase 1 blueprint proven: two nodes, one edge, formulas work"

    sprint_3:
      name: "SimulationConfig"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/models/config.py (SimulationConfig)"
        - "tests/unit/models/test_config.py (42 tests)"
      tests_passing: 244
      notes: "Frozen config with all formula coefficients"

    sprint_4:
      name: "WorldState with NetworkX"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/models/world_state.py (WorldState)"
        - "tests/unit/models/test_world_state.py (35 tests)"
      tests_passing: 279
      notes: "Immutable state, to_graph()/from_graph() conversion"

    sprint_5:
      name: "SimulationEngine step()"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/simulation_engine.py"
        - "tests/unit/engine/test_simulation_engine.py (19 tests)"
      tests_passing: 298
      notes: "Pure function, deterministic, encodes historical materialism"

    sprint_6:
      name: "Factory Functions & Integration Tests"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/scenarios.py"
        - "tests/integration/test_phase2_game_loop.py (20 tests)"
      tests_passing: 318
      notes: "Feedback loops proven: rent spiral, repression trap"

    sprint_7:
      name: "Delete Economy/Politics per ADR011"
      status: "COMPLETE"
      deliverables:
        - "Deleted src/babylon/core/economy.py"
        - "Deleted src/babylon/core/politics.py"
        - "Updated __main__.py to use engine"
      tests_passing: 318
      notes: "Pure Graph Architecture - no institutional classes"

    sprint_7_5:
      name: "Consciousness Drift Integration"
      status: "COMPLETE"
      deliverables:
        - "_update_consciousness_drift() helper function"
        - "consciousness_decay_lambda config field"
        - "tests/unit/engine/test_simulation_engine.py::TestStepConsciousnessDrift (7 tests)"
      tests_passing: 325
      notes: "Worker ideology drifts revolutionary as extraction continues"

    sprint_7_6:
      name: "Configurable Tension Rate & Feedback Tests"
      status: "COMPLETE"
      deliverables:
        - "tension_accumulation_rate config field"
        - "TestStepTensionRate (3 tests)"
        - "TestConsciousnessFeedbackLoop (2 tests)"
      tests_passing: 330
      notes: "All feedback loops now proven with integration tests"

    sprint_8:
      name: "History Stack with File I/O and Auto-Checkpointing"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/history/models.py (5 Pydantic models)"
        - "src/babylon/engine/history/stack.py (7 pure functions)"
        - "src/babylon/engine/history/io.py (6 I/O functions + 4 exception types)"
        - "src/babylon/engine/history/auto_checkpoint.py (AutoCheckpointer class)"
        - "tests/unit/engine/history/ (123 tests)"
      tests_passing: 453
      notes: "Undo/redo, save/load, auto-checkpointing. Branching deferred."

    sprint_9:
      name: "Component System (Material Ontology)"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/models/components/base.py (Component protocol)"
        - "src/babylon/models/components/material.py (MaterialComponent)"
        - "src/babylon/models/components/vitality.py (VitalityComponent)"
        - "src/babylon/models/components/spatial.py (SpatialComponent)"
        - "src/babylon/models/components/ideological.py (IdeologicalComponent)"
        - "src/babylon/models/components/organization.py (OrganizationComponent)"
        - "tests/unit/models/components/ (129 tests)"
      tests_passing: 582
      notes: "Frozen Pydantic models with constrained types"

    sprint_10:
      name: "ServiceContainer & Dependency Injection"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/services.py (ServiceContainer)"
        - "src/babylon/engine/event_bus.py (EventBus)"
        - "src/babylon/engine/formula_registry.py (FormulaRegistry)"
        - "src/babylon/engine/database.py (DatabaseConnection)"
        - "tests/unit/engine/test_services.py"
        - "tests/unit/engine/test_event_bus.py (20 tests)"
        - "tests/unit/engine/test_formula_registry.py (14 tests)"
      tests_passing: 630
      notes: "Clean dependency injection for testability"

    sprint_11:
      name: "System Protocol & Implementations"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/systems/protocol.py (System protocol)"
        - "src/babylon/engine/systems/economic.py (ImperialRentSystem)"
        - "src/babylon/engine/systems/ideology.py (ConsciousnessSystem)"
        - "src/babylon/engine/systems/survival.py (SurvivalSystem)"
        - "src/babylon/engine/systems/contradiction.py (ContradictionSystem)"
      tests_passing: 647
      notes: "Modular systems with shared ServiceContainer"

    sprint_12:
      name: "Simulation Facade & Entity Factories"
      status: "COMPLETE"
      deliverables:
        - "src/babylon/engine/simulation.py (Simulation class)"
        - "src/babylon/engine/factories.py (create_proletariat, create_bourgeoisie)"
        - "src/babylon/engine/history_formatter.py (format_class_struggle_history)"
        - "tests/unit/engine/test_simulation_facade.py (19 tests)"
        - "tests/unit/engine/test_factories.py (30 tests)"
        - "tests/integration/test_class_struggle.py (8 tests)"
      tests_passing: 704
      notes: "Integration proof: 100-tick wealth transfer verified"

  phase_roadmap:
    phase_1: "Minimum Viable Dialectic - prove the equations"
    phase_2: "Topological Engine - the physics/update loop"
    phase_3: "Observer Pattern - AI narrates, never controls"
    phase_4: "Control Room - NiceGUI dashboard"

  next_steps:
    - "PHASE 2 COMPLETE - 704 tests passing, modular System architecture proven"
    - "Phase 3: Observer Protocol - interface for LLM to observe state"
    - "Phase 3: Context Builder - token-aware state serialization"
    - "Phase 3: LLM Abstraction - Ollama/Claude provider"
    - "Phase 3: More Event Types - wealth_transfer, ideology_drift, tension_change"
    - "Phase 3: AI Observer - LLM narrates events (read-only access)"
    - "Phase 4: NiceGUI Control Room - dashboard for simulation"
    - "Optional: Timeline branching for history stack"
    - "Optional: Additional entity types and relationship types"

  mantra: "Graph + Math = History"
  old_mantra: "State is data. Engine is logic. They never mix."
  milestone: "PHASE 2 ACHIEVED: 704 tests passing, modular System architecture"
  next_milestone: "PHASE 3: AI Observer generates narrative from state changes"
  philosophical_grounding: |
    "The Economy is not a class; it is the sum of all EXTRACTS_FROM edges."
    Architecture encodes theory. The code IS the analysis.

# =============================================================================
# IDEA QUARANTINE PROTOCOL
# =============================================================================

quarantine:
  location: "~/projects/game/notes/"
  purpose: "Dump ideas without derailing implementation"
  rule: "If it's not in next_steps, it goes in notes/ or brainstorm/deferred-ideas.md"
  deferred_parking: "brainstorm/deferred-ideas.md"

# =============================================================================
# TECH DEBT
# =============================================================================

tech_debt:

  legacy_xml:
    location: "src/babylon/data/xml/"
    status: "Migrated, kept for reference"
    action: "Can delete after confidence in JSON"
    priority: "low"

  legacy_economy_politics:
    status: "RESOLVED"
    action: "Deleted in Sprint 7 per ADR011"
    notes: "Pure Graph Architecture - no institutional classes"

  incomplete_models:
    issue: "Not all entities have Pydantic models"
    action: "Generate from JSON schemas as needed"
    priority: "low - current models sufficient for Phase 2-3"

  test_coverage:
    status: "EXCELLENT"
    current: "704 tests passing"
    coverage: "Core engine + systems + persistence + components fully tested, TDD discipline maintained"
    action: "Continue TDD for new features"

  documentation_drift:
    issue: "README.md still references PostgreSQL, old structure"
    action: "Update when Phase 3 complete"
    priority: "low - ai-docs/ is source of truth"

  legacy_contradiction_analysis:
    location: "src/babylon/systems/contradiction_analysis.py"
    status: "Partially superseded"
    notes: "Tension now tracked on Relationship edges, but legacy class still used in __main__.py"
    action: "Evaluate during Phase 3"
