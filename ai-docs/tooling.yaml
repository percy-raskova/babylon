# Babylon Tooling Configuration
# How tools are configured and why

meta:
  version: "1.0.1"
  updated: "2025-12-12"
  purpose: "Document tooling decisions to avoid re-investigation"

# =============================================================================
# CI/CD TOOLING
# =============================================================================

cicd:
  philosophy: "Block on correctness, not style"
  governance: "Benevolent Dictator model - see ci-workflow.yaml for full details"

  github_actions:
    ci_yml:
      file: ".github/workflows/ci.yml"
      triggers:
        push: ["main", "dev"]
        pull_request: ["main", "dev"]
      jobs:
        ci:
          name: "Lint, Type Check & Test"
          blocks_merge: true
          steps:
            - "poetry run ruff check ."
            - "poetry run mypy src"
            - "poetry run pytest -m 'not ai' --tb=short -q"
        docs:
          name: "Documentation Build"
          blocks_merge: true
          steps:
            - "poetry run pytest --doctest-modules src/babylon/systems/formulas.py -v"
            - "cd docs && poetry run sphinx-build -b html . _build/html"
          note: "No -W flag - warnings allowed in CI, strict mode available locally"
        style:
          name: "Style Check (Informational)"
          blocks_merge: false
          continue_on_error: true
          steps:
            - "poetry run ruff format --check ."

    extended_analysis_yml:
      file: ".github/workflows/extended-analysis.yml"
      triggers:
        - "release (published)"
        - "schedule (weekly Sunday midnight)"
        - "workflow_dispatch (manual)"
      jobs:
        extended_tests:
          matrix: ["3.12", "3.13"]
          purpose: "Python version compatibility"
        parameter_analysis:
          commands:
            - "mise run analyze-trace"
            - "mise run analyze-sweep"
          artifacts: "results/"
        ai_evaluation:
          condition: "release only"
          command: "poetry run pytest -m 'ai' --tb=short -q"

  pr_template:
    file: ".github/PULL_REQUEST_TEMPLATE.md"
    tone: "Beginner-friendly, welcoming"
    key_message: "Checklist is a guide, not a gate"

  pre_commit:
    file: ".pre-commit-config.yaml"
    purpose: "Local style enforcement (not CI)"
    hooks:
      - "ruff (lint)"
      - "ruff (format)"
      - "mypy (typecheck)"
      - "pytest (fast tests)"
      - "yamllint"
      - "commitizen (commit message)"

# =============================================================================
# DOCUMENTATION TOOLING
# =============================================================================

documentation:

  sphinx:
    config_file: "docs/conf.py"
    key_settings:
      autosummary_imported_members: false
      reason: "Prevents duplicate documentation of re-exported classes"

      html_static_path: "[]"
      reason: "No custom static files, avoids missing directory warning"

      autodoc_default_options:
        members: true
        undoc_members: true
        show_inheritance: true

    extensions:
      - "sphinx.ext.autodoc"
      - "sphinx.ext.autosummary"
      - "sphinx.ext.viewcode"
      - "sphinx.ext.intersphinx"
      - "sphinx.ext.doctest"
      - "sphinx.ext.todo"
      - "sphinx.ext.coverage"
      - "sphinx_autodoc_typehints"
      - "myst_parser"
      - "sphinxcontrib.mermaid"  # Diagram support for flowcharts

    ci_flags:
      b_html: "HTML builder"
      note: "-W (warnings as errors) removed from CI, available via mise run docs-strict"

    suppress_warnings:
      config_location: "docs/conf.py"
      suppressed:
        - "autodoc"
        - "autodoc.import_object"
        - "ref.python"
        - "ref.ref"
        - "myst.xref_missing"
        - "docutils"
      reason: "Pydantic model re-exports cause unavoidable duplicate object warnings"

  docstring_format:
    style: "RST (reStructuredText)"
    reason: "Sphinx autodoc native format"
    rules:
      - "Use :: for code blocks, not markdown ```"
      - "Use *italic* and **bold** with proper spacing"
      - "Use :class:`ClassName` for cross-references"
      - "Blank line before and after code blocks"
      - "Examples should pass doctest"

    examples:
      good: |
        """Calculate imperial rent.

        The formula applies Marxist value theory to compute
        the surplus extracted via unequal exchange.

        Args:
            wages: Currency amount paid to workers
            value: Currency amount of value produced

        Returns:
            Imperial rent (Phi) extracted

        Example:
            >>> calculate_imperial_rent(wages=100.0, value=80.0)
            20.0

        See Also:
            :func:`calculate_exploitation_rate`
        """
      bad: |
        """
        Calculate imperial rent.
        Uses `code` markdown style - WRONG for RST
        Returns the **bold without spaces**error
        """

# =============================================================================
# LINTING TOOLING
# =============================================================================

linting:

  ruff:
    config_file: "pyproject.toml"
    version: "^0.14.0"
    important: "Must match pre-commit version exactly"
    settings:
      line_length: 100
      target_version: "py312"
      select:
        - "E"   # pycodestyle errors
        - "W"   # pycodestyle warnings
        - "F"   # pyflakes
        - "I"   # isort
        - "B"   # bugbear
        - "C4"  # comprehensions
        - "UP"  # pyupgrade
        - "ARG" # unused arguments
        - "SIM" # simplify
      ignore:
        - "E501"  # line length (handled by formatter)

  mypy:
    config_file: "pyproject.toml"
    mode: "strict"
    settings:
      python_version: "3.12"
      strict: true
      disallow_untyped_defs: true
      warn_return_any: true
      show_error_codes: true
      exclude: ["tests/", "build/", "dist/", "assets/music/"]

  yamllint:
    config_file: ".yamllint.yaml"
    settings:
      line_length: 120
      indentation: 2
      truthy_allowed: ["true", "false", "on", "off", "yes", "no"]
    ignore:
      - ".venv/"
      - ".git/"
      - "node_modules/"
      - "brainstorm/"
      - "docs/character_sheets/"
      - "ai-docs/"
    reason_for_ai_docs_ignore: "Prose with long lines, not infrastructure config"

# =============================================================================
# PYTHON TOOLING
# =============================================================================

python:

  poetry:
    config_file: "pyproject.toml"
    version: "1.8.4"
    dependency_groups:
      main: "Core runtime dependencies"
      dev: "Testing, linting, type checking"
      docs: "Sphinx and documentation tools"

  pytest:
    config_file: "pyproject.toml"
    markers:
      unit: "Fast unit tests for isolated components"
      math: "Deterministic mathematical formulas"
      ledger: "Economic/Political state tests"
      topology: "Graph/Network operations"
      integration: "Database/ChromaDB tests"
      ai: "AI/RAG evaluation tests (slow, non-deterministic)"
    asyncio_mode: "strict"

  mise:
    config_file: "mise.toml"
    purpose: "Task runner"
    key_tasks:
      ci: "Quick CI: lint + format + typecheck + test-fast"
      test: "Run all non-AI tests"
      test_fast: "Fast math/engine tests only"
      typecheck: "MyPy strict mode"
      docs_live: "Live-reload documentation server"
      analyze_trace: "Single sim with full time-series CSV"
      analyze_sweep: "Parameter sweep with summary metrics"

# =============================================================================
# TESTING INFRASTRUCTURE
# =============================================================================

testing_infrastructure:
  description: "Consolidated testing tools from Operation Clean Slate refactor (Phase 2.5)"
  added: "2025-12-12"

  domain_factory:
    location: "tests/factories/domain.py"
    status: ACTIVE
    test_count: 31
    purpose: "Single source of truth for creating test entities"
    key_methods:
      - "create_worker(): SocialClass with periphery proletariat defaults"
      - "create_owner(): SocialClass with core bourgeoisie defaults"
      - "create_relationship(): Relationship edge with exploitation defaults"
      - "create_world_state(): Complete WorldState for simulation tests"
    usage: |
      from tests.factories import DomainFactory
      factory = DomainFactory()
      worker = factory.create_worker(wealth=100.0)  # Override only what matters
      state = factory.create_world_state(entities={"C001": worker})
    replaces: "Manual dictionary creation, scattered fixture definitions"

  babylon_assert:
    location: "tests/assertions.py"
    status: ACTIVE
    test_count: 55
    purpose: "Fluent assertion library for domain-expressive test verification"
    key_classes:
      - "Assert: Entry point for WorldState assertions"
      - "EntityAssert: SocialClass assertions (wealth, ideology, survival)"
      - "RelationshipAssert: Relationship assertions (tension, value_flow)"
    usage: |
      from tests.assertions import Assert
      Assert(new_state).entity("C001").is_poorer_than(previous_state)
      Assert(state).relationship("C001", "C002").has_tension_increased(previous_state)
    replaces: "Raw assert statements with manual calculations"

  mock_metrics_collector:
    location: "tests/mocks/metrics_collector.py"
    status: ACTIVE
    test_count: 8
    purpose: "Pure spy pattern for metrics recording (no calculations)"
    pattern: "Dumb Spy - records calls without computing statistics"
    key_methods:
      - "record_cache_event(level, hit): Track cache hits/misses"
      - "record_metric(name, value, context): Generic metric recording"
      - "get_recorded_data(): Return raw recorded values"
      - "get_protocol_calls(): List all protocol method calls"
      - "clear(): Reset all metrics"
    usage: |
      from tests.mocks import MockMetricsCollector
      collector = MockMetricsCollector()
      collector.record_cache_event("L1", hit=True)
      data = collector.get_recorded_data()
      assert data["cache_hits"]["L1"] == 1
    note: "Self-contained tests embedded in module (lines 328-456)"

  metrics_collector_protocol:
    location: "src/babylon/metrics/interfaces.py"
    status: ACTIVE
    purpose: "Protocol interface ensuring mocks and real collectors share identical API"
    key_methods:
      - "record(name, value, tags, metadata): Record metric value"
      - "increment(name, value): Increment counter"
      - "gauge(name, value): Set gauge value"
      - "time(name) -> ContextManager: Time operations"
      - "summary() -> dict: Get aggregated metrics"
      - "clear(): Reset all metrics"

# =============================================================================
# KNOWN ISSUES AND WORKAROUNDS
# =============================================================================

known_issues:

  sphinx_duplicate_warnings:
    problem: "Classes re-exported in __init__.py documented twice"
    solution: "autosummary_imported_members = False"
    reference: "ADR022_sphinx_autosummary_config"

  ruff_version_mismatch:
    problem: "Different ruff versions in Poetry vs pre-commit cause format differences"
    solution: "Always keep versions in sync: pyproject.toml and .pre-commit-config.yaml"
    ci_impact: "Style job fails if versions drift"

  yamllint_prose:
    problem: "Prose files in ai-docs/ exceed line length limits"
    solution: "Add ai-docs/ to yamllint ignore in .yamllint.yaml"
    rationale: "Prose is not infrastructure config, line limits don't apply"

  python_313_test_flakiness:
    problem: "Some tests fail on Python 3.13 due to timing differences"
    example: "timestamp collision in checkpoint tests"
    solution: "Add time.sleep(0.01) between time-sensitive operations"
    note: "Python 3.13 tests run in extended-analysis, not main CI"
