# Topology System Specification
# Machine-readable reference for percolation theory implementation
#
# This document specifies the graph structure, metrics, and formulas
# used to model revolutionary organization via percolation theory.

meta:
  version: "1.2.0"
  updated: "2025-12-12"
  status: "IMPLEMENTED"
  tests: 85  # 34 unit + 21 integration + 30 phase transition (Sprint 3.3: 4-phase model)

overview:
  purpose: |
    Model revolutionary organization as a percolation problem on solidarity graphs.
    Detect phase transitions from atomized (gaseous) to organized (liquid) states.
    Track network resilience to targeted repression (purge simulation).

  core_insight: |
    Revolution requires not just radicalized workers, but radicalized workers
    who can coordinate. The graph structure determines which equilibrium
    (revolution vs fascism) the system reaches during crisis.

# =============================================================================
# GRAPH STRUCTURE
# =============================================================================

graph_structure:
  type: "NetworkX DiGraph"

  node_types:
    social_class:
      marker: "_node_type: social_class"
      model: "babylon.models.entities.SocialClass"
      key_attributes:
        - "id: str (pattern C[0-9]{3})"
        - "role: SocialRole enum"
        - "wealth: Currency [0, ∞)"
        - "ideology: IdeologicalProfile"
        - "organization: Probability [0, 1]"
        - "repression_faced: Probability [0, 1]"

    territory:
      marker: "_node_type: territory"
      model: "babylon.models.entities.Territory"
      note: "Excluded from percolation analysis"

  edge_types:
    SOLIDARITY:
      direction: "Periphery → Core"
      weight: "solidarity_strength: Coefficient [0, 1]"
      purpose: "Consciousness transmission infrastructure"

    EXPLOITATION:
      direction: "Worker → Owner"
      weight: "value_flow: Currency"
      purpose: "Imperial rent extraction"

    WAGES:
      direction: "Bourgeoisie → Worker"
      weight: "value_flow: Currency"
      purpose: "Super-wage payments from imperial rent"

    REPRESSION:
      direction: "State → Class"
      weight: "tension: Intensity [0, 1]"
      purpose: "State violence accumulation"

    TRIBUTE:
      direction: "Comprador → Core Bourgeoisie"
      weight: "value_flow: Currency"
      purpose: "Periphery → Core via intermediary"

    CLIENT_STATE:
      direction: "Core → Peripheral State"
      weight: "value_flow: Currency, subsidy_cap: Currency"
      purpose: "Imperial subsidy for stability"

    COMPETITION:
      direction: "Bidirectional"
      weight: "tension: Intensity"
      purpose: "Market rivalry"

    TENANCY:
      direction: "SocialClass → Territory"
      purpose: "Occupancy relationship"

    ADJACENCY:
      direction: "Territory ↔ Territory"
      purpose: "Spatial connectivity"

  solidarity_subgraph:
    description: |
      For percolation analysis, extract undirected graph containing only:
      - social_class nodes (territories excluded)
      - SOLIDARITY edges above strength threshold
    function: "extract_solidarity_subgraph(G, min_strength)"
    returns: "nx.Graph[str] (undirected)"

# =============================================================================
# PERCOLATION METRICS
# =============================================================================

metrics:
  percolation_ratio:
    symbol: "p"
    formula: "L_max / N"
    range: "[0, 1]"
    description: "Fraction of network in giant component"
    interpretation:
      - "p < 0.1: Gaseous (atomized)"
      - "p >= 0.5: Liquid (condensed, vanguard formed)"

  num_components:
    description: "Number of disconnected subgraphs (solidarity cells)"
    interpretation: "Higher = more atomized"

  max_component_size:
    symbol: "L_max"
    description: "Size of largest connected component"
    interpretation: "The 'giant component' in percolation theory"

  potential_liquidity:
    threshold: 0.1
    description: "Count of SOLIDARITY edges with strength > 0.1"
    interpretation: "Sympathizer network (broad reach)"

  actual_liquidity:
    threshold: 0.5
    description: "Count of SOLIDARITY edges with strength > 0.5"
    interpretation: "Cadre network (committed activists)"

  cadre_density:
    formula: "actual_liquidity / max(1, potential_liquidity)"
    range: "[0, 1]"
    description: "Ratio of committed cadre to sympathizer network"
    interpretation:
      - "< 0.5: Mass movement with weak ties (liquid)"
      - ">= 0.5: Vanguard party with strong cadre discipline (solid)"
    note: "Distinguishes between broad movements and disciplined parties"

  brittleness:
    condition: "potential > actual * 2"
    description: "Movement is broad but lacks disciplined core"

# =============================================================================
# THRESHOLDS & CONSTANTS
# =============================================================================

thresholds:
  # Phase detection
  GASEOUS_THRESHOLD:
    value: 0.1
    file: "topology_monitor.py:48"
    description: "percolation_ratio below this = atomized movement"

  CONDENSATION_THRESHOLD:
    value: 0.5
    file: "topology_monitor.py:49"
    description: "percolation_ratio crossing this = phase shift detected"

  BRITTLE_MULTIPLIER:
    value: 2
    file: "topology_monitor.py:50"
    description: "potential > actual * this = brittle warning"

  # Liquidity classification
  POTENTIAL_MIN_STRENGTH:
    value: 0.1
    file: "topology_monitor.py:53"
    description: "Minimum solidarity_strength for sympathizer"

  ACTUAL_MIN_STRENGTH:
    value: 0.5
    file: "topology_monitor.py:54"
    description: "Minimum solidarity_strength for cadre"

  CADRE_DENSITY_THRESHOLD:
    value: 0.5
    file: "topology_monitor.py:_classify_phase"
    description: "Above this cadre_density, movement is 'solid' (disciplined vanguard)"

  # Resilience testing
  DEFAULT_REMOVAL_RATE:
    value: 0.2
    file: "topology_monitor.py:57"
    description: "Fraction of nodes removed in purge simulation"

  DEFAULT_SURVIVAL_THRESHOLD:
    value: 0.4
    file: "topology_monitor.py:58"
    description: "Required fraction of L_max to survive purge"

  # Consciousness dynamics
  LOSS_AVERSION_COEFFICIENT:
    value: 2.25
    file: "formulas.py:27"
    description: "Kahneman-Tversky loss aversion (kappa)"

  ACTIVATION_THRESHOLD:
    value: 0.3
    file: "GameDefines.solidarity.activation_threshold"
    description: "Minimum source consciousness for transmission"

# =============================================================================
# FORMULAS
# =============================================================================

formulas:
  consciousness_drift:
    location: "formulas.py:134-199"
    signature: |
      calculate_consciousness_drift(
        core_wages, value_produced, current_consciousness,
        sensitivity_k, decay_lambda, solidarity_pressure, wage_change
      ) -> float
    formula: "dΨ/dt = k(1 - W/V) - λΨ + B(ẇ, σ)"
    components:
      material_term: "k(1 - W/V)"
      decay_term: "λΨ"
      bifurcation_term: "B(ẇ, σ)"
    bifurcation_logic: |
      if wage_change < 0:
        agitation_energy = |wage_change| * 2.25
        if solidarity_pressure > 0:
          return +agitation_energy * min(1, solidarity_pressure)  # Revolution
        else:
          return -agitation_energy  # Fascism

  solidarity_transmission:
    location: "formulas.py:455-511"
    signature: |
      calculate_solidarity_transmission(
        source_consciousness, target_consciousness,
        solidarity_strength, activation_threshold
      ) -> float
    formula: "Δ = σ(Ψ_source - Ψ_target)"
    conditions:
      - "source_consciousness > activation_threshold (strictly >)"
      - "solidarity_strength > 0"
    note: "Transmission blocked if either condition fails (Fascist Bifurcation)"

  ideological_routing:
    location: "formulas.py:518-601"
    signature: |
      calculate_ideological_routing(
        wage_change, solidarity_pressure,
        current_class_consciousness, current_national_identity,
        current_agitation, agitation_decay
      ) -> tuple[float, float, float]
    returns: "(new_class_consciousness, new_national_identity, new_agitation)"
    routing_logic: |
      agitation_energy routes based on solidarity_factor:
      - High solidarity → class_consciousness increases
      - Low solidarity → national_identity increases (fascism)

# =============================================================================
# DATA MODELS
# =============================================================================

models:
  TopologySnapshot:
    location: "models/topology_metrics.py:23-67"
    type: "Pydantic BaseModel (frozen)"
    fields:
      tick: "int"
      num_components: "int"
      max_component_size: "int"
      total_nodes: "int"
      percolation_ratio: "Probability [0, 1]"
      potential_liquidity: "int"
      actual_liquidity: "int"
      cadre_density: "float [0, 1] (Sprint 3.3)"
      is_resilient: "bool | None"

  ResilienceResult:
    location: "models/topology_metrics.py:62-92"
    type: "Pydantic BaseModel (frozen)"
    fields:
      is_resilient: "bool"
      original_max_component: "int"
      post_purge_max_component: "int"
      removal_rate: "float"
      survival_threshold: "float"
      seed: "int | None"

  TopologyEvent:
    location: "models/events.py"
    type: "Pydantic BaseModel (frozen)"
    parent: "SimulationEvent"
    status: "IMPLEMENTED (Sprint 3.3)"
    fields:
      percolation_ratio: "Probability [0, 1]"
      num_components: "int"
    description: |
      Base class for topology-related events. Contains percolation metrics
      common to all topology events.

  PhaseTransitionEvent:
    location: "models/events.py"
    type: "Pydantic BaseModel (frozen)"
    parent: "TopologyEvent"
    status: "IMPLEMENTED (Sprint 3.3 - 4-phase model)"
    fields:
      event_type: "EventType.PHASE_TRANSITION"
      previous_state: "str (gaseous|transitional|liquid|solid)"
      new_state: "str (gaseous|transitional|liquid|solid)"
      largest_component_size: "int"
      cadre_density: "float [0, 1] (Sprint 3.3)"
      is_resilient: "bool | None"
    description: |
      Emitted when percolation_ratio or cadre_density crosses phase threshold boundaries.
      Represents the crystallization of atomized leftism into organized revolutionary
      force (liquid = mass movement, solid = vanguard party).

# =============================================================================
# PHASE STATES
# =============================================================================

phase_states:
  gaseous:
    threshold: "percolation_ratio < 0.1"
    description: "Atomized movement. No coordination capacity."
    political_meaning: |
      Individual cells operate in isolation. No giant component.
      State can eliminate nodes without cascade effects.
      Consciousness transmission blocked.

  transitional:
    threshold: "0.1 <= percolation_ratio < 0.5"
    description: "Emerging structure. Unstable coordination."
    political_meaning: |
      Some clusters forming but not yet a vanguard.
      Vulnerable to targeted disruption.
      Consciousness can propagate within clusters.

  liquid:
    threshold: "percolation_ratio >= 0.5 AND cadre_density < 0.5"
    description: "Mass movement formed. Broad but loosely organized."
    political_meaning: |
      Giant component exists (coordination possible).
      Movement of movements - many sympathizers, few committed cadre.
      Vulnerable to ideological drift and internal division.
      Historical example: Occupy Wall Street (2011).

  solid:
    threshold: "percolation_ratio >= 0.5 AND cadre_density >= 0.5"
    description: "Vanguard party crystallized. Disciplined cadre core."
    political_meaning: |
      Giant component AND strong ties throughout.
      Iron discipline - committed activists dominate network.
      Can survive repression and maintain ideological coherence.
      Historical example: Bolshevik Party (1917).

  classification_function:
    location: "engine/topology_monitor.py:_classify_phase()"
    signature: "_classify_phase(percolation_ratio: float, cadre_density: float = 0.0) -> str"
    returns: "'gaseous' | 'transitional' | 'liquid' | 'solid'"
    logic: |
      if percolation_ratio < GASEOUS_THRESHOLD:
          return "gaseous"
      if percolation_ratio < CONDENSATION_THRESHOLD:
          return "transitional"
      if cadre_density >= 0.5:
          return "solid"
      return "liquid"

# =============================================================================
# OBSERVER PATTERN
# =============================================================================

observer:
  class: "TopologyMonitor"
  location: "engine/topology_monitor.py:243-452"
  protocol: "SimulationObserver"
  status: "COMPLETE (Sprint 3.3)"

  lifecycle_hooks:
    on_simulation_start: "Initialize history, record initial snapshot, reset phase state"
    on_tick: "Record snapshot, detect phase transitions, emit PhaseTransitionEvent"
    on_simulation_end: "Log summary statistics"

  event_emission:
    status: "IMPLEMENTED (Sprint 3.3)"
    mechanism: |
      TopologyMonitor tracks _previous_phase and _pending_events internally.
      When percolation_ratio crosses a threshold boundary, a PhaseTransitionEvent
      is appended to _pending_events. The Simulation facade calls
      get_pending_events() after each tick, collecting events and injecting
      them into the next tick's WorldState via persistent_context['_observer_events'].
    methods:
      _classify_phase: "Determine current phase state from percolation_ratio"
      get_pending_events: "Return and clear pending events list"
    injection_point: "simulation_engine.py: step() reads persistent_context['_observer_events']"

  configuration:
    resilience_test_interval:
      type: "int"
      default: 5
      description: "Run resilience test every N ticks (0 = disabled)"
    resilience_removal_rate:
      type: "float"
      default: 0.2
      description: "Fraction of nodes to remove in test"

  narrative_states:
    gaseous:
      condition: "percolation_ratio < 0.1"
      message: "STATE: Gaseous. Movement is atomized."
    condensation_liquid:
      condition: "percolation_ratio crosses 0.5 AND cadre_density < 0.5"
      message: "PHASE SHIFT: Liquid state. Mass movement formed but lacks cadre discipline."
    condensation_solid:
      condition: "percolation_ratio >= 0.5 AND cadre_density >= 0.5"
      message: "PHASE SHIFT: Solid state. Vanguard Party has crystallized. Iron discipline achieved."
    liquid_to_solid:
      condition: "state transitions from liquid to solid (cadre_density crosses 0.5)"
      message: "CRYSTALLIZATION: Mass movement hardened into disciplined vanguard."
    brittle:
      condition: "potential > actual * 2"
      message: "WARNING: Movement is broad but brittle. Lacks cadre discipline."
    sword_of_damocles:
      condition: "is_resilient == False"
      message: "ALERT: Sword of Damocles active. A purge would destroy the movement."

# =============================================================================
# FILE REFERENCE
# =============================================================================

files:
  implementation:
    - path: "src/babylon/engine/topology_monitor.py"
      lines: 452
      purpose: "TopologyMonitor observer and helper functions"

    - path: "src/babylon/systems/formulas.py"
      lines: 707
      purpose: "Mathematical formulas (consciousness, bifurcation, survival)"

    - path: "src/babylon/models/topology_metrics.py"
      lines: 92
      purpose: "TopologySnapshot and ResilienceResult models"

    - path: "src/babylon/engine/systems/solidarity.py"
      lines: 199
      purpose: "SolidaritySystem consciousness transmission"

    - path: "src/babylon/models/world_state.py"
      lines: 283
      purpose: "WorldState.to_graph() and from_graph()"

  tests:
    - path: "tests/unit/topology/test_topology_monitor.py"
      tests: 34
      purpose: "Unit tests for percolation functions"

    - path: "tests/integration/test_topology_integration.py"
      tests: 21
      purpose: "Integration tests with Simulation lifecycle"

    - path: "tests/unit/topology/test_phase_transition.py"
      tests: 30
      purpose: "Phase transition event emission and injection (Sprint 3.3: 4-phase model)"

# =============================================================================
# COMMON QUERIES
# =============================================================================

common_queries:
  check_phase_state:
    pattern: |
      from babylon.engine.topology_monitor import TopologyMonitor
      monitor = TopologyMonitor()
      # After simulation runs...
      latest = monitor.history[-1]
      if latest.percolation_ratio < 0.1:
          print("Gaseous - Atomized")
      elif latest.percolation_ratio < 0.5:
          print("Transitional - Emerging")
      elif latest.cadre_density >= 0.5:
          print("Solid - Vanguard Party (iron discipline)")
      else:
          print("Liquid - Mass Movement (weak ties)")

  test_network_resilience:
    pattern: |
      from babylon.engine.topology_monitor import check_resilience
      graph = state.to_graph()
      result = check_resilience(graph, removal_rate=0.2, seed=42)
      if not result.is_resilient:
          print("Sword of Damocles: Network is fragile!")

  get_liquidity_metrics:
    pattern: |
      from babylon.engine.topology_monitor import calculate_liquidity
      graph = state.to_graph()
      potential, actual = calculate_liquidity(graph)
      if potential > actual * 2:
          print("Movement is broad but brittle")
